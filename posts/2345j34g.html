<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Rediså®æˆ˜ç¯‡ | adoreğŸŠ</title><meta name="keywords" content="Redis, ç¼“å­˜, NoSQL, å†…å­˜æ•°æ®åº“, é«˜æ€§èƒ½, åˆ†å¸ƒå¼é”, æ¶ˆæ¯é˜Ÿåˆ—"><meta name="author" content="adoreğŸŠ"><meta name="copyright" content="adoreğŸŠ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="è¯¦ç»†ä»‹ç»Redisçš„åŸºæœ¬æ¦‚å¿µã€å®‰è£…é…ç½®ã€æ•°æ®ç±»å‹ã€å¸¸ç”¨å‘½ä»¤ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡è¿™ä¸ªå¼ºå¤§çš„å†…å­˜æ•°æ®åº“ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Rediså®æˆ˜ç¯‡">
<meta property="og:url" content="https://blog.adoreorg.cn/posts/2345j34g.html">
<meta property="og:site_name" content="adoreğŸŠ">
<meta property="og:description" content="è¯¦ç»†ä»‹ç»Redisçš„åŸºæœ¬æ¦‚å¿µã€å®‰è£…é…ç½®ã€æ•°æ®ç±»å‹ã€å¸¸ç”¨å‘½ä»¤ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡è¿™ä¸ªå¼ºå¤§çš„å†…å­˜æ•°æ®åº“ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.adoreorg.cn/webp/select/58.webp">
<meta property="article:published_time" content="2025-08-19T06:30:00.000Z">
<meta property="article:modified_time" content="2025-08-19T06:30:00.000Z">
<meta property="article:author" content="adoreğŸŠ">
<meta property="article:tag" content="ç¼“å­˜">
<meta property="article:tag" content="é«˜æ€§èƒ½">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="NoSQL">
<meta property="article:tag" content="åˆ†å¸ƒå¼">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.adoreorg.cn/webp/select/58.webp"><link rel="shortcut icon" href="https://source.adoreorg.cn/webp/icon/favicon.png"><link rel="canonical" href="https://blog.adoreorg.cn/posts/2345j34g"><link rel="preconnect" href="//fastly.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script async defer src="https://um.adoreorg.cn/script.js" data-website-id="71460ec6-a625-4f87-ad62-bb662791e99b" data-host-url="https://um.adoreorg.cn"></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"QSJDS8JFVG","apiKey":"cf2323e36aab6142f188baf96a7ae82f","indexName":"hexo-blog","hits":{"per_page":5},"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2.1.2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Rediså®æˆ˜ç¯‡',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-19 14:30:00'
}
</script><script>window.UmamiConfig = {
  umami_api: 'https://umami-api.adoreorg5.workers.dev',
  umami_id: '71460ec6-a625-4f87-ad62-bb662791e99b',
  umami_url: 'https://um.adoreorg.cn'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="adoreğŸŠ" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/img/head.webp" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">66</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> å¯¼èˆª</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home">                   </use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> ç™¾å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> æ”¶è—</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æµå…‰æ‹¾é—</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”Ÿæ´»ç‚¹æ»´</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/secret/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youhua-fengshu">                   </use></svg><span class="menu_word" style="font-size:17px"> æµ®å…‰å°ç­‘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> è‡ªè¿°ä¸æˆ‘</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">adoreğŸŠ</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> å¯¼èˆª</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home">                   </use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> ç™¾å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> æ”¶è—</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æµå…‰æ‹¾é—</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”Ÿæ´»ç‚¹æ»´</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/secret/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youhua-fengshu">                   </use></svg><span class="menu_word" style="font-size:17px"> æµ®å…‰å°ç­‘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> è‡ªè¿°ä¸æˆ‘</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-search"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-meihua"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Rediså®æˆ˜ç¯‡</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2025-08-19T06:30:00.000Z" title="å‘è¡¨äº 2025-08-19 14:30:00">2025-08-19</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-08-19T06:30:00.000Z" title="æ›´æ–°äº 2025-08-19 14:30:00">2025-08-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E5%A2%A8%E9%A6%99%E5%AE%9E%E6%88%98/">å¢¨é¦™å®æˆ˜</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">4.1w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>159åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Rediså®æˆ˜ç¯‡"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="0-å®æˆ˜å¯¼è¯»">0. å®æˆ˜å¯¼è¯»</h2>
<blockquote>
<p>ğŸ¯ <strong>å­¦ä¹ ç›®æ ‡</strong><br>
æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»RedisåŸºç¡€æ¦‚å¿µåˆ°å®é™…é¡¹ç›®åº”ç”¨ï¼Œé€šè¿‡8ä¸ªå®æˆ˜æ¡ˆä¾‹æ·±å…¥ç†è§£Redisçš„å¼ºå¤§åŠŸèƒ½ã€‚</p>
</blockquote>
<div class="tabs" id="å®æˆ˜æ¡ˆä¾‹"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-1">çŸ­ä¿¡ç™»å½•</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-2">å•†æˆ·æŸ¥è¯¢ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-3">ä¼˜æƒ åˆ¸ç§’æ€</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-4">é™„è¿‘å•†æˆ·</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-5">UVç»Ÿè®¡</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-6">ç”¨æˆ·ç­¾åˆ°</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-7">å¥½å‹å…³æ³¨</button></li><li class="tab"><button type="button" data-href="#å®æˆ˜æ¡ˆä¾‹-8">æ¢åº—ç‚¹èµ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="å®æˆ˜æ¡ˆä¾‹-1"><p><strong>ğŸ“± çŸ­ä¿¡ç™»å½•</strong><br>
ä½¿ç”¨Rediså…±äº«Sessionå®ç°åˆ†å¸ƒå¼ç™»å½•ç³»ç»Ÿï¼Œè§£å†³ä¼ ç»ŸSessionè·¨åŸŸé—®é¢˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-2"><p><strong>ğŸ” å•†æˆ·æŸ¥è¯¢ç¼“å­˜</strong><br>
æ·±å…¥ç†è§£ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©é—®é¢˜ï¼ŒæŒæ¡ç¼“å­˜ç­–ç•¥å’Œè§£å†³æ–¹æ¡ˆ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-3"><p><strong>ğŸ« ä¼˜æƒ åˆ¸ç§’æ€</strong><br>
Redisè®¡æ•°å™¨ + Luaè„šæœ¬å®ç°é«˜æ€§èƒ½ç§’æ€ï¼Œåˆ†å¸ƒå¼é”é˜²æ­¢è¶…å–</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-4"><p><strong>ğŸ“ é™„è¿‘å•†æˆ·</strong><br>
åˆ©ç”¨Redis GEOHashå®ç°åœ°ç†ä½ç½®æŸ¥è¯¢ï¼Œæ”¯æŒé™„è¿‘å•†å®¶æœç´¢</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-5"><p><strong>ğŸ“Š UVç»Ÿè®¡</strong><br>
ä½¿ç”¨HyperLogLogè¿›è¡Œæµ·é‡æ•°æ®å»é‡ç»Ÿè®¡ï¼Œå†…å­˜å ç”¨æä½</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-6"><p><strong>âœ… ç”¨æˆ·ç­¾åˆ°</strong><br>
BitMapå®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-7"><p><strong>ğŸ‘¥ å¥½å‹å…³æ³¨</strong><br>
åŸºäºSeté›†åˆå®ç°å…³æ³¨ã€å–æ¶ˆå…³æ³¨ã€å…±åŒå…³æ³¨ç­‰ç¤¾äº¤åŠŸèƒ½</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="å®æˆ˜æ¡ˆä¾‹-8"><p><strong>ğŸ‘ æ¢åº—ç‚¹èµ</strong><br>
Listå®ç°ç‚¹èµåˆ—è¡¨ï¼ŒSortedSetå®ç°ç‚¹èµæ’è¡Œæ¦œ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653056228879.png" alt="1653056228879"></p>
<h2 id="1-çŸ­ä¿¡ç™»å½•">1. çŸ­ä¿¡ç™»å½•</h2>
<h3 id="1-1ã€é¡¹ç›®æ¶æ„åˆ†æ">1.1ã€é¡¹ç›®æ¶æ„åˆ†æ</h3>
<h4 id="1-1-1-ç³»ç»Ÿæ¶æ„å›¾">1.1.1 ç³»ç»Ÿæ¶æ„å›¾</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653057872536.png" alt="ç³»ç»Ÿæ¶æ„å›¾"></p>
<h4 id="1-1-2-æ¶æ„è®¾è®¡è§£æ">1.1.2 æ¶æ„è®¾è®¡è§£æ</h4>
<div class="note info flat"><p><strong>æŠ€æœ¯æ ˆ</strong></p>
<ul>
<li>è´Ÿè½½å‡è¡¡ï¼šNginx</li>
<li>åº”ç”¨æœåŠ¡ï¼šTomcaté›†ç¾¤</li>
<li>æ•°æ®å­˜å‚¨ï¼šMySQL + Redis</li>
<li>ç¼“å­˜ç­–ç•¥ï¼šå¤šçº§ç¼“å­˜æ¶æ„</li>
</ul>
</div>
<p><strong>è¯·æ±‚æµç¨‹åˆ†æï¼š</strong></p>
<ol>
<li>
<p><strong>å®¢æˆ·ç«¯è¯·æ±‚</strong> â†’ <strong>Nginxè´Ÿè½½å‡è¡¡</strong></p>
<ul>
<li>NginxåŸºäºä¸ƒå±‚æ¨¡å‹å¤„ç†HTTPåè®®</li>
<li>æ”¯æŒLuaè„šæœ¬ç›´æ¥è®¿é—®Redis</li>
<li>é™æ€èµ„æºæœåŠ¡ï¼Œè½»æ¾æ‰›ä¸‹ä¸Šä¸‡å¹¶å‘</li>
</ul>
</li>
<li>
<p><strong>è´Ÿè½½å‡è¡¡</strong> â†’ <strong>Tomcaté›†ç¾¤</strong></p>
<ul>
<li>4æ ¸8G Tomcatçº¦å¤„ç†1000å¹¶å‘</li>
<li>Nginxè´Ÿè½½å‡è¡¡åˆ†æµï¼Œé›†ç¾¤æ”¯æ’‘é«˜å¹¶å‘</li>
<li>åŠ¨é™åˆ†ç¦»é™ä½Tomcatå‹åŠ›</li>
</ul>
</li>
<li>
<p><strong>æ•°æ®è®¿é—®å±‚</strong></p>
<ul>
<li>MySQLä¼ä¸šçº§ï¼š16-32æ ¸CPUï¼Œ32-64Gå†…å­˜</li>
<li>å¹¶å‘èƒ½åŠ›ï¼š4000-7000 QPS</li>
<li>Redisé›†ç¾¤ç¼“å­˜ï¼Œé™ä½æ•°æ®åº“å‹åŠ›</li>
</ul>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653059409865.png" alt="æ¶æ„è¯¦è§£"></p>
<h4 id="1-1-3-é¡¹ç›®å¯¼å…¥æ­¥éª¤">1.1.3 é¡¹ç›®å¯¼å…¥æ­¥éª¤</h4>
<div class="tabs" id="redis"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redis-1">åç«¯é¡¹ç›®</button></li><li class="tab"><button type="button" data-href="#redis-2">å‰ç«¯é¡¹ç›®</button></li><li class="tab"><button type="button" data-href="#redis-3">è¿è¡Œé¡¹ç›®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redis-1"><p><strong>ğŸ–¥ï¸ åç«¯é¡¹ç›®å¯¼å…¥</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653060237073.png" alt="åç«¯é¡¹ç›®"></p>
<ol>
<li>è§£å‹åç«¯é¡¹ç›®æºç </li>
<li>é…ç½®æ•°æ®åº“è¿æ¥</li>
<li>å¯¼å…¥SQLè„šæœ¬</li>
<li>å¯åŠ¨é¡¹ç›®</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-2"><p><strong>ğŸŒ å‰ç«¯é¡¹ç›®å¯¼å…¥</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653060337562.png" alt="å‰ç«¯é¡¹ç›®"></p>
<ol>
<li>è§£å‹å‰ç«¯å·¥ç¨‹</li>
<li>å®‰è£…ä¾èµ–</li>
<li>é…ç½®APIæ¥å£åœ°å€</li>
<li>å¯åŠ¨å‰ç«¯æœåŠ¡</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-3"><p><strong>ğŸš€ é¡¹ç›®è¿è¡Œ</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653060588190.png" alt="è¿è¡Œé¡¹ç›®"></p>
<p>è®¿é—®åœ°å€ï¼š<code>http://localhost:8080</code></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="1-2-ç™»å½•æµç¨‹è®¾è®¡">1.2 ç™»å½•æµç¨‹è®¾è®¡</h3>
<h4 id="1-2-1-ç™»å½•æµç¨‹å›¾">1.2.1 ç™»å½•æµç¨‹å›¾</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653066208144.png" alt="ç™»å½•æµç¨‹"></p>
<h4 id="1-2-2-è¯¦ç»†æµç¨‹è§£æ">1.2.2 è¯¦ç»†æµç¨‹è§£æ</h4>
<div class="timeline "><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>å‘é€éªŒè¯ç </p>
</div></div><div class='timeline-item-content'><p><strong>ğŸ“¤ å‘é€éªŒè¯ç </strong></p>
<ol>
<li>
<p><strong>æ‰‹æœºå·æ ¡éªŒ</strong></p>
<ul>
<li>å‰ç«¯æäº¤æ‰‹æœºå·</li>
<li>åç«¯éªŒè¯æ‰‹æœºå·æ ¼å¼</li>
<li>æ ¼å¼é”™è¯¯ï¼šè¿”å›é”™è¯¯ä¿¡æ¯</li>
</ul>
</li>
<li>
<p><strong>éªŒè¯ç ç”Ÿæˆä¸å‘é€</strong></p>
<ul>
<li>ç”Ÿæˆ6ä½éšæœºéªŒè¯ç </li>
<li>ä¿å­˜éªŒè¯ç åˆ°Session</li>
<li>è°ƒç”¨çŸ­ä¿¡æœåŠ¡å‘é€éªŒè¯ç </li>
</ul>
</li>
</ol>
</div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>ç”¨æˆ·ç™»å½•</p>
</div></div><div class='timeline-item-content'><p><strong>ğŸ” ç”¨æˆ·ç™»å½•</strong></p>
<ol>
<li>
<p><strong>å‚æ•°æ ¡éªŒ</strong></p>
<ul>
<li>æ ¡éªŒæ‰‹æœºå·æ ¼å¼</li>
<li>æ ¡éªŒéªŒè¯ç æ­£ç¡®æ€§</li>
</ul>
</li>
<li>
<p><strong>ç”¨æˆ·å¤„ç†</strong></p>
<ul>
<li>æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</li>
<li>ç”¨æˆ·ä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·</li>
<li>ç”¨æˆ·å­˜åœ¨ï¼šæ›´æ–°ç™»å½•ä¿¡æ¯</li>
</ul>
</li>
<li>
<p><strong>Sessionç®¡ç†</strong></p>
<ul>
<li>ç”¨æˆ·ä¿¡æ¯å­˜å…¥Session</li>
<li>è¿”å›ç™»å½•æˆåŠŸæ ‡è¯†</li>
</ul>
</li>
</ol>
</div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>çŠ¶æ€æ ¡éªŒ</p>
</div></div><div class='timeline-item-content'><p><strong>âœ… çŠ¶æ€æ ¡éªŒ</strong></p>
<ol>
<li>
<p><strong>è¯·æ±‚æ‹¦æˆª</strong></p>
<ul>
<li>ä»Cookieè·å–JsessionId</li>
<li>æ ¹æ®SessionIdè·å–ç”¨æˆ·ä¿¡æ¯</li>
</ul>
</li>
<li>
<p><strong>æƒé™æ§åˆ¶</strong></p>
<ul>
<li>ç”¨æˆ·ä¸å­˜åœ¨ï¼šè¿”å›401æœªæˆæƒ</li>
<li>ç”¨æˆ·å­˜åœ¨ï¼šä¿¡æ¯å­˜å…¥ThreadLocal</li>
<li>è¯·æ±‚æ”¾è¡Œ</li>
</ul>
</li>
</ol>
</div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653066208144.png" alt="1653066208144"></p>
<h3 id="1-3-æ ¸å¿ƒä»£ç å®ç°">1.3 æ ¸å¿ƒä»£ç å®ç°</h3>
<h4 id="1-3-1-é¡µé¢äº¤äº’æµç¨‹">1.3.1 é¡µé¢äº¤äº’æµç¨‹</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653067054461.png" alt="é¡µé¢æµç¨‹"></p>
<h4 id="1-3-2-å‘é€éªŒè¯ç åŠŸèƒ½">1.3.2 å‘é€éªŒè¯ç åŠŸèƒ½</h4>
<div class="note success flat"><p><strong>åŠŸèƒ½è¯´æ˜</strong>ï¼šéªŒè¯æ‰‹æœºå·æ ¼å¼ï¼Œç”Ÿæˆ6ä½éšæœºéªŒè¯ç å¹¶ä¿å­˜åˆ°Session</p>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ ¡éªŒæ‰‹æœºå·æ ¼å¼</span></span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç”Ÿæˆ6ä½éšæœºéªŒè¯ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomUtil.randomNumbers(<span class="number">6</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ä¿å­˜éªŒè¯ç åˆ°Session</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. å‘é€éªŒè¯ç ï¼ˆå®é™…é¡¹ç›®ä¸­è°ƒç”¨çŸ­ä¿¡æœåŠ¡ï¼‰</span></span><br><span class="line">        log.debug(<span class="string">&quot;å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;</span>, code);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-3-3-ç”¨æˆ·ç™»å½•åŠŸèƒ½">1.3.3 ç”¨æˆ·ç™»å½•åŠŸèƒ½</h4>
<div class="note warning flat"><p><strong>å®‰å…¨æé†’</strong>ï¼šéªŒè¯ç æ ¡éªŒé€šè¿‡åï¼Œéœ€è¦æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·ï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°Session</p>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ ¡éªŒæ‰‹æœºå·æ ¼å¼</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">cacheCode</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">        <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !cacheCode.toString().equals(code)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            user = createUserWithPhone(phone);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Session</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> User <span class="title function_">createUserWithPhone</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setPhone(phone);</span><br><span class="line">        user.setNickName(<span class="string">&quot;user_&quot;</span> + RandomUtil.randomString(<span class="number">6</span>));</span><br><span class="line">        userService.save(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-ç™»å½•æ‹¦æˆªå™¨å®ç°">1.4 ç™»å½•æ‹¦æˆªå™¨å®ç°</h3>
<h4 id="1-4-1-Tomcatè¿è¡ŒåŸç†">1.4.1 Tomcatè¿è¡ŒåŸç†</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653068196656.png" alt="TomcatåŸç†"></p>
<div class="note info flat"><p><strong>Tomcatçº¿ç¨‹æ¨¡å‹è§£æ</strong></p>
<ol>
<li><strong>ç›‘å¬çº¿ç¨‹</strong>ï¼šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥</li>
<li><strong>Socketè¿æ¥</strong>ï¼šæ¯å¯¹è¯·æ±‚-å“åº”åˆ›å»ºç‹¬ç«‹Socket</li>
<li><strong>çº¿ç¨‹æ± </strong>ï¼šä»çº¿ç¨‹æ± è·å–çº¿ç¨‹å¤„ç†è¯·æ±‚</li>
<li><strong>è¯·æ±‚å¤„ç†</strong>ï¼šçº¿ç¨‹è½¬å‘åˆ°Controllerâ†’Serviceâ†’DAOâ†’DB</li>
<li><strong>å“åº”è¿”å›</strong>ï¼šå¤„ç†å®Œæˆåæ•°æ®å†™å›å®¢æˆ·ç«¯Socket</li>
</ol>
</div>
<h4 id="1-4-2-ThreadLocalçº¿ç¨‹éš”ç¦»">1.4.2 ThreadLocalçº¿ç¨‹éš”ç¦»</h4>
<div class="note warning flat"><p><strong>ThreadLocalä½¿ç”¨è¦ç‚¹</strong></p>
<p>æ¯ä¸ªç”¨æˆ·è¯·æ±‚å¯¹åº”Tomcatçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ThreadLocalå®ç°çº¿ç¨‹é—´çš„æ•°æ®éš”ç¦»ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹æ“ä½œè‡ªå·±çš„æ•°æ®å‰¯æœ¬ã€‚</p>
</div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653068874258.png" alt="ThreadLocalåŸç†"></p>
<h4 id="1-4-3-ç™»å½•æ‹¦æˆªå™¨ä»£ç ">1.4.3 ç™»å½•æ‹¦æˆªå™¨ä»£ç </h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–Session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. è·å–Sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 4. ç”¨æˆ·æœªç™»å½•ï¼Œè¿”å›401çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ç”¨æˆ·å·²ç™»å½•ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser((User) user);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. æ”¾è¡Œè¯·æ±‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-4-4-æ‹¦æˆªå™¨é…ç½®">1.4.4 æ‹¦æˆªå™¨é…ç½®</h4>
<div class="note primary flat"><p><strong>é…ç½®è¯´æ˜</strong></p>
<ul>
<li><code>order(0)</code>ï¼šTokenåˆ·æ–°æ‹¦æˆªå™¨ï¼Œä¼˜å…ˆçº§æœ€é«˜</li>
<li><code>order(1)</code>ï¼šç™»å½•éªŒè¯æ‹¦æˆªå™¨ï¼Œä¼˜å…ˆçº§æ¬¡ä¹‹</li>
<li><code>excludePathPatterns</code>ï¼šé…ç½®ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„</li>
</ul>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// Tokenåˆ·æ–°æ‹¦æˆªå™¨ - æ‹¦æˆªæ‰€æœ‰è·¯å¾„</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .order(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç™»å½•æ‹¦æˆªå™¨ - æ‹¦æˆªéœ€è¦ç™»å½•çš„è·¯å¾„</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,           <span class="comment">// åº—é“ºä¿¡æ¯</span></span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span>,        <span class="comment">// ä¼˜æƒ åˆ¸</span></span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,      <span class="comment">// åº—é“ºç±»å‹</span></span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,        <span class="comment">// æ–‡ä»¶ä¸Šä¼ </span></span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,         <span class="comment">// çƒ­é—¨åšå®¢</span></span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,        <span class="comment">// å‘é€éªŒè¯ç </span></span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>        <span class="comment">// ç”¨æˆ·ç™»å½•</span></span><br><span class="line">                )</span><br><span class="line">                .order(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-5-ç”¨æˆ·ä¿¡æ¯å®‰å…¨å¤„ç†">1.5 ç”¨æˆ·ä¿¡æ¯å®‰å…¨å¤„ç†</h3>
<h4 id="1-5-1-æ•æ„Ÿä¿¡æ¯éšè—çš„å¿…è¦æ€§">1.5.1 æ•æ„Ÿä¿¡æ¯éšè—çš„å¿…è¦æ€§</h4>
<div class="note danger flat"><p><strong>å®‰å…¨é£é™©è­¦å‘Š</strong></p>
<p>ç›´æ¥è¿”å›å®Œæ•´çš„Userå®ä½“å¯¹è±¡ä¼šæš´éœ²ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€æ‰‹æœºå·ã€é‚®ç®±ç­‰ï¼‰ï¼Œå­˜åœ¨ä¸¥é‡çš„å®‰å…¨éšæ‚£ã€‚å¿…é¡»é€šè¿‡DTOå¯¹è±¡è¿›è¡Œæ•°æ®è„±æ•ã€‚</p>
</div>
<h4 id="1-5-2-è§£å†³æ–¹æ¡ˆï¼šUserDTOæ•°æ®ä¼ è¾“å¯¹è±¡">1.5.2 è§£å†³æ–¹æ¡ˆï¼šUserDTOæ•°æ®ä¼ è¾“å¯¹è±¡</h4>
<p><strong>UserDTOå®šä¹‰ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šä¸åŒ…å«æ•æ„Ÿä¿¡æ¯å¦‚passwordã€phoneã€emailç­‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-5-3-ä»£ç ä¿®æ”¹">1.5.3 ä»£ç ä¿®æ”¹</h4>
<p><strong>1. ç™»å½•æ–¹æ³•ä¿®æ”¹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Sessionï¼ˆä½¿ç”¨DTOè„±æ•ï¼‰</span></span><br><span class="line">session.setAttribute(<span class="string">&quot;user&quot;</span>, BeanUtil.copyProperties(user, UserDTO.class));</span><br></pre></td></tr></table></figure>
<p><strong>2. æ‹¦æˆªå™¨ä¿®æ”¹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocalï¼ˆä½¿ç”¨DTOï¼‰</span></span><br><span class="line">UserHolder.saveUser((UserDTO) user);</span><br></pre></td></tr></table></figure>
<p><strong>3. UserHolderå·¥å…·ç±»ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHolder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(UserDTO user)</span> &#123;</span><br><span class="line">        tl.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> UserDTO <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeUser</span><span class="params">()</span> &#123;</span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-5-4-å®‰å…¨æ•ˆæœå¯¹æ¯”">1.5.4 å®‰å…¨æ•ˆæœå¯¹æ¯”</h4>
<table>
<thead>
<tr>
<th>è¿”å›æ–¹å¼</th>
<th>åŒ…å«å­—æ®µ</th>
<th>å®‰å…¨æ€§</th>
<th>æ¨èç¨‹åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>Userå®ä½“</td>
<td>id, phone, password, emailâ€¦</td>
<td>âŒ å±é™©</td>
<td>ç¦æ­¢ä½¿ç”¨</td>
</tr>
<tr>
<td>UserDTO</td>
<td>id, nickName, icon</td>
<td>âœ… å®‰å…¨</td>
<td>å¼ºçƒˆæ¨è</td>
</tr>
</tbody>
</table>
<h3 id="1-6-Sessionå…±äº«é—®é¢˜">1.6 Sessionå…±äº«é—®é¢˜</h3>
<h4 id="1-6-1-åˆ†å¸ƒå¼Sessioné—®é¢˜åˆ†æ">1.6.1 åˆ†å¸ƒå¼Sessioné—®é¢˜åˆ†æ</h4>
<div class="note warning flat"><p><strong>é›†ç¾¤ç¯å¢ƒä¸‹çš„Sessionä¸€è‡´æ€§æŒ‘æˆ˜</strong></p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªTomcatæœåŠ¡å™¨éƒ½æœ‰è‡ªå·±çš„Sessionå­˜å‚¨ã€‚å½“ç”¨æˆ·è¯·æ±‚è¢«åˆ†å‘åˆ°ä¸åŒæœåŠ¡å™¨æ—¶ï¼Œä¼šå¯¼è‡´Sessionæ•°æ®ä¸ä¸€è‡´ï¼Œç”¨æˆ·éœ€è¦é‡å¤ç™»å½•ã€‚</p>
</div>
<p><strong>å…¸å‹é—®é¢˜åœºæ™¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ Nginxè´Ÿè½½å‡è¡¡ â†’ Tomcat1 (ä¿å­˜Session)</span><br><span class="line">                    â†“</span><br><span class="line">                   Tomcat2 (æ— Sessionæ•°æ®)</span><br></pre></td></tr></table></figure>
<p><strong>æ—©æœŸè§£å†³æ–¹æ¡ˆå¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>åŸç†</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sessionå¤åˆ¶</td>
<td>å„æœåŠ¡å™¨é—´åŒæ­¥Session</td>
<td>å®ç°ç®€å•</td>
<td>ç½‘ç»œå¼€é”€å¤§ï¼Œæ€§èƒ½å·®</td>
</tr>
<tr>
<td>Sessionç²˜è¿</td>
<td>å›ºå®šç”¨æˆ·åˆ°æŸå°æœåŠ¡å™¨</td>
<td>æ— éœ€é¢å¤–å¼€å‘</td>
<td>è´Ÿè½½ä¸å‡ï¼Œå•ç‚¹æ•…éšœ</td>
</tr>
<tr>
<td>Sessioné›†ä¸­å­˜å‚¨</td>
<td>ä½¿ç”¨Redisç»Ÿä¸€ç®¡ç†</td>
<td>æ€§èƒ½é«˜ï¼Œå¯æ‰©å±•</td>
<td>éœ€è¦é¢å¤–ç»„ä»¶</td>
</tr>
</tbody>
</table>
<h4 id="1-6-2-Redisè§£å†³æ–¹æ¡ˆ">1.6.2 Redisè§£å†³æ–¹æ¡ˆ</h4>
<div class="note success flat"><p><strong>æ¨èæ–¹æ¡ˆï¼šRedisé›†ä¸­å­˜å‚¨</strong></p>
<p>ä½¿ç”¨Redisä½œä¸ºSessionçš„é›†ä¸­å­˜å‚¨ï¼Œæ‰€æœ‰æœåŠ¡å™¨å…±äº«åŒä¸€ä»½Sessionæ•°æ®ï¼Œå½»åº•è§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„Sessionä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</div>
<p><strong>æ¶æ„è®¾è®¡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ Nginxè´Ÿè½½å‡è¡¡ â†’ Tomcat1</span><br><span class="line">                    â†“              â†“</span><br><span class="line">                   Redis â†------ Tomcat2</span><br><span class="line">                   (é›†ä¸­Sessionå­˜å‚¨)</span><br></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong></p>
<ol>
<li><strong>æ•°æ®å…±äº«</strong>ï¼šæ‰€æœ‰æœåŠ¡å™¨è®¿é—®åŒä¸€ä»½Sessionæ•°æ®</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šRediså†…å­˜å­˜å‚¨ï¼Œè¯»å†™é€Ÿåº¦å¿«</li>
<li><strong>å¯æ‰©å±•</strong>ï¼šæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œæ°´å¹³æ‰©å±•</li>
<li><strong>æŒä¹…åŒ–</strong>ï¼šæ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653069893050.png" alt="1653069893050"></p>
<h3 id="1-7-Redisä»£æ›¿Sessionçš„ä¸šåŠ¡æµç¨‹">1.7 Redisä»£æ›¿Sessionçš„ä¸šåŠ¡æµç¨‹</h3>
<h4 id="1-7-1-Redisæ•°æ®ç»“æ„é€‰æ‹©">1.7.1 Redisæ•°æ®ç»“æ„é€‰æ‹©</h4>
<div class="note info flat"><p><strong>æ•°æ®ç»“æ„å¯¹æ¯”åˆ†æ</strong></p>
<p>åœ¨Redisä¸­å­˜å‚¨ç”¨æˆ·ç™»å½•ä¿¡æ¯æ—¶ï¼Œéœ€è¦æ ¹æ®æ•°æ®ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ã€‚</p>
</div>
<p><strong>String vs Hashç»“æ„å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>å¯¹æ¯”ç»´åº¦</th>
<th>Stringç»“æ„</th>
<th>Hashç»“æ„</th>
</tr>
</thead>
<tbody>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>è¾ƒé«˜ï¼ˆåºåˆ—åŒ–å¼€é”€ï¼‰</td>
<td>è¾ƒä½ï¼ˆå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼‰</td>
</tr>
<tr>
<td>è¯»å†™æ€§èƒ½</td>
<td>ç®€å•å¿«é€Ÿ</td>
<td>æ”¯æŒå­—æ®µçº§æ“ä½œ</td>
</tr>
<tr>
<td>æ•°æ®æ›´æ–°</td>
<td>éœ€è¦æ•´ä½“æ›´æ–°</td>
<td>æ”¯æŒå­—æ®µçº§æ›´æ–°</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>ç®€å•é”®å€¼å¯¹</td>
<td>å¤æ‚å¯¹è±¡å­˜å‚¨</td>
</tr>
</tbody>
</table>
<p><strong>é€‰æ‹©å»ºè®®ï¼š</strong></p>
<ul>
<li>å¦‚æœç”¨æˆ·ä¿¡æ¯ç®€å•ï¼Œä½¿ç”¨Stringç»“æ„</li>
<li>å¦‚æœç”¨æˆ·ä¿¡æ¯å¤æ‚ï¼Œéœ€è¦é¢‘ç¹æ›´æ–°éƒ¨åˆ†å­—æ®µï¼Œä½¿ç”¨Hashç»“æ„</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653319261433.png" alt="1653319261433"></p>
<h4 id="1-7-2-Keyè®¾è®¡ç­–ç•¥">1.7.2 Keyè®¾è®¡ç­–ç•¥</h4>
<div class="note warning flat"><p><strong>Keyè®¾è®¡åŸåˆ™</strong></p>
<p>Redisçš„Keyéœ€è¦æ»¡è¶³å”¯ä¸€æ€§å’Œå¯æºå¸¦æ€§ï¼ŒåŒæ—¶é¿å…æš´éœ²ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ã€‚</p>
</div>
<p><strong>Keyè®¾è®¡è¦ç‚¹ï¼š</strong></p>
<ol>
<li><strong>å”¯ä¸€æ€§</strong>ï¼šç¡®ä¿æ¯ä¸ªç”¨æˆ·çš„Keyéƒ½æ˜¯å”¯ä¸€çš„</li>
<li><strong>å¯æºå¸¦æ€§</strong>ï¼šKeyéœ€è¦æ–¹ä¾¿åœ¨å‰åç«¯ä¹‹é—´ä¼ é€’</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šé¿å…ä½¿ç”¨æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯ä½œä¸ºKey</li>
</ol>
<p><strong>æ¨èæ–¹æ¡ˆï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Keyæ ¼å¼ï¼šlogin:token:&#123;éšæœºtoken&#125;</span><br><span class="line">ç¤ºä¾‹ï¼šlogin:token:a3f2b8c9d1e4f5g6</span><br></pre></td></tr></table></figure>
<p><strong>Tokenç”Ÿæˆç­–ç•¥ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨UUIDç”Ÿæˆéšæœºtoken</span></span><br><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br></pre></td></tr></table></figure>
<h4 id="1-7-3-æ•´ä½“è®¿é—®æµç¨‹">1.7.3 æ•´ä½“è®¿é—®æµç¨‹</h4>
<div class="timeline "><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'></div></div><div class='timeline-item-content'><p>ğŸ“± <strong>æ­¥éª¤1ï¼šç”¨æˆ·ç™»å½•éªŒè¯</strong></p>
<p>ç”¨æˆ·æäº¤æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œç³»ç»ŸéªŒè¯ä¿¡æ¯ä¸€è‡´æ€§</p>
<p>ğŸ” <strong>æ­¥éª¤2ï¼šç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢</strong></p>
<p>æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·</p>
<p>ğŸ’¾ <strong>æ­¥éª¤3ï¼šRedisæ•°æ®å­˜å‚¨</strong></p>
<p>å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°Redisï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´</p>
<p>ğŸ”‘ <strong>æ­¥éª¤4ï¼šTokenè¿”å›</strong></p>
<p>ç”Ÿæˆéšæœºtokenä½œä¸ºç™»å½•å‡­è¯ï¼Œè¿”å›ç»™å‰ç«¯</p>
<p>ğŸ” <strong>æ­¥éª¤5ï¼šç™»å½•çŠ¶æ€æ ¡éªŒ</strong></p>
<p>åç»­è¯·æ±‚æºå¸¦tokenï¼Œç³»ç»ŸéªŒè¯Redisä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”æ•°æ®</p>
</div></div></div>
<h3 id="1-8-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•">1.8 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</h3>
<h4 id="1-8-1-å®ç°æ€è·¯å›é¡¾">1.8.1 å®ç°æ€è·¯å›é¡¾</h4>
<div class="note primary flat"><p><strong>Redisç™»å½•æ–¹æ¡ˆæ ¸å¿ƒ</strong></p>
<p>å°†ä¼ ç»Ÿçš„Sessionå­˜å‚¨æ›¿æ¢ä¸ºRediså­˜å‚¨ï¼Œé€šè¿‡Tokenæœºåˆ¶å®ç°æ— çŠ¶æ€çš„åˆ†å¸ƒå¼ç™»å½•è®¤è¯ã€‚</p>
</div>
<p><strong>æ ¸å¿ƒæ”¹è¿›ç‚¹ï¼š</strong></p>
<ol>
<li><strong>å­˜å‚¨ä½ç½®</strong>ï¼šä»æœåŠ¡å™¨å†…å­˜ â†’ Redisç¼“å­˜</li>
<li><strong>è®¤è¯æ–¹å¼</strong>ï¼šä»SessionID â†’ éšæœºToken</li>
<li><strong>æ•°æ®æ ¼å¼</strong>ï¼šä»å®Œæ•´å¯¹è±¡ â†’ ç²¾ç®€DTO</li>
<li><strong>æœ‰æ•ˆæœŸç®¡ç†</strong>ï¼šæ”¯æŒçµæ´»çš„è¿‡æœŸæ—¶é—´è®¾ç½®</li>
</ol>
<h4 id="1-8-2-æ ¸å¿ƒä»£ç å®ç°">1.8.2 æ ¸å¿ƒä»£ç å®ç°</h4>
<div class="tabs" id="æ”¹è¿›"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æ”¹è¿›-1">ç™»å½•æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#æ”¹è¿›-2">å¸¸é‡å®šä¹‰</button></li><li class="tab"><button type="button" data-href="#æ”¹è¿›-3">å‰ç«¯è°ƒç”¨</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æ”¹è¿›-1"><p><strong>UserServiceImplç™»å½•æ–¹æ³•ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ ¡éªŒæ‰‹æœºå·æ ¼å¼</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> loginForm.getPhone();</span><br><span class="line">        <span class="keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ä»Redisè·å–éªŒè¯ç å¹¶æ ¡éªŒ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .get(LOGIN_CODE_KEY + phone);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> loginForm.getCode();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !cacheCode.equals(code)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> query().eq(<span class="string">&quot;phone&quot;</span>, phone).one();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. ç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            user = createUserWithPhone(phone);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Redis</span></span><br><span class="line">        <span class="comment">// 5.1 éšæœºç”Ÿæˆtokenä½œä¸ºç™»å½•ä»¤ç‰Œ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.2 å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">        Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">                CopyOptions.create()</span><br><span class="line">                        .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                        .setFieldValueEditor((fieldName, fieldValue) -&gt; </span><br><span class="line">                            fieldValue.toString()));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.3 å­˜å‚¨åˆ°Redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tokenKey</span> <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br><span class="line">        stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.4 è®¾ç½®tokenæœ‰æ•ˆæœŸï¼ˆ30åˆ†é’Ÿï¼‰</span></span><br><span class="line">        stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. è¿”å›token</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ”¹è¿›-2"><p><strong>Rediså¸¸é‡é…ç½®ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConstants</span> &#123;</span><br><span class="line">    <span class="comment">// éªŒè¯ç ç›¸å…³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_CODE_KEY</span> <span class="operator">=</span> <span class="string">&quot;login:code:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">LOGIN_CODE_TTL</span> <span class="operator">=</span> <span class="number">2L</span>; <span class="comment">// éªŒè¯ç æœ‰æ•ˆæœŸ2åˆ†é’Ÿ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·ç™»å½•ç›¸å…³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_USER_KEY</span> <span class="operator">=</span> <span class="string">&quot;login:token:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">LOGIN_USER_TTL</span> <span class="operator">=</span> <span class="number">30L</span>; <span class="comment">// ç”¨æˆ·ç™»å½•æœ‰æ•ˆæœŸ30åˆ†é’Ÿ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·ç­¾åˆ°ç›¸å…³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_SIGN_KEY</span> <span class="operator">=</span> <span class="string">&quot;sign:&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•†æˆ·ä¿¡æ¯ç›¸å…³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;cache:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">CACHE_SHOP_TTL</span> <span class="operator">=</span> <span class="number">30L</span>; <span class="comment">// å•†æˆ·ä¿¡æ¯ç¼“å­˜30åˆ†é’Ÿ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äº’æ–¥é”ç›¸å…³</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;lock:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">LOCK_SHOP_TTL</span> <span class="operator">=</span> <span class="number">10L</span>; <span class="comment">// é”æœ‰æ•ˆæœŸ10ç§’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æ”¹è¿›-3"><p><strong>å‰ç«¯ç™»å½•è°ƒç”¨ï¼š</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">sendCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> request.<span class="title function_">post</span>(<span class="string">&#x27;/user/code&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">phone</span>: <span class="variable language_">this</span>.<span class="property">phone</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">code</span> === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$message</span>.<span class="title function_">success</span>(<span class="string">&#x27;éªŒè¯ç å‘é€æˆåŠŸ&#x27;</span>);</span><br><span class="line">        <span class="comment">// å¼€å§‹å€’è®¡æ—¶</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">startCountdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> request.<span class="title function_">post</span>(<span class="string">&#x27;/user/login&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">phone</span>: <span class="variable language_">this</span>.<span class="property">phone</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="variable language_">this</span>.<span class="property">code</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">code</span> === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¿å­˜tokenåˆ°localStorage</span></span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, result.<span class="property">data</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">        request.<span class="property">defaults</span>.<span class="property">headers</span>.<span class="property">common</span>[<span class="string">&#x27;authorization&#x27;</span>] = result.<span class="property">data</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$message</span>.<span class="title function_">success</span>(<span class="string">&#x27;ç™»å½•æˆåŠŸ&#x27;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="1-9-ç™»å½•çŠ¶æ€åˆ·æ–°ä¼˜åŒ–">1.9 ç™»å½•çŠ¶æ€åˆ·æ–°ä¼˜åŒ–</h3>
<h4 id="1-9-1-åˆå§‹æ–¹æ¡ˆé—®é¢˜åˆ†æ">1.9.1 åˆå§‹æ–¹æ¡ˆé—®é¢˜åˆ†æ</h4>
<div class="note danger flat"><p><strong>åˆå§‹æ–¹æ¡ˆç¼ºé™·</strong></p>
<p>åŸæ–¹æ¡ˆä¸­æ‹¦æˆªå™¨åªæ‹¦æˆªéœ€è¦ç™»å½•éªŒè¯çš„è·¯å¾„ï¼Œå¯¼è‡´ç”¨æˆ·è®¿é—®æ— éœ€æ‹¦æˆªçš„è·¯å¾„æ—¶ï¼ŒTokenæ— æ³•å¾—åˆ°åˆ·æ–°ï¼Œå¯èƒ½é€ æˆTokenè¿‡æœŸå¤±æ•ˆã€‚</p>
</div>
<p><strong>é—®é¢˜åœºæ™¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è®¿é—®é¦–é¡µ â†’ æ— éœ€æ‹¦æˆª â†’ Tokenä¸åˆ·æ–° â†’ Tokenè¿‡æœŸ</span><br><span class="line">ç”¨æˆ·è®¿é—®ä¸ªäººä¸­å¿ƒ â†’ éœ€è¦æ‹¦æˆª â†’ Tokenåˆ·æ–° â†’ æ­£å¸¸è®¿é—®</span><br></pre></td></tr></table></figure>
<p><strong>å½±å“åˆ†æï¼š</strong></p>
<ul>
<li>ç”¨æˆ·æ´»è·ƒçŠ¶æ€ä¸‹ä»å¯èƒ½å› Tokenè¿‡æœŸè¢«å¼ºåˆ¶ç™»å‡º</li>
<li>ç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦é¢‘ç¹é‡æ–°ç™»å½•</li>
<li>æ— æ³•å‡†ç¡®åæ˜ ç”¨æˆ·çš„çœŸå®æ´»è·ƒçŠ¶æ€</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653320822964.png" alt="1653320822964"></p>
<h4 id="1-9-2-åŒæ‹¦æˆªå™¨ä¼˜åŒ–æ–¹æ¡ˆ">1.9.2 åŒæ‹¦æˆªå™¨ä¼˜åŒ–æ–¹æ¡ˆ</h4>
<div class="note success flat"><p><strong>ä¼˜åŒ–æ€è·¯</strong></p>
<p>é‡‡ç”¨åŒæ‹¦æˆªå™¨æ¨¡å¼ï¼š</p>
<ul>
<li><strong>åˆ·æ–°æ‹¦æˆªå™¨</strong>ï¼šæ‹¦æˆªæ‰€æœ‰è·¯å¾„ï¼Œè´Ÿè´£Tokenåˆ·æ–°å’Œç”¨æˆ·ä¿¡æ¯åŠ è½½</li>
<li><strong>ç™»å½•æ‹¦æˆªå™¨</strong>ï¼šåªæ‹¦æˆªéœ€è¦ç™»å½•çš„è·¯å¾„ï¼Œè´Ÿè´£ç™»å½•çŠ¶æ€æ ¡éªŒ</li>
</ul>
</div>
<p><strong>æ¶æ„è®¾è®¡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚è¿›å…¥</span><br><span class="line">    â†“</span><br><span class="line">åˆ·æ–°æ‹¦æˆªå™¨ï¼ˆæ‰€æœ‰è·¯å¾„ï¼‰â†’ åˆ·æ–°Tokenæœ‰æ•ˆæœŸ â†’ åŠ è½½ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span><br><span class="line">    â†“</span><br><span class="line">ç™»å½•æ‹¦æˆªå™¨ï¼ˆéœ€ç™»å½•è·¯å¾„ï¼‰â†’ æ ¡éªŒThreadLocalä¸­ç”¨æˆ·ä¿¡æ¯ â†’ å†³å®šæ˜¯å¦æ”¾è¡Œ</span><br><span class="line">    â†“</span><br><span class="line">ä¸šåŠ¡å¤„ç†</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿åˆ†æï¼š</strong></p>
<ul>
<li>æ‰€æœ‰è¯·æ±‚éƒ½èƒ½åˆ·æ–°Tokenï¼Œé¿å…æ„å¤–è¿‡æœŸ</li>
<li>èŒè´£åˆ†ç¦»ï¼Œä»£ç æ›´æ¸…æ™°</li>
<li>æ€§èƒ½å½±å“æœ€å°åŒ–</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653320764547.png" alt="1653320764547"></p>
<h4 id="1-9-3-ä»£ç å®ç°">1.9.3 ä»£ç å®ç°</h4>
<div class="tabs" id="refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-1">åˆ·æ–°æ‹¦æˆªå™¨</button></li><li class="tab"><button type="button" data-href="#refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-2">ç™»å½•æ‹¦æˆªå™¨</button></li><li class="tab"><button type="button" data-href="#refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-3">æ‹¦æˆªå™¨é…ç½®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-1"><p><strong>RefreshTokenInterceptorï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// æ— tokenç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åŸºäºtokenè·å–Redisä¸­çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash()</span><br><span class="line">            .entries(key);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 3. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// ç”¨æˆ·ä¸å­˜åœ¨ç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. å°†æŸ¥è¯¢åˆ°çš„hashæ•°æ®è½¬ä¸ºUserDTO</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 5. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. åˆ·æ–°tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                              HttpServletResponse response, </span></span><br><span class="line"><span class="params">                              Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ç§»é™¤ç”¨æˆ·ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-2"><p><strong>LoginInterceptorï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, </span></span><br><span class="line"><span class="params">                           HttpServletResponse response, </span></span><br><span class="line"><span class="params">                           Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 2. æ²¡æœ‰ç™»å½•ï¼Œè®¾ç½®çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// æ‹¦æˆª</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æœ‰ç”¨æˆ·ï¼Œæ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="refresh-token-interceptor-åˆ·æ–°æ‹¦æˆªå™¨-3"><p><strong>MvcConfigé…ç½®ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RefreshTokenInterceptor refreshTokenInterceptor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LoginInterceptor loginInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ·æ–°æ‹¦æˆªå™¨ - æ‹¦æˆªæ‰€æœ‰è·¯å¾„ï¼Œç”¨äºåˆ·æ–°token</span></span><br><span class="line">        registry.addInterceptor(refreshTokenInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .order(<span class="number">0</span>); <span class="comment">// æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 2. ç™»å½•æ‹¦æˆªå™¨ - åªæ‹¦æˆªéœ€è¦ç™»å½•çš„è·¯å¾„</span></span><br><span class="line">        registry.addInterceptor(loginInterceptor)</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                    <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/user/login&quot;</span>, </span><br><span class="line">                    <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                )</span><br><span class="line">                .order(<span class="number">1</span>); <span class="comment">// ç¬¬äºŒä¼˜å…ˆçº§</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜">2. å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2>
<h3 id="2-1-ç¼“å­˜åŸºç¡€æ¦‚å¿µ">2.1 ç¼“å­˜åŸºç¡€æ¦‚å¿µ</h3>
<h4 id="2-1-1-ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ">2.1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ</h4>
<div class="note info flat"><p><strong>ç¼“å­˜çš„æœ¬è´¨</strong></p>
<p>ç¼“å­˜å°±åƒé¿éœ‡å™¨ä¸€æ ·ï¼Œä¸ºç³»ç»Ÿæä¾›ç¼“å†²ä¿æŠ¤ï¼Œé˜²æ­¢é«˜é¢‘è®¿é—®å¯¹æ•°æ®åº“é€ æˆå†²å‡»ã€‚</p>
</div>
<p><strong>ç”Ÿæ´»ç±»æ¯”ï¼š</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/%E9%81%BF%E9%9C%87%E5%99%A8.gif" alt="é¿éœ‡å™¨"></p>
<p>å°±åƒè¶Šé‡è½¦çš„é¿éœ‡å™¨ï¼Œåœ¨å´å²–åœ°å½¢ä¸­ä¸ºè½¦ä½“æä¾›ä¿æŠ¤ï¼š</p>
<ul>
<li><strong>ä¿æŠ¤ä½œç”¨</strong>ï¼šé˜²æ­¢ç¡¬ç€é™†å¯¹è½¦ä½“é€ æˆæŸå®³</li>
<li><strong>ç¼“å†²ä½œç”¨</strong>ï¼šå¸æ”¶å†²å‡»åŠ›ï¼Œæä¾›å¹³ç¨³ä½“éªŒ</li>
<li><strong>å»¶é•¿å¯¿å‘½</strong>ï¼šå‡å°‘ç³»ç»Ÿç»„ä»¶çš„ç£¨æŸ</li>
</ul>
<p>åŒæ ·ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œç³»ç»Ÿä¹Ÿéœ€è¦&quot;é¿éœ‡å™¨&quot;ï¼Œé˜²æ­¢è¿‡é«˜çš„æ•°æ®è®¿é—®é‡å†²å‡»ç³»ç»Ÿï¼Œå¯¼è‡´æ“ä½œçº¿ç¨‹æ— æ³•åŠæ—¶å¤„ç†ä¿¡æ¯è€Œç˜«ç—ªã€‚</p>
<h4 id="2-1-2-ç¼“å­˜çš„æŠ€æœ¯å®šä¹‰">2.1.2 ç¼“å­˜çš„æŠ€æœ¯å®šä¹‰</h4>
<p><strong>ç¼“å­˜ï¼ˆCacheï¼‰</strong>ï¼Œå°±æ˜¯æ•°æ®äº¤æ¢çš„<strong>ç¼“å†²åŒº</strong>ï¼Œä¿—ç§°çš„ç¼“å­˜å°±æ˜¯<strong>ç¼“å†²åŒºå†…çš„æ•°æ®</strong>ï¼Œä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–ï¼Œå­˜å‚¨äºæœ¬åœ°ä»£ç ä¸­ã€‚</p>
<div class="tabs" id="ç¼“å­˜æŠ€æœ¯"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜æŠ€æœ¯-1">æœ¬åœ°ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜æŠ€æœ¯-2">åˆ†å¸ƒå¼ç¼“å­˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜æŠ€æœ¯-1"><p><strong>æœ¬åœ°ç¼“å­˜å®ç°ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é«˜å¹¶å‘åœºæ™¯ï¼šConcurrentHashMap</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Object&gt; LOCAL_CACHE = </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ™®é€šåœºæ™¯ï¼šHashMap  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; SIMPLE_CACHE = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Guavaç¼“å­˜ï¼šåŠŸèƒ½æ›´å®Œå–„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cache&lt;String, Object&gt; GUAVA_CACHE = </span><br><span class="line">    CacheBuilder.newBuilder()</span><br><span class="line">        .maximumSize(<span class="number">1000</span>)</span><br><span class="line">        .expireAfterWrite(<span class="number">10</span>, TimeUnit.MINUTES)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜æŠ€æœ¯-2"><p><strong>Redisç¼“å­˜å®ç°ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å­˜æ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCache</span><span class="params">(String key, Object value, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">    redisTemplate.opsForValue().set(key, value, timeout, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getCache</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForValue().get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>ç¼“å­˜ç‰¹æ€§ï¼š</strong></p>
<ul>
<li><strong>Staticä¿®é¥°</strong>ï¼šéšç€ç±»åŠ è½½è€ŒåŠ è½½åˆ°å†…å­˜ä¸­</li>
<li><strong>Finalä¿®é¥°</strong>ï¼šå¼•ç”¨å…³ç³»å›ºå®šï¼Œä¸ç”¨æ‹…å¿ƒèµ‹å€¼å¯¼è‡´ç¼“å­˜å¤±æ•ˆ</li>
<li><strong>å†…å­˜å­˜å‚¨</strong>ï¼šè¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜å­˜å‚¨</li>
</ul>
<h4 id="2-1-3-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ">2.1.3 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ</h4>
<div class="note success flat"><p><strong>ç¼“å­˜çš„æ ¸å¿ƒä»·å€¼</strong></p>
<p>ç¼“å­˜æ•°æ®å­˜å‚¨äºå†…å­˜ä¸­ï¼Œè€Œå†…å­˜çš„è¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜ï¼Œå¯ä»¥å¤§å¤§é™ä½é«˜å¹¶å‘è®¿é—®å¸¦æ¥çš„æœåŠ¡å™¨è¯»å†™å‹åŠ›ã€‚</p>
</div>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>å­˜å‚¨ä»‹è´¨</th>
<th>è¯»å–é€Ÿåº¦</th>
<th>å¹¶å‘èƒ½åŠ›</th>
<th>æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å†…å­˜ç¼“å­˜</strong></td>
<td>çº³ç§’çº§</td>
<td>10ä¸‡+QPS</td>
<td>è¾ƒé«˜</td>
</tr>
<tr>
<td><strong>SSDç£ç›˜</strong></td>
<td>å¾®ç§’çº§</td>
<td>1ä¸‡QPS</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td><strong>æœºæ¢°ç£ç›˜</strong></td>
<td>æ¯«ç§’çº§</td>
<td>1åƒQPS</td>
<td>è¾ƒä½</td>
</tr>
</tbody>
</table>
<p><strong>ä¸šåŠ¡ä»·å€¼ï¼š</strong></p>
<ol>
<li><strong>ç”¨æˆ·ä½“éªŒæå‡</strong>ï¼šé¡µé¢å“åº”ä»ç§’çº§â†’æ¯«ç§’çº§</li>
<li><strong>ç³»ç»Ÿç¨³å®šæ€§</strong>ï¼šé˜²æ­¢é«˜å¹¶å‘å†²å®æ•°æ®åº“</li>
<li><strong>æˆæœ¬ä¼˜åŒ–</strong>ï¼šå‡å°‘æ•°æ®åº“æœåŠ¡å™¨å‹åŠ›</li>
<li><strong>æ‰©å±•èƒ½åŠ›</strong>ï¼šæ”¯æŒæ›´é«˜çš„å¹¶å‘è®¿é—®é‡</li>
</ol>
<p><strong>æ•°æ®è§„æ¨¡æŒ‘æˆ˜ï¼š</strong></p>
<p>å®é™…å¼€å‘ä¸­ï¼Œä¼ä¸šæ•°æ®é‡ä»å‡ åä¸‡åˆ°å‡ åƒä¸‡ä¸ç­‰ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜ä½œä¸º&quot;é¿éœ‡å™¨&quot;ï¼Œç³»ç»Ÿå‡ ä¹æ— æ³•æ‰¿å—é«˜å¹¶å‘è®¿é—®ã€‚</p>
<div class="note warning flat"><p><strong>ç¼“å­˜çš„ä»£ä»·</strong></p>
<p>ç¼“å­˜æŠ€æœ¯è™½ç„¶å¼ºå¤§ï¼Œä½†ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œè¿ç»´æˆæœ¬ï¼Œéœ€è¦æƒè¡¡ä½¿ç”¨ã€‚</p>
</div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/image-20220523214414123.png" alt=""></p>
<h4 id="2-1-4-å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ">2.1.4 å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ</h4>
<div class="note info flat"><p><strong>å¤šçº§ç¼“å­˜æ¶æ„</strong></p>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¼šæ„å»ºå¤šçº§ç¼“å­˜ä½“ç³»æ¥æœ€å¤§åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Œæ¯ä¸€çº§ç¼“å­˜éƒ½æœ‰å…¶ç‰¹å®šçš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ã€‚</p>
</div>
<p><strong>å¤šçº§ç¼“å­˜å±‚æ¬¡ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚</span><br><span class="line">    â†“</span><br><span class="line">æµè§ˆå™¨ç¼“å­˜ (å®¢æˆ·ç«¯ç¼“å­˜)</span><br><span class="line">    â†“</span><br><span class="line">CDNç¼“å­˜ (è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜)</span><br><span class="line">    â†“</span><br><span class="line">åº”ç”¨å±‚ç¼“å­˜ (Tomcatæœ¬åœ°ç¼“å­˜ + Redisåˆ†å¸ƒå¼ç¼“å­˜)</span><br><span class="line">    â†“</span><br><span class="line">æ•°æ®åº“ç¼“å­˜ (Buffer Pool)</span><br><span class="line">    â†“</span><br><span class="line">CPUç¼“å­˜ (L1/L2/L3)</span><br></pre></td></tr></table></figure>
<div class="tabs" id="ç¼“å­˜ä½¿ç”¨"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜ä½¿ç”¨-1">æµè§ˆå™¨ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ä½¿ç”¨-2">åº”ç”¨å±‚ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ä½¿ç”¨-3">æ•°æ®åº“ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ä½¿ç”¨-4">CPUç¼“å­˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜ä½¿ç”¨-1"><p><strong>æµè§ˆå™¨ç¼“å­˜ï¼š</strong></p>
<ul>
<li><strong>å­˜å‚¨ä½ç½®</strong>ï¼šç”¨æˆ·æµè§ˆå™¨æœ¬åœ°</li>
<li><strong>æ§åˆ¶æ–¹å¼</strong>ï¼šHTTPå¤´ä¿¡æ¯æ§åˆ¶</li>
<li><strong>å…¸å‹åº”ç”¨</strong>ï¼šé™æ€èµ„æºç¼“å­˜ï¼ˆCSSã€JSã€å›¾ç‰‡ï¼‰</li>
<li><strong>æœ‰æ•ˆæœŸ</strong>ï¼šé€šè¿‡Cache-Controlã€Expiresè®¾ç½®</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=3600</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>Wed, 21 Oct 2025 07:28:00 GMT</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ä½¿ç”¨-2"><p><strong>åº”ç”¨å±‚ç¼“å­˜ï¼š</strong></p>
<ul>
<li><strong>æœ¬åœ°ç¼“å­˜</strong>ï¼šTomcat JVMå†…å­˜ä¸­çš„Mapç»“æ„</li>
<li><strong>åˆ†å¸ƒå¼ç¼“å­˜</strong>ï¼šRedisé›†ç¾¤å­˜å‚¨</li>
<li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šçƒ­ç‚¹æ•°æ®ã€ä¼šè¯ä¿¡æ¯ã€é…ç½®æ•°æ®</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ¬åœ°ç¼“å­˜</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; localCache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redisç¼“å­˜</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ä½¿ç”¨-3"><p><strong>æ•°æ®åº“ç¼“å­˜ï¼š</strong></p>
<ul>
<li><strong>Buffer Pool</strong>ï¼šInnoDBå­˜å‚¨å¼•æ“çš„ç¼“å†²æ± </li>
<li><strong>æŸ¥è¯¢ç¼“å­˜</strong>ï¼šMySQLæŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆ8.0å·²åºŸå¼ƒï¼‰</li>
<li><strong>ä½œç”¨</strong>ï¼šå‡å°‘ç£ç›˜IOï¼Œæå‡æŸ¥è¯¢æ€§èƒ½</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥çœ‹Buffer PoolçŠ¶æ€</span></span><br><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS\G</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ä½¿ç”¨-4"><p><strong>CPUç¼“å­˜ï¼š</strong></p>
<ul>
<li><strong>L1ç¼“å­˜</strong>ï¼šæŒ‡ä»¤ç¼“å­˜å’Œæ•°æ®ç¼“å­˜ï¼Œ32-64KB</li>
<li><strong>L2ç¼“å­˜</strong>ï¼š256-512KBï¼Œé€Ÿåº¦æ¬¡äºL1</li>
<li><strong>L3ç¼“å­˜</strong>ï¼šå¤šæ ¸å¿ƒå…±äº«ï¼Œ8-32MB</li>
</ul>
<p><strong>ç¼“å­˜å±‚çº§å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç¼“å­˜çº§åˆ«</th>
<th>å®¹é‡</th>
<th>è®¿é—®å»¶è¿Ÿ</th>
<th>å‘½ä¸­ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>L1</td>
<td>32-64KB</td>
<td>1-2ns</td>
<td>80%+</td>
</tr>
<tr>
<td>L2</td>
<td>256-512KB</td>
<td>3-5ns</td>
<td>90%+</td>
</tr>
<tr>
<td>L3</td>
<td>8-32MB</td>
<td>10-20ns</td>
<td>95%+</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/image-20220523212915666.png" alt=""></p>
<h3 id="2-2-å•†æˆ·ç¼“å­˜å®ç°">2.2 å•†æˆ·ç¼“å­˜å®ç°</h3>
<h4 id="2-2-1-ä¸šåŠ¡åœºæ™¯åˆ†æ">2.2.1 ä¸šåŠ¡åœºæ™¯åˆ†æ</h4>
<div class="note info flat"><p><strong>æ€§èƒ½ç“¶é¢ˆè¯†åˆ«</strong></p>
<p>åœ¨æŸ¥è¯¢å•†æˆ·ä¿¡æ¯æ—¶ï¼Œå¦‚æœç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå½“å¹¶å‘é‡å¢å¤§æ—¶ï¼Œæ•°æ®åº“å‹åŠ›ä¼šæ€¥å‰§ä¸Šå‡ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šæ˜¾è‘—ä¸‹é™ã€‚</p>
</div>
<p><strong>åŸå§‹ä»£ç ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ - æ€§èƒ½ç“¶é¢ˆ</span></span><br><span class="line">    <span class="keyword">return</span> shopService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ€§èƒ½é—®é¢˜ï¼š</strong></p>
<ul>
<li>æ¯æ¬¡æŸ¥è¯¢éƒ½è¦è®¿é—®æ•°æ®åº“</li>
<li>æ•°æ®åº“è¿æ¥èµ„æºæœ‰é™</li>
<li>é«˜å¹¶å‘ä¸‹æ•°æ®åº“æˆä¸ºç“¶é¢ˆ</li>
<li>ç›¸åŒæ•°æ®é‡å¤æŸ¥è¯¢æµªè´¹èµ„æº</li>
</ul>
<h4 id="2-2-2-ç¼“å­˜æ¶æ„è®¾è®¡">2.2.2 ç¼“å­˜æ¶æ„è®¾è®¡</h4>
<div class="note success flat"><p><strong>æ ‡å‡†ç¼“å­˜æ¨¡å¼</strong></p>
<p>é‡‡ç”¨Cache-Asideæ¨¡å¼ï¼šæŸ¥è¯¢å‰å…ˆæŸ¥ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­ç›´æ¥è¿”å›ï¼Œæœªå‘½ä¸­æŸ¥è¯¢æ•°æ®åº“å¹¶å†™å…¥ç¼“å­˜ã€‚</p>
</div>
<p><strong>ç¼“å­˜æµç¨‹å›¾ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚</span><br><span class="line">    â†“</span><br><span class="line">æŸ¥è¯¢Redisç¼“å­˜</span><br><span class="line">    â†“</span><br><span class="line">ç¼“å­˜å‘½ä¸­ï¼Ÿâ†’ æ˜¯ â†’ ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®</span><br><span class="line">    â†“ å¦</span><br><span class="line">æŸ¥è¯¢MySQLæ•°æ®åº“</span><br><span class="line">    â†“</span><br><span class="line">å†™å…¥Redisç¼“å­˜</span><br><span class="line">    â†“</span><br><span class="line">è¿”å›æŸ¥è¯¢ç»“æœ</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653322097736.png" alt="1653322097736"></p>
<h4 id="2-2-3-ä»£ç å®ç°">2.2.3 ä»£ç å®ç°</h4>
<div class="note primary flat"><p><strong>å®ç°æ€è·¯</strong></p>
<p>ä»£ç é€»è¾‘ï¼šå¦‚æœç¼“å­˜å‘½ä¸­åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†ç»“æœå†™å…¥Redisç¼“å­˜ã€‚</p>
</div>
<div class="tabs" id="ç¼“å­˜"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜-1">Serviceå±‚å®ç°</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜-2">Controllerå±‚</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜-3">Rediså¸¸é‡</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜-4">æµ‹è¯•éªŒè¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜-1"><p><strong>ShopServiceImplï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="keyword">implements</span> <span class="title class_">IShopService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ä»RedisæŸ¥è¯¢å•†æˆ·ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">            <span class="comment">// 3. å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), </span><br><span class="line">            CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜-2"><p><strong>ShopControllerï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/shop&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShop</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨Serviceå±‚çš„ç¼“å­˜æŸ¥è¯¢æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> shopService.queryShopById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜-3"><p><strong>ç¼“å­˜å¸¸é‡é…ç½®ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;cache:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">CACHE_SHOP_TTL</span> <span class="operator">=</span> <span class="number">30L</span>; <span class="comment">// 30åˆ†é’Ÿ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜-4"><p><strong>æ€§èƒ½æµ‹è¯•å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æŸ¥è¯¢æ–¹å¼</th>
<th>å¹³å‡å“åº”æ—¶é—´</th>
<th>QPS</th>
<th>æ•°æ®åº“å‹åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç›´æ¥æŸ¥æ•°æ®åº“</td>
<td>150ms</td>
<td>500</td>
<td>é«˜</td>
</tr>
<tr>
<td>Redisç¼“å­˜</td>
<td>5ms</td>
<td>10,000+</td>
<td>ä½</td>
</tr>
<tr>
<td>æ€§èƒ½æå‡</td>
<td><strong>30å€</strong></td>
<td><strong>20å€</strong></td>
<td><strong>å¤§å¹…é™ä½</strong></td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653322190155.png" alt="1653322190155"></p>
<h3 id="2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥">2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</h3>
<h4 id="2-3-1-ç¼“å­˜æ›´æ–°ç­–ç•¥æ¦‚è¿°">2.3.1 ç¼“å­˜æ›´æ–°ç­–ç•¥æ¦‚è¿°</h4>
<div class="note info flat"><p><strong>ç¼“å­˜æ›´æ–°çš„å¿…è¦æ€§</strong></p>
<p>å†…å­˜èµ„æºå®è´µï¼Œå½“ç¼“å­˜æ•°æ®è¿‡å¤šæ—¶éœ€è¦åˆç†çš„æ›´æ–°ç­–ç•¥æ¥ä¿è¯ç³»ç»Ÿæ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚</p>
</div>
<p><strong>ä¸‰å¤§ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼š</strong></p>
<div class="tabs" id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜æ›´æ–°ç­–ç•¥-1">å†…å­˜æ·˜æ±°ç­–ç•¥</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜æ›´æ–°ç­–ç•¥-2">è¶…æ—¶å‰”é™¤ç­–ç•¥</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜æ›´æ–°ç­–ç•¥-3">ä¸»åŠ¨æ›´æ–°ç­–ç•¥</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜æ›´æ–°ç­–ç•¥-1"><p><strong>å†…å­˜æ·˜æ±°æœºåˆ¶</strong></p>
<p>å½“Rediså†…å­˜è¾¾åˆ°<code>max-memory</code>è®¾ç½®çš„ä¸Šé™æ—¶ï¼Œè‡ªåŠ¨è§¦å‘å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œæ ¹æ®é…ç½®çš„æ·˜æ±°ç­–ç•¥åˆ é™¤éƒ¨åˆ†æ•°æ®ã€‚</p>
<p><strong>å¸¸è§æ·˜æ±°ç­–ç•¥ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>æè¿°</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>noeviction</td>
<td>ä¸æ·˜æ±°ï¼Œè¿”å›é”™è¯¯</td>
<td>æ•°æ®ä¸èƒ½ä¸¢å¤±</td>
</tr>
<tr>
<td>allkeys-lru</td>
<td>æ‰€æœ‰keyä¸­æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨</td>
<td>ç¼“å­˜åº”ç”¨</td>
</tr>
<tr>
<td>volatile-lru</td>
<td>è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyä¸­æ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨</td>
<td>æ··åˆæ•°æ®</td>
</tr>
<tr>
<td>allkeys-random</td>
<td>éšæœºæ·˜æ±°æ‰€æœ‰key</td>
<td>æµ‹è¯•ç¯å¢ƒ</td>
</tr>
<tr>
<td>volatile-ttl</td>
<td>æ·˜æ±°å³å°†è¿‡æœŸçš„key</td>
<td>ä¸´æ—¶æ•°æ®</td>
</tr>
</tbody>
</table>
<p><strong>é…ç½®ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redisé…ç½®æ–‡ä»¶</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜æ›´æ–°ç­–ç•¥-2"><p><strong>TTLè¿‡æœŸæœºåˆ¶</strong></p>
<p>ä¸ºç¼“å­˜æ•°æ®è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ï¼ŒRedisä¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸçš„æ•°æ®ã€‚</p>
<p><strong>TTLè®¾ç½®åŸåˆ™ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸šåŠ¡æ•°æ®ç¼“å­˜ - 30åˆ†é’Ÿ</span></span><br><span class="line">stringRedisTemplate.opsForValue().set(key, value, <span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line"><span class="comment">// çƒ­ç‚¹æ•°æ®ç¼“å­˜ - 1å°æ—¶  </span></span><br><span class="line">stringRedisTemplate.opsForValue().set(key, value, <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®æ•°æ®ç¼“å­˜ - 24å°æ—¶</span></span><br><span class="line">stringRedisTemplate.opsForValue().set(key, value, <span class="number">24</span>, TimeUnit.HOURS);</span><br></pre></td></tr></table></figure>
<p><strong>TTLè®¾è®¡è¦ç‚¹ï¼š</strong></p>
<ul>
<li>çƒ­ç‚¹æ•°æ®ï¼šTTLè¾ƒçŸ­ï¼Œä¿è¯æ•°æ®æ–°é²œåº¦</li>
<li>å†·æ•°æ®ï¼šTTLè¾ƒé•¿ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›</li>
<li>ä¸šåŠ¡æ•°æ®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆç†TTL</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜æ›´æ–°ç­–ç•¥-3"><p><strong>æ‰‹åŠ¨æ›´æ–°æœºåˆ¶</strong></p>
<p>åœ¨æ•°æ®å˜æ›´æ—¶ä¸»åŠ¨åˆ é™¤æˆ–æ›´æ–°ç¼“å­˜ï¼Œä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<p><strong>æ›´æ–°æ—¶æœºï¼š</strong></p>
<ul>
<li>æ•°æ®æ–°å¢æ—¶ï¼šå†™å…¥ç¼“å­˜</li>
<li>æ•°æ®ä¿®æ”¹æ—¶ï¼šåˆ é™¤ç¼“å­˜</li>
<li>æ•°æ®åˆ é™¤æ—¶ï¼šåˆ é™¤ç¼“å­˜</li>
</ul>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ›´æ–°å•†æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">    updateById(shop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ é™¤ç¼“å­˜ï¼ˆä¸»åŠ¨æ›´æ–°ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653322506393.png" alt="1653322506393"></p>
<h4 id="2-3-2-æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ">2.3.2 æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ</h4>
<div class="note warning flat"><p><strong>ä¸€è‡´æ€§é—®é¢˜åˆ†æ</strong></p>
<p>ç¼“å­˜æ•°æ®æºæ¥è‡ªæ•°æ®åº“ï¼Œè€Œæ•°æ®åº“æ•°æ®ä¼šå‘ç”Ÿå˜åŒ–ã€‚å½“æ•°æ®åº“æ•°æ®å‘ç”Ÿå˜åŒ–è€Œç¼“å­˜æœªåŒæ­¥æ—¶ï¼Œå°±ä¼šäº§ç”Ÿä¸€è‡´æ€§é—®é¢˜ï¼Œç”¨æˆ·ä½¿ç”¨è¿‡æ—¶æ•°æ®ä¼šå½±å“ä¸šåŠ¡æ­£ç¡®æ€§ã€‚</p>
</div>
<p><strong>ä¸‰å¤§è§£å†³æ–¹æ¡ˆå¯¹æ¯”ï¼š</strong></p>
<div class="tabs" id="ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-1">Cache Aside Pattern</button></li><li class="tab"><button type="button" data-href="#ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-2">Read/Write Through</button></li><li class="tab"><button type="button" data-href="#ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-3">Write Behind Caching</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-1"><p><strong>æ—è·¯ç¼“å­˜æ¨¡å¼ï¼ˆæ¨èï¼‰</strong></p>
<p>ç¼“å­˜è°ƒç”¨è€…åœ¨æ›´æ–°æ•°æ®åº“åæ‰‹åŠ¨æ›´æ–°ç¼“å­˜ï¼Œä¹Ÿç§°ä¸ºåŒå†™æ–¹æ¡ˆã€‚</p>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢æ“ä½œï¼š</span><br><span class="line">ç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥è¿”å›</span><br><span class="line">ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ</span><br><span class="line"></span><br><span class="line">æ›´æ–°æ“ä½œï¼š</span><br><span class="line">æ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å®ç°ç®€å•ï¼Œæ§åˆ¶çµæ´»</li>
<li>âœ… æ•°æ®ä¸€è‡´æ€§è¾ƒå¥½</li>
<li>âœ… é€‚åˆè¯»å¤šå†™å°‘åœºæ™¯</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ éœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç»´æŠ¤</li>
<li>âŒ å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´çª—å£</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>è¯»å¤šå†™å°‘çš„ä¸šåŠ¡ç³»ç»Ÿ</li>
<li>å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜</li>
<li>å¼€å‘å›¢é˜Ÿæœ‰è¾ƒå¼ºæŠ€æœ¯èƒ½åŠ›</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-2"><p><strong>è¯»å†™ç©¿é€æ¨¡å¼</strong></p>
<p>ç”±ç¼“å­˜ç³»ç»Ÿæœ¬èº«å®Œæˆæ•°æ®åº“ä¸ç¼“å­˜çš„åŒæ­¥æ“ä½œã€‚</p>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢æ“ä½œï¼š</span><br><span class="line">ç¼“å­˜æœªå‘½ä¸­ â†’ ç¼“å­˜ç³»ç»ŸæŸ¥è¯¢æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ</span><br><span class="line"></span><br><span class="line">æ›´æ–°æ“ä½œï¼š</span><br><span class="line">æ›´æ–°ç¼“å­˜ â†’ ç¼“å­˜ç³»ç»ŸåŒæ­¥æ›´æ–°æ•°æ®åº“</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å¯¹åº”ç”¨é€æ˜ï¼Œç®€åŒ–å¼€å‘</li>
<li>âœ… ç¼“å­˜ç³»ç»Ÿç»Ÿä¸€ç®¡ç†</li>
<li>âœ… æ•°æ®ä¸€è‡´æ€§è¾ƒå¥½</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ å®ç°å¤æ‚ï¼Œéœ€è¦ç¼“å­˜ç³»ç»Ÿæ”¯æŒ</li>
<li>âŒ æ€§èƒ½å¼€é”€è¾ƒå¤§</li>
<li>âŒ å¼ºä¾èµ–ç¼“å­˜ç³»ç»Ÿç¨³å®šæ€§</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ</li>
<li>æœ‰ä¸“ä¸šç¼“å­˜ä¸­é—´ä»¶æ”¯æŒ</li>
<li>å¯¹å¼€å‘ç®€åŒ–è¦æ±‚è¾ƒé«˜</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ä¸€è‡´æ€§é—®é¢˜è§£å†³æ–¹æ¡ˆ-3"><p><strong>å¼‚æ­¥å†™å›æ¨¡å¼</strong></p>
<p>è°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹å¼‚æ­¥å¤„ç†æ•°æ®åº“ï¼Œå®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢æ“ä½œï¼š</span><br><span class="line">ç›´æ¥æŸ¥è¯¢ç¼“å­˜</span><br><span class="line"></span><br><span class="line">æ›´æ–°æ“ä½œï¼š</span><br><span class="line">æ›´æ–°ç¼“å­˜ â†’ å¼‚æ­¥çº¿ç¨‹æ‰¹é‡å†™å…¥æ•°æ®åº“</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… å†™å…¥æ€§èƒ½æé«˜</li>
<li>âœ… æ•°æ®åº“å‹åŠ›å°</li>
<li>âœ… é€‚åˆå†™å¯†é›†å‹åº”ç”¨</li>
</ul>
<p><strong>ç¼ºç‚¹ï¼š</strong></p>
<ul>
<li>âŒ æ•°æ®ä¸€è‡´æ€§å·®</li>
<li>âŒ å®ç°å¤æ‚åº¦é«˜</li>
<li>âŒ å¯èƒ½ä¸¢å¤±æ•°æ®</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
<ul>
<li>å†™æ“ä½œè¿œå¤šäºè¯»æ“ä½œ</li>
<li>å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜</li>
<li>å…è®¸çŸ­æš‚æ•°æ®ä¸¢å¤±</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>æ–¹æ¡ˆé€‰æ‹©å»ºè®®ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¸€è‡´æ€§</th>
<th>æ€§èƒ½</th>
<th>å¤æ‚åº¦</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cache Aside</td>
<td>â­â­â­</td>
<td>â­â­â­</td>
<td>â­â­</td>
<td>è¯»å¤šå†™å°‘</td>
</tr>
<tr>
<td>Read/Write Through</td>
<td>â­â­â­â­</td>
<td>â­â­</td>
<td>â­â­â­â­</td>
<td>å¤§å‹ç³»ç»Ÿ</td>
</tr>
<tr>
<td>Write Behind</td>
<td>â­â­</td>
<td>â­â­â­â­</td>
<td>â­â­â­â­â­</td>
<td>å†™å¯†é›†å‹</td>
</tr>
</tbody>
</table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653322857620.png" alt="1653322857620"></p>
<h4 id="2-3-3-æœ€ä½³å®è·µæ–¹æ¡ˆé€‰æ‹©">2.3.3 æœ€ä½³å®è·µæ–¹æ¡ˆé€‰æ‹©</h4>
<div class="note success flat"><p><strong>æ¨èæ–¹æ¡ˆï¼šCache Aside + åˆ é™¤ç¼“å­˜ç­–ç•¥</strong></p>
<p>ç»¼åˆè€ƒè™‘ä¸€è‡´æ€§ã€æ€§èƒ½å’Œå®ç°å¤æ‚åº¦ï¼Œæ¨èä½¿ç”¨Cache Asideæ¨¡å¼é…åˆåˆ é™¤ç¼“å­˜ç­–ç•¥ã€‚</p>
</div>
<p><strong>æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š</strong></p>
<div class="tabs" id="åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-1">åˆ é™¤ç¼“å­˜ vs æ›´æ–°ç¼“å­˜</button></li><li class="tab"><button type="button" data-href="#åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-2">æ“ä½œé¡ºåºé€‰æ‹©</button></li><li class="tab"><button type="button" data-href="#åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-3">äº‹åŠ¡ä¿è¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-1"><p><strong>åˆ é™¤ç¼“å­˜ç­–ç•¥ï¼ˆæ¨èï¼‰</strong></p>
<p>æ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ã€‚</p>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ›´æ–°æ“ä½œï¼š</span><br><span class="line">1. æ›´æ–°æ•°æ®åº“</span><br><span class="line">2. åˆ é™¤ç¼“å­˜</span><br><span class="line">3. ç­‰å¾…ä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿åˆ†æï¼š</strong></p>
<ul>
<li>âœ… <strong>é¿å…æ— æ•ˆå†™æ“ä½œ</strong>ï¼šå¤šæ¬¡æ›´æ–°åªéœ€ä¸€æ¬¡åˆ é™¤</li>
<li>âœ… <strong>ç®€åŒ–å®ç°é€»è¾‘</strong>ï¼šæ— éœ€è€ƒè™‘ç¼“å­˜æ•°æ®æ ¼å¼è½¬æ¢</li>
<li>âœ… <strong>é™ä½å¹¶å‘é—®é¢˜</strong>ï¼šå‡å°‘ç¼“å­˜ä¸æ•°æ®åº“ä¸ä¸€è‡´æ—¶é—´çª—å£</li>
</ul>
<p><strong>å¯¹æ¯”è¡¨æ ¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç­–ç•¥</th>
<th>å†™æ“ä½œæ¬¡æ•°</th>
<th>å®ç°å¤æ‚åº¦</th>
<th>ä¸€è‡´æ€§é£é™©</th>
<th>æ¨èåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ›´æ–°ç¼“å­˜</td>
<td>æ¯æ¬¡æ›´æ–°éƒ½å†™ç¼“å­˜</td>
<td>é«˜ï¼ˆéœ€å¤„ç†æ•°æ®è½¬æ¢ï¼‰</td>
<td>é«˜ï¼ˆå¹¶å‘æ›´æ–°å†²çªï¼‰</td>
<td>â­â­</td>
</tr>
<tr>
<td>åˆ é™¤ç¼“å­˜</td>
<td>ä»…åˆ é™¤ï¼ŒæŸ¥è¯¢æ—¶é‡å»º</td>
<td>ä½ï¼ˆç®€å•åˆ é™¤ï¼‰</td>
<td>ä½ï¼ˆé‡å»ºæ—¶æ•°æ®æœ€æ–°ï¼‰</td>
<td>â­â­â­â­â­</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-2"><p><strong>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ˆæ¨èï¼‰</strong></p>
<p>ç¡®ä¿æ•°æ®åº“æ“ä½œæˆåŠŸåå†åˆ é™¤ç¼“å­˜ï¼Œé¿å…ç¼“å­˜åˆ é™¤åæ•°æ®åº“æ›´æ–°å¤±è´¥çš„æƒ…å†µã€‚</p>
<p><strong>æ—¶åºåˆ†æï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹1ï¼šæ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜</span><br><span class="line">çº¿ç¨‹2ï¼šæŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜</span><br></pre></td></tr></table></figure>
<p><strong>å¹¶å‘å®‰å…¨æ€§ï¼š</strong></p>
<ul>
<li>å³ä½¿çº¿ç¨‹2åœ¨çº¿ç¨‹1åˆ é™¤ç¼“å­˜åæŸ¥è¯¢æ•°æ®åº“ï¼Œè·å–çš„ä¹Ÿæ˜¯æœ€æ–°çš„æ•°æ®</li>
<li>é¿å…äº†&quot;åˆ é™¤ç¼“å­˜â†’æ•°æ®åº“æ›´æ–°å¤±è´¥&quot;å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´</li>
</ul>
<p><strong>å¯¹æ¯”åˆ†æï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ“ä½œé¡ºåº</th>
<th>å¹¶å‘é£é™©</th>
<th>ä¸€è‡´æ€§ä¿è¯</th>
<th>å®ç°å¤æ‚åº¦</th>
<th>æ¨èåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…ˆåˆ ç¼“å­˜å†æ›´æ–°æ•°æ®åº“</td>
<td>é«˜ï¼ˆå…¶ä»–çº¿ç¨‹å¯èƒ½å†™å…¥æ—§æ•°æ®ï¼‰</td>
<td>å·®</td>
<td>é«˜ï¼ˆéœ€é¢å¤–é”æœºåˆ¶ï¼‰</td>
<td>â­â­</td>
</tr>
<tr>
<td>å…ˆæ›´æ–°æ•°æ®åº“å†åˆ ç¼“å­˜</td>
<td>ä½ï¼ˆæ•°æ®åº“å·²æ›´æ–°ï¼‰</td>
<td>å¥½</td>
<td>ä½</td>
<td>â­â­â­â­â­</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="åˆ é™¤ç¼“å­˜-vs-æ›´æ–°ç¼“å­˜-3"><p><strong>æ“ä½œåŸå­æ€§ä¿è¯</strong></p>
<p>ç¡®ä¿ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œåŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Œé¿å…ä¸­é—´çŠ¶æ€ã€‚</p>
<p><strong>å•ä½“ç³»ç»Ÿäº‹åŠ¡ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">        shopMapper.updateById(shop);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åˆ é™¤ç¼“å­˜</span></span><br><span class="line">        stringRedisTemplate.delete(CACHE_SHOP_KEY + shop.getId());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// äº‹åŠ¡å›æ»šï¼Œæ•°æ®åº“å’Œç¼“å­˜ä¿æŒä¸€è‡´</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ›´æ–°å¤±è´¥&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ†å¸ƒå¼ç³»ç»Ÿæ–¹æ¡ˆï¼š</strong></p>
<ul>
<li><strong>TCCæ¨¡å¼</strong>ï¼šTry-Confirm-Cancelä¸‰é˜¶æ®µæäº¤</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šé€šè¿‡æ¶ˆæ¯ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§</li>
<li><strong>åˆ†å¸ƒå¼é”</strong>ï¼šä¿è¯æ“ä½œé¡ºåºæ€§</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>æœ€ç»ˆæ¨èæ–¹æ¡ˆï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ğŸ¯ æœ€ä½³å®è·µç»„åˆï¼š</span><br><span class="line">1. é‡‡ç”¨Cache Asideæ¨¡å¼</span><br><span class="line">2. ä½¿ç”¨åˆ é™¤ç¼“å­˜ç­–ç•¥</span><br><span class="line">3. å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜</span><br><span class="line">4. å•ä½“ç³»ç»Ÿä½¿ç”¨äº‹åŠ¡ä¿è¯</span><br><span class="line">5. åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æœ€ç»ˆä¸€è‡´æ€§</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653323595206.png" alt="1653323595206"></p>
<h3 id="2-4-å•†æˆ·ç¼“å­˜åŒå†™ä¸€è‡´æ€§å®ç°">2.4 å•†æˆ·ç¼“å­˜åŒå†™ä¸€è‡´æ€§å®ç°</h3>
<h4 id="2-4-1-å®ç°æ€è·¯">2.4.1 å®ç°æ€è·¯</h4>
<div class="note primary flat"><p><strong>åŒå†™ä¸€è‡´æ€§è¦æ±‚</strong></p>
<p>æŸ¥è¯¢æ—¶ï¼šç¼“å­˜æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“å¹¶å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´<br>
æ›´æ–°æ—¶ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§</p>
</div>
<p><strong>å®ç°æµç¨‹å›¾ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢æµç¨‹ï¼š</span><br><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥è¯¢Redisç¼“å­˜ â†’ å‘½ä¸­ï¼Ÿâ†’ æ˜¯ â†’ è¿”å›ç¼“å­˜æ•°æ®</span><br><span class="line">                   â†“ å¦</span><br><span class="line">               æŸ¥è¯¢MySQLæ•°æ®åº“</span><br><span class="line">                   â†“</span><br><span class="line">               å†™å…¥Redisç¼“å­˜ï¼ˆå¸¦TTLï¼‰</span><br><span class="line">                   â†“</span><br><span class="line">               è¿”å›æŸ¥è¯¢ç»“æœ</span><br><span class="line"></span><br><span class="line">æ›´æ–°æµç¨‹ï¼š</span><br><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ æ›´æ–°MySQLæ•°æ®åº“ â†’ åˆ é™¤Redisç¼“å­˜ â†’ è¿”å›æ›´æ–°ç»“æœ</span><br></pre></td></tr></table></figure>
<h4 id="2-4-2-ä»£ç å®ç°">2.4.2 ä»£ç å®ç°</h4>
<div class="tabs" id="æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-1">æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–</button></li><li class="tab"><button type="button" data-href="#æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-2">æ›´æ–°æ–¹æ³•å®ç°</button></li><li class="tab"><button type="button" data-href="#æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-3">Controllerå±‚è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-4">ä¸€è‡´æ€§éªŒè¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-1"><p><strong>ShopServiceImplæŸ¥è¯¢æ–¹æ³•ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ä»RedisæŸ¥è¯¢å•†æˆ·ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">// 3. å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. æ•°æ®åº“ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. å­˜åœ¨ï¼Œå†™å…¥Redisç¼“å­˜ï¼ˆè®¾ç½®30åˆ†é’Ÿè¿‡æœŸæ—¶é—´ï¼‰</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), </span><br><span class="line">        CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. è¿”å›ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-2"><p><strong>ShopServiceImplæ›´æ–°æ–¹æ³•ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(Shop shop)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> shop.getId();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. å‚æ•°æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºidä¸èƒ½ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">updated</span> <span class="operator">=</span> updateById(shop);</span><br><span class="line">    <span class="keyword">if</span> (!updated) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºæ›´æ–°å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ é™¤ç¼“å­˜ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. è¿”å›æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-3"><p><strong>ShopControllerï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/shop&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShop</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å•†æˆ·ï¼ˆå¸¦ç¼“å­˜ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> shopService.queryShopById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">updateShop</span><span class="params">(<span class="meta">@RequestBody</span> Shop shop)</span> &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°å•†æˆ·ï¼ˆä¿è¯ç¼“å­˜ä¸€è‡´æ€§ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> shopService.updateShop(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="æŸ¥è¯¢æ–¹æ³•ä¼˜åŒ–-4"><p><strong>æµ‹è¯•éªŒè¯ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æµ‹è¯•åœºæ™¯</th>
<th>é¢„æœŸç»“æœ</th>
<th>å®é™…éªŒè¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¦–æ¬¡æŸ¥è¯¢</td>
<td>æŸ¥è¯¢æ•°æ®åº“ï¼Œå†™å…¥ç¼“å­˜</td>
<td>âœ…</td>
</tr>
<tr>
<td>äºŒæ¬¡æŸ¥è¯¢</td>
<td>ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®</td>
<td>âœ…</td>
</tr>
<tr>
<td>æ•°æ®æ›´æ–°</td>
<td>æ›´æ–°æ•°æ®åº“ï¼Œåˆ é™¤ç¼“å­˜</td>
<td>âœ…</td>
</tr>
<tr>
<td>æ›´æ–°åæŸ¥è¯¢</td>
<td>é‡æ–°æŸ¥è¯¢æ•°æ®åº“ï¼Œå†™å…¥æ–°ç¼“å­˜</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ“ä½œç±»å‹</th>
<th>ç›´æ¥æ•°æ®åº“</th>
<th>å¸¦ç¼“å­˜</th>
<th>æ€§èƒ½æå‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>æŸ¥è¯¢æ“ä½œ</td>
<td>150ms</td>
<td>5ms</td>
<td><strong>30å€</strong></td>
</tr>
<tr>
<td>æ›´æ–°æ“ä½œ</td>
<td>50ms</td>
<td>55ms</td>
<td>åŸºæœ¬æŒå¹³</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653325871232.png" alt="1653325871232"></p>
<p><strong>ä»£ç åˆ†æï¼š</strong><br>
é€šè¿‡é‡‡ç”¨åˆ é™¤ç¼“å­˜ç­–ç•¥è§£å†³åŒå†™é—®é¢˜ï¼Œå½“æ•°æ®æ›´æ–°ååˆ é™¤ç¼“å­˜ï¼Œåç»­æŸ¥è¯¢ä¼šä»MySQLåŠ è½½æœ€æ–°æ•°æ®å¹¶é‡æ–°å†™å…¥ç¼“å­˜ï¼Œä»è€Œé¿å…æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653325929549.png" alt="1653325929549"></p>
<h3 id="2-5-ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³">2.5 ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³</h3>
<h4 id="2-5-1-ç¼“å­˜ç©¿é€é—®é¢˜åˆ†æ">2.5.1 ç¼“å­˜ç©¿é€é—®é¢˜åˆ†æ</h4>
<div class="note danger flat"><p><strong>ç¼“å­˜ç©¿é€å®šä¹‰</strong></p>
<p>å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œå¯¼è‡´ç¼“å­˜æ°¸è¿œæ— æ³•ç”Ÿæ•ˆï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œå¯èƒ½å¼•å‘æ•°æ®åº“å´©æºƒã€‚</p>
</div>
<p><strong>é—®é¢˜åœºæ™¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ID=99999çš„å•†å“</span><br><span class="line">    â†“</span><br><span class="line">æŸ¥è¯¢Redisç¼“å­˜ï¼ˆä¸å­˜åœ¨ï¼‰</span><br><span class="line">    â†“</span><br><span class="line">æŸ¥è¯¢MySQLæ•°æ®åº“ï¼ˆä¸å­˜åœ¨ï¼‰</span><br><span class="line">    â†“</span><br><span class="line">è¿”å›404é”™è¯¯</span><br><span class="line">    â†“</span><br><span class="line">å¤§é‡æ¶æ„è¯·æ±‚é‡å¤æ­¤è¿‡ç¨‹</span><br><span class="line">    â†“</span><br><span class="line">æ•°æ®åº“å‹åŠ›å‰§å¢ï¼Œå¯èƒ½å´©æºƒ</span><br></pre></td></tr></table></figure>
<p><strong>é£é™©ç‰¹å¾ï¼š</strong></p>
<ul>
<li>ğŸ”´ è¯·æ±‚çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨</li>
<li>ğŸ”´ ç¼“å­˜æ— æ³•å‘½ä¸­ï¼Œå¤±å»ä¿æŠ¤ä½œç”¨</li>
<li>ğŸ”´ å¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“</li>
<li>ğŸ”´ å¯èƒ½è¢«æ¶æ„åˆ©ç”¨è¿›è¡Œæ”»å‡»</li>
</ul>
<h4 id="2-5-2-è§£å†³æ–¹æ¡ˆå¯¹æ¯”">2.5.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</h4>
<p><strong>ä¸¤å¤§æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼š</strong></p>
<div class="tabs" id="ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ-1">ç¼“å­˜ç©ºå¯¹è±¡æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ-2">å¸ƒéš†è¿‡æ»¤å™¨æ–¹æ¡ˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ-1"><p><strong>å®ç°åŸç†</strong></p>
<p>å½“æ•°æ®åº“æŸ¥è¯¢ç»“æœä¸ºç©ºæ—¶ï¼Œä»å°†ç©ºç»“æœç¼“å­˜åˆ°Redisï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ã€‚</p>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ä¸ºç©º â†’ ç¼“å­˜ç©ºå€¼ â†’ è¿”å›ç»“æœ</span><br><span class="line">ä¸‹æ¬¡è¯·æ±‚ â†’ æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ï¼ˆç©ºå€¼ï¼‰â†’ ç›´æ¥è¿”å›ï¼Œä¸å†è®¿é—®æ•°æ®åº“</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;null&quot;</span>.equals(shopJson)) &#123;  <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç¼“å­˜çš„ç©ºå€¼</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜ç©ºå€¼ï¼Œè®¾ç½®2åˆ†é’Ÿè¿‡æœŸ</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼“å­˜æ­£å¸¸æ•°æ®</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–¹æ¡ˆè¯„ä¼°ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è¯„åˆ†</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>â­â­</td>
<td>ç®€å•ï¼Œå‡ è¡Œä»£ç å³å¯å®ç°</td>
</tr>
<tr>
<td>å†…å­˜æ¶ˆè€—</td>
<td>â­â­â­</td>
<td>éœ€è¦é¢å¤–å­˜å‚¨ç©ºå€¼ï¼Œä½†å¯è®¾ç½®çŸ­TTL</td>
</tr>
<tr>
<td>é˜²æŠ¤æ•ˆæœ</td>
<td>â­â­â­â­</td>
<td>æœ‰æ•ˆé˜»æ­¢é‡å¤æŸ¥è¯¢ä¸å­˜åœ¨æ•°æ®</td>
</tr>
<tr>
<td>æ•°æ®ä¸€è‡´æ€§</td>
<td>â­â­â­</td>
<td>å¯èƒ½å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ-2"><p><strong>å®ç°åŸç†</strong></p>
<p>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åœ¨æŸ¥è¯¢å‰è¿›è¡Œé¢„åˆ¤ï¼Œè¿‡æ»¤æ‰æ˜æ˜¾ä¸å­˜åœ¨çš„æ•°æ®è¯·æ±‚ã€‚</p>
<p><strong>æ•°æ®ç»“æ„ï¼š</strong></p>
<ul>
<li>åºå¤§çš„äºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆBitSetï¼‰</li>
<li>å¤šä¸ªå“ˆå¸Œå‡½æ•°</li>
<li>å†…å­˜å ç”¨æä½</li>
</ul>
<p><strong>å®ç°æµç¨‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ â†’ ä¸å­˜åœ¨ â†’ ç›´æ¥è¿”å›</span><br><span class="line">                â†“ å­˜åœ¨</span><br><span class="line">            æŸ¥è¯¢Redisç¼“å­˜ â†’ æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomFilterService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBloomFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å°†æ‰€æœ‰å•†å“IDæ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">        List&lt;Long&gt; allShopIds = shopMapper.selectAllIds();</span><br><span class="line">        <span class="keyword">for</span> (Long id : allShopIds) &#123;</span><br><span class="line">            addToBloomFilter(<span class="string">&quot;shop:bloom:&quot;</span>, id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToBloomFilter</span><span class="params">(String key, Long id)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] offset = getBitOffset(id);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : offset) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().setBit(key, i, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">mightExist</span><span class="params">(String key, Long id)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] offset = getBitOffset(id);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : offset) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!stringRedisTemplate.opsForValue().getBit(key, i)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// ä¸€å®šä¸å­˜åœ¨</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// å¯èƒ½å­˜åœ¨ï¼ˆå­˜åœ¨è¯¯åˆ¤ï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–¹æ¡ˆè¯„ä¼°ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>è¯„åˆ†</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>â­â­â­â­</td>
<td>éœ€è¦é¢å¤–ç»„ä»¶ï¼Œç®—æ³•å¤æ‚</td>
</tr>
<tr>
<td>å†…å­˜æ¶ˆè€—</td>
<td>â­â­â­â­â­</td>
<td>æä½çš„å†…å­˜å ç”¨</td>
</tr>
<tr>
<td>é˜²æŠ¤æ•ˆæœ</td>
<td>â­â­â­â­â­</td>
<td>å®Œç¾é˜»æ­¢ä¸å­˜åœ¨æ•°æ®æŸ¥è¯¢</td>
</tr>
<tr>
<td>è¯¯åˆ¤ç‡</td>
<td>â­â­</td>
<td>å­˜åœ¨è¯¯åˆ¤å¯èƒ½ï¼Œéœ€æƒè¡¡é…ç½®</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>æ–¹æ¡ˆé€‰æ‹©å»ºè®®ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ä¸šåŠ¡åœºæ™¯</th>
<th>æ¨èæ–¹æ¡ˆ</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸­å°å‹ç³»ç»Ÿ</td>
<td>ç¼“å­˜ç©ºå¯¹è±¡</td>
<td>å®ç°ç®€å•ï¼Œå¿«é€Ÿä¸Šçº¿</td>
</tr>
<tr>
<td>å¤§å‹é«˜å¹¶å‘ç³»ç»Ÿ</td>
<td>å¸ƒéš†è¿‡æ»¤å™¨</td>
<td>å†…å­˜ä¼˜åŒ–ï¼Œé˜²æŠ¤æ•ˆæœæ›´å¥½</td>
</tr>
<tr>
<td>æ•°æ®é‡å·¨å¤§</td>
<td>å¸ƒéš†è¿‡æ»¤å™¨</td>
<td>å†…å­˜å ç”¨ä¸æ•°æ®é‡æ— å…³</td>
</tr>
<tr>
<td>å¼€å‘èµ„æºæœ‰é™</td>
<td>ç¼“å­˜ç©ºå¯¹è±¡</td>
<td>ç»´æŠ¤æˆæœ¬ä½</td>
</tr>
</tbody>
</table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653326156516.png" alt="1653326156516"></p>
<h3 id="2-6-ç¼“å­˜ç©¿é€ç¼–ç å®ç°">2.6 ç¼“å­˜ç©¿é€ç¼–ç å®ç°</h3>
<h4 id="2-6-1-å®ç°æ€è·¯">2.6.1 å®ç°æ€è·¯</h4>
<div class="note warning flat"><p><strong>åŸå§‹é—®é¢˜</strong></p>
<p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œå¦‚æœå‘ç°æ•°æ®åœ¨MySQLä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›404ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œå¤§é‡è¯·æ±‚ç›´æ¥åˆ°è¾¾æ•°æ®åº“ã€‚</p>
</div>
<p><strong>ä¼˜åŒ–æ€è·¯ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸé€»è¾‘ï¼š</span><br><span class="line">æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ä¸ºç©º â†’ ç›´æ¥è¿”å›404 â†’ ç¼“å­˜ç©¿é€é£é™©</span><br><span class="line"></span><br><span class="line">æ–°é€»è¾‘ï¼š</span><br><span class="line">æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ä¸ºç©º â†’ ç¼“å­˜ç©ºå€¼ â†’ è¿”å›ç»“æœ â†’ ä¸‹æ¬¡ç›´æ¥å‘½ä¸­ç¼“å­˜</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-ä»£ç å®ç°">2.6.2 ä»£ç å®ç°</h4>
<div class="tabs" id="ç¼“å­˜ç©¿é€å®ç°"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#ç¼“å­˜ç©¿é€å®ç°-1">å®Œæ•´å®ç°</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ç©¿é€å®ç°-2">å·¥å…·æ–¹æ³•</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ç©¿é€å®ç°-3">æµ‹è¯•éªŒè¯</button></li><li class="tab"><button type="button" data-href="#ç¼“å­˜ç©¿é€å®ç°-4">é«˜çº§ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="ç¼“å­˜ç©¿é€å®ç°-1"><p><strong>ShopServiceImplç¼“å­˜ç©¿é€é˜²æŠ¤ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. å‚æ•°æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºIDéæ³•ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ä»RedisæŸ¥è¯¢å•†æˆ·ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ¤æ–­ç¼“å­˜æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="comment">// 4. å‘½ä¸­ç¼“å­˜ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºnullå€¼ï¼ˆç¼“å­˜ç©¿é€é˜²æŠ¤ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;null&quot;</span>.equals(shopJson)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5. æ­£å¸¸æ•°æ®ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. æ•°æ®åº“ä¸å­˜åœ¨ï¼ˆç¼“å­˜ç©¿é€é˜²æŠ¤ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 8. ç¼“å­˜ç©ºå€¼ï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼ˆ2åˆ†é’Ÿï¼‰</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 9. æ•°æ®åº“å­˜åœ¨ï¼Œå†™å…¥Redisç¼“å­˜</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), </span><br><span class="line">        CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 10. è¿”å›ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ç©¿é€å®ç°-2"><p><strong>ç¼“å­˜ç©¿é€é˜²æŠ¤å·¥å…·ç±»ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePenetrationProtection</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®‰å…¨çš„ç¼“å­˜æŸ¥è¯¢æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key ç¼“å­˜key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type è¿”å›ç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dbFallback æ•°æ®åº“æŸ¥è¯¢å‡½æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttl è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit æ—¶é—´å•ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æŸ¥è¯¢ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">safeQuery</span><span class="params">(String key, Class&lt;T&gt; type, </span></span><br><span class="line"><span class="params">                          Supplier&lt;T&gt; dbFallback, </span></span><br><span class="line"><span class="params">                          Long ttl, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å‘½ä¸­ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;null&quot;</span>.equals(json)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;  <span class="comment">// ç¼“å­˜çš„ç©ºå€¼</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> dbFallback.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ç¼“å­˜ç»“æœï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, <span class="number">2</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(result), ttl, unit);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ç©¿é€å®ç°-3"><p><strong>é˜²æŠ¤æ•ˆæœæµ‹è¯•ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æµ‹è¯•åœºæ™¯</th>
<th>è¯·æ±‚å‚æ•°</th>
<th>é¢„æœŸç»“æœ</th>
<th>æ•°æ®åº“è®¿é—®æ¬¡æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ­£å¸¸æŸ¥è¯¢</td>
<td>id=1</td>
<td>è¿”å›åº—é“ºä¿¡æ¯</td>
<td>1æ¬¡</td>
</tr>
<tr>
<td>ä¸å­˜åœ¨æŸ¥è¯¢</td>
<td>id=99999</td>
<td>è¿”å›&quot;åº—é“ºä¸å­˜åœ¨&quot;</td>
<td>1æ¬¡</td>
</tr>
<tr>
<td>é‡å¤ä¸å­˜åœ¨æŸ¥è¯¢</td>
<td>id=99999</td>
<td>è¿”å›&quot;åº—é“ºä¸å­˜åœ¨&quot;</td>
<td>0æ¬¡ï¼ˆå‘½ä¸­ç¼“å­˜ç©ºå€¼ï¼‰</td>
</tr>
<tr>
<td>éæ³•å‚æ•°</td>
<td>id=-1</td>
<td>è¿”å›&quot;åº—é“ºIDéæ³•&quot;</td>
<td>0æ¬¡ï¼ˆå‚æ•°æ ¡éªŒæ‹¦æˆªï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æŸ¥è¯¢ç±»å‹</th>
<th>æ— é˜²æŠ¤QPS</th>
<th>æœ‰é˜²æŠ¤QPS</th>
<th>æ•°æ®åº“å‹åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸å­˜åœ¨æ•°æ®æŸ¥è¯¢</td>
<td>1000ï¼ˆå…¨éƒ¨æ‰“åˆ°DBï¼‰</td>
<td>10000+ï¼ˆç¼“å­˜æ‹¦æˆªï¼‰</td>
<td>é™ä½90%+</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="ç¼“å­˜ç©¿é€å®ç°-4"><p><strong>å¤šé‡é˜²æŠ¤ç­–ç•¥ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/shop&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShop</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> String idStr)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å‚æ•°æ ¼å¼æ ¡éªŒï¼ˆç¬¬ä¸€å±‚é˜²æŠ¤ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!idStr.matches(<span class="string">&quot;\\d+&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºIDæ ¼å¼é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> Long.valueOf(idStr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. IDèŒƒå›´æ ¡éªŒï¼ˆç¬¬äºŒå±‚é˜²æŠ¤ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">1000000</span>) &#123;  <span class="comment">// å‡è®¾æœ€å¤§IDä¸º100ä¸‡</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºIDè¶…å‡ºèŒƒå›´ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è°ƒç”¨å¸¦ç¼“å­˜ç©¿é€é˜²æŠ¤çš„Serviceæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> shopService.queryShopById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653327124561.png" alt="1653327124561"></p>
<h4 id="2-6-3-æ€»ç»“ä¸æœ€ä½³å®è·µ">2.6.3 æ€»ç»“ä¸æœ€ä½³å®è·µ</h4>
<p><strong>ç¼“å­˜ç©¿é€äº§ç”ŸåŸå› ï¼š</strong></p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨</li>
<li>å¤§é‡è¯·æ±‚ä¸æ–­å‘èµ·ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆå®Œæ•´æ¸…å•ï¼š</strong></p>
<table>
<thead>
<tr>
<th>é˜²æŠ¤å±‚çº§</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
<th>å®ç°å¤æ‚åº¦</th>
<th>é˜²æŠ¤æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>åº”ç”¨å±‚</td>
<td>å‚æ•°æ ¼å¼æ ¡éªŒ</td>
<td>â­</td>
<td>åŸºç¡€é˜²æŠ¤</td>
</tr>
<tr>
<td>åº”ç”¨å±‚</td>
<td>IDèŒƒå›´é™åˆ¶</td>
<td>â­â­</td>
<td>ä¸­çº§é˜²æŠ¤</td>
</tr>
<tr>
<td>ç¼“å­˜å±‚</td>
<td>ç¼“å­˜ç©ºå¯¹è±¡</td>
<td>â­â­â­</td>
<td>æ ¸å¿ƒé˜²æŠ¤</td>
</tr>
<tr>
<td>æ¶æ„å±‚</td>
<td>å¸ƒéš†è¿‡æ»¤å™¨</td>
<td>â­â­â­â­â­</td>
<td>é«˜çº§é˜²æŠ¤</td>
</tr>
<tr>
<td>ç³»ç»Ÿå±‚</td>
<td>é™æµç†”æ–­</td>
<td>â­â­â­â­</td>
<td>å…œåº•é˜²æŠ¤</td>
</tr>
</tbody>
</table>
<p><strong>æ¨èç»„åˆï¼š</strong></p>
<ul>
<li>ä¸­å°å‹ç³»ç»Ÿï¼šå‚æ•°æ ¡éªŒ + ç¼“å­˜ç©ºå¯¹è±¡</li>
<li>å¤§å‹ç³»ç»Ÿï¼šå‚æ•°æ ¡éªŒ + å¸ƒéš†è¿‡æ»¤å™¨ + ç¼“å­˜ç©ºå¯¹è±¡</li>
<li>è¶…é«˜å¹¶å‘ï¼šå…¨éƒ¨æ–¹æ¡ˆç»„åˆä½¿ç”¨</li>
</ul>
<h3 id="2-7-ç¼“å­˜é›ªå´©é—®é¢˜è§£å†³">2.7 ç¼“å­˜é›ªå´©é—®é¢˜è§£å†³</h3>
<h4 id="2-7-1-ç¼“å­˜é›ªå´©é—®é¢˜åˆ†æ">2.7.1 ç¼“å­˜é›ªå´©é—®é¢˜åˆ†æ</h4>
<div class="note danger flat"><p><strong>ç¼“å­˜é›ªå´©</strong>ï¼šåœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç›´æ¥åˆ°è¾¾æ•°æ®åº“ï¼Œå¯èƒ½ç¬é—´å‹å®æ•°æ®åº“ï¼Œé€ æˆç³»ç»Ÿçº§æ•…éšœã€‚</p>
</div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653327884526.png" alt="1653327884526"><br>
<strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ ç¼“å­˜å¤±æ•ˆ â†’ è¯·æ±‚æ•°æ®åº“ â†’ æ•°æ®åº“å‹åŠ›è¿‡å¤§ â†’ æ•°æ®åº“å´©æºƒ â†’ æœåŠ¡ä¸å¯ç”¨</span><br></pre></td></tr></table></figure>
<p><strong>é£é™©ç‰¹å¾</strong>ï¼š</p>
<ul>
<li>çªå‘æ€§ï¼šå¤§é‡keyåœ¨åŒä¸€æ—¶é—´å¤±æ•ˆ</li>
<li>çº§è”æ€§ï¼šç¼“å­˜å¤±æ•ˆâ†’æ•°æ®åº“å‹åŠ›â†’ç³»ç»Ÿå´©æºƒ</li>
<li>æ¢å¤éš¾ï¼šç³»ç»Ÿæ¢å¤åå¯èƒ½å†æ¬¡é›ªå´©</li>
</ul>
<h4 id="2-7-2-è§£å†³æ–¹æ¡ˆå¯¹æ¯”">2.7.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</h4>
<div class="tabs" id="cache-avalanche"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cache-avalanche-1">è¿‡æœŸæ—¶é—´éšæœºåŒ–</button></li><li class="tab"><button type="button" data-href="#cache-avalanche-2">Redisé›†ç¾¤é«˜å¯ç”¨</button></li><li class="tab"><button type="button" data-href="#cache-avalanche-3">é™çº§é™æµç­–ç•¥</button></li><li class="tab"><button type="button" data-href="#cache-avalanche-4">å¤šçº§ç¼“å­˜æ¶æ„</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cache-avalanche-1"><p><strong>è¿‡æœŸæ—¶é—´éšæœºåŒ–</strong></p>
<p><strong>å®ç°åŸç†</strong>ï¼š<br>
åœ¨åŸºç¡€TTLä¸Šæ·»åŠ éšæœºå€¼ï¼Œåˆ†æ•£keyçš„è¿‡æœŸæ—¶é—´</p>
<p><strong>ä»£ç å®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸTTLä¸º30åˆ†é’Ÿ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">baseTtl</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"><span class="comment">// æ·»åŠ éšæœºå€¼ï¼ŒèŒƒå›´Â±5åˆ†é’Ÿ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">randomTtl</span> <span class="operator">=</span> baseTtl + ThreadLocalRandom.current().nextInt(-<span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line">stringRedisTemplate.opsForValue().set(key, value, randomTtl, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>å®ç°ç®€å•ï¼Œæˆæœ¬ä½</li>
<li>èƒ½æœ‰æ•ˆåˆ†æ•£è¿‡æœŸæ—¶é—´</li>
<li>å¯¹ä¸šåŠ¡æ— ä¾µå…¥</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>æ— æ³•åº”å¯¹Rediså®•æœº</li>
<li>éšæœºèŒƒå›´éœ€è¦åˆç†è®¾ç½®</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
é€‚åˆå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ï¼Œä½œä¸ºåŸºç¡€é˜²æŠ¤æ‰‹æ®µ</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-avalanche-2"><p><strong>Redisé›†ç¾¤é«˜å¯ç”¨</strong></p>
<p><strong>å®ç°åŸç†</strong>ï¼š<br>
é€šè¿‡ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼æé«˜Rediså¯ç”¨æ€§</p>
<p><strong>æ¶æ„å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å¯ç”¨æ€§</th>
<th>æ•°æ®å®‰å…¨</th>
<th>å¤æ‚åº¦</th>
<th>æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>ä¸»ä»å¤åˆ¶</td>
<td>â˜…â˜…â˜†</td>
<td>â˜…â˜…â˜†</td>
<td>â˜…â˜†â˜†</td>
<td>ä½</td>
</tr>
<tr>
<td>å“¨å…µæ¨¡å¼</td>
<td>â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜†</td>
<td>â˜…â˜…â˜†</td>
<td>ä¸­</td>
</tr>
<tr>
<td>Redis Cluster</td>
<td>â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜…</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<p><strong>é…ç½®ç¤ºä¾‹</strong>ï¼ˆå“¨å…µæ¨¡å¼ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sentinel.conf</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line">sentinel failover-timeout mymaster 10000</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æä¾›æ•…éšœè‡ªåŠ¨è½¬ç§»</li>
<li>æ•°æ®å®‰å…¨æ€§é«˜</li>
<li>æœåŠ¡å¯ç”¨æ€§å¼º</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>æ¶æ„å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜</li>
<li>éœ€è¦æ›´å¤šèµ„æºæŠ•å…¥</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
å¯¹å¯ç”¨æ€§è¦æ±‚é«˜çš„æ ¸å¿ƒä¸šåŠ¡</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-avalanche-3"><p><strong>é™çº§é™æµç­–ç•¥</strong></p>
<p><strong>å®ç°åŸç†</strong>ï¼š<br>
åœ¨ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œé€šè¿‡é™çº§å’Œé™æµä¿æŠ¤æ•°æ®åº“</p>
<p><strong>é™çº§ç­–ç•¥</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;getShop&quot;, </span></span><br><span class="line"><span class="meta">    blockHandler = &quot;handleBlock&quot;, </span></span><br><span class="line"><span class="meta">    fallback = &quot;handleFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">getShop</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// æ­£å¸¸ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> shopService.getById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æµå¤„ç†</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">handleBlock</span><span class="params">(Long id, BlockException ex)</span> &#123;</span><br><span class="line">    log.warn(<span class="string">&quot;æ¥å£è¢«é™æµ: &#123;&#125;&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> getDefaultShop(id); <span class="comment">// è¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜æ•°æ®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™çº§å¤„ç†</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">handleFallback</span><span class="params">(Long id, Throwable ex)</span> &#123;</span><br><span class="line">    log.error(<span class="string">&quot;æ¥å£é™çº§: &#123;&#125;&quot;</span>, id, ex);</span><br><span class="line">    <span class="keyword">return</span> getDefaultShop(id); <span class="comment">// è¿”å›å…œåº•æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é™æµç®—æ³•</strong>ï¼š</p>
<ul>
<li>ä»¤ç‰Œæ¡¶ç®—æ³•ï¼šå¹³æ»‘æµé‡</li>
<li>æ¼æ¡¶ç®—æ³•ï¼šå›ºå®šé€Ÿç‡å¤„ç†</li>
<li>è®¡æ•°å™¨ç®—æ³•ï¼šç®€å•ç›´æ¥</li>
</ul>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§</li>
<li>æä¾›ç”¨æˆ·ä½“éªŒé™çº§æ–¹æ¡ˆ</li>
<li>çµæ´»é…ç½®</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>å¯èƒ½æŸå¤±éƒ¨åˆ†åŠŸèƒ½</li>
<li>éœ€è¦åˆç†è®¾ç½®é˜ˆå€¼</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
é«˜å¹¶å‘ã€å¤§æ•°æ®é‡åœºæ™¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-avalanche-4"><p><strong>å¤šçº§ç¼“å­˜æ¶æ„</strong></p>
<p><strong>æ¶æ„è®¾è®¡</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ CDNç¼“å­˜ â†’ Nginxç¼“å­˜ â†’ æœ¬åœ°ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“</span><br></pre></td></tr></table></figure>
<p><strong>å®ç°æ–¹æ¡ˆ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç¼“å­˜å±‚çº§</th>
<th>æŠ€æœ¯é€‰å‹</th>
<th>å“åº”æ—¶é—´</th>
<th>å®¹é‡</th>
<th>æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>CDNç¼“å­˜</td>
<td>CloudFlare/é˜¿é‡Œäº‘CDN</td>
<td>10-50ms</td>
<td>å·¨å¤§</td>
<td>é«˜</td>
</tr>
<tr>
<td>Nginxç¼“å­˜</td>
<td>proxy_cache</td>
<td>1-5ms</td>
<td>ä¸­ç­‰</td>
<td>ä½</td>
</tr>
<tr>
<td>æœ¬åœ°ç¼“å­˜</td>
<td>Caffeine/Guava</td>
<td>0.1-1ms</td>
<td>å°</td>
<td>æä½</td>
</tr>
<tr>
<td>Redisç¼“å­˜</td>
<td>Redis Cluster</td>
<td>1-10ms</td>
<td>å¤§</td>
<td>ä¸­</td>
</tr>
</tbody>
</table>
<p><strong>æœ¬åœ°ç¼“å­˜å®ç°</strong>ï¼ˆCaffeineï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ¬åœ°ç¼“å­˜é…ç½®</span></span><br><span class="line">LoadingCache&lt;String, Shop&gt; localCache = Caffeine.newBuilder()</span><br><span class="line">    .maximumSize(<span class="number">10000</span>)</span><br><span class="line">    .expireAfterWrite(<span class="number">5</span>, TimeUnit.MINUTES)</span><br><span class="line">    .build(key -&gt; &#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜æœªå‘½ä¸­æ—¶ä»RedisåŠ è½½</span></span><br><span class="line">        <span class="keyword">return</span> getFromRedis(key);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryShop</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¼˜å…ˆæŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">return</span> localCache.get(CACHE_SHOP_KEY + id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>å¤šå±‚æ¬¡ä¿æŠ¤ï¼Œå®¹é”™æ€§å¼º</li>
<li>å“åº”é€Ÿåº¦å¿«ï¼Œç”¨æˆ·ä½“éªŒå¥½</li>
<li>å„å±‚ç¼“å­˜äº’è¡¥</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>æ¶æ„å¤æ‚ï¼Œå®ç°éš¾åº¦å¤§</li>
<li>æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜</li>
<li>è¿ç»´æˆæœ¬é«˜</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
å¤§å‹äº’è”ç½‘åº”ç”¨ï¼Œå¯¹æ€§èƒ½å’Œå¯ç”¨æ€§è¦æ±‚æé«˜</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-7-3-æœ€ä½³å®è·µæ–¹æ¡ˆ">2.7.3 æœ€ä½³å®è·µæ–¹æ¡ˆ</h4>
<div class="note success flat"><p><strong>æ¨èæ–¹æ¡ˆ</strong>ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ– + Redisé›†ç¾¤ + æœ¬åœ°ç¼“å­˜</p>
</div>
<p><strong>æ–¹æ¡ˆç»„åˆ</strong>ï¼š</p>
<ol>
<li><strong>åŸºç¡€å±‚</strong>ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ–ï¼ˆå¿…åšï¼‰</li>
<li><strong>å¯ç”¨å±‚</strong>ï¼šRediså“¨å…µæ¨¡å¼æˆ–Clusterï¼ˆæ¨èï¼‰</li>
<li><strong>åŠ é€Ÿå±‚</strong>ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeine/Guavaï¼‰</li>
<li><strong>ä¿æŠ¤å±‚</strong>ï¼šé™çº§é™æµï¼ˆSentinelï¼‰</li>
</ol>
<p><strong>å®æ–½æ­¥éª¤</strong>ï¼š</p>
<ol>
<li>ä¸ºæ‰€æœ‰ç¼“å­˜keyæ·»åŠ éšæœºTTL</li>
<li>éƒ¨ç½²Rediså“¨å…µæ¨¡å¼</li>
<li>é›†æˆæœ¬åœ°ç¼“å­˜æ¡†æ¶</li>
<li>é…ç½®é™æµé™çº§è§„åˆ™</li>
<li>ç›‘æ§å’Œå‘Šè­¦è®¾ç½®</li>
</ol>
<p><strong>æ•ˆæœé¢„æœŸ</strong>ï¼š</p>
<ul>
<li>ç¼“å­˜é›ªå´©æ¦‚ç‡é™ä½90%+</li>
<li>ç³»ç»Ÿå¯ç”¨æ€§è¾¾åˆ°99.9%+</li>
<li>å“åº”æ—¶é—´æå‡50%+</li>
</ul>
<h3 id="2-8-ç¼“å­˜å‡»ç©¿é—®é¢˜è§£å†³">2.8 ç¼“å­˜å‡»ç©¿é—®é¢˜è§£å†³</h3>
<h4 id="2-8-1-ç¼“å­˜å‡»ç©¿é—®é¢˜åˆ†æ">2.8.1 ç¼“å­˜å‡»ç©¿é—®é¢˜åˆ†æ</h4>
<div class="note danger flat"><p><strong>ç¼“å­˜å‡»ç©¿</strong>ï¼šä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆï¼Œæ— æ•°è¯·æ±‚ç¬é—´åˆ°è¾¾æ•°æ®åº“ï¼Œå¯èƒ½é€ æˆæ•°æ®åº“å´©æºƒã€‚</p>
</div>
<p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">é«˜å¹¶å‘è¯·æ±‚ â†’ çƒ­ç‚¹keyå¤±æ•ˆ â†’ å¤§é‡è¯·æ±‚æ•°æ®åº“ â†’ æ•°æ®åº“å‹åŠ›æ¿€å¢ â†’ æ•°æ®åº“å´©æºƒ</span><br></pre></td></tr></table></figure>
<p><strong>ä¸ç¼“å­˜ç©¿é€çš„åŒºåˆ«</strong>ï¼š</p>
<ul>
<li>ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®</li>
<li>ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyçªç„¶å¤±æ•ˆ</li>
<li>ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶å¤±æ•ˆ</li>
</ul>
<h4 id="2-8-2-è§£å†³æ–¹æ¡ˆå¯¹æ¯”">2.8.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</h4>
<div class="tabs" id="cache-breakdown"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cache-breakdown-1">äº’æ–¥é”æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#cache-breakdown-2">é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cache-breakdown-1"><p><strong>äº’æ–¥é”æ–¹æ¡ˆ</strong></p>
<p><strong>å®ç°åŸç†</strong>ï¼š<br>
é€šè¿‡åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653328288627.png" alt="1653328288627"><br>
<strong>æµç¨‹å›¾</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚1ï¼šè·å–é” â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ é‡å»ºç¼“å­˜ â†’ é‡Šæ”¾é” â†’ è¿”å›æ•°æ®</span><br><span class="line">è¯·æ±‚2ï¼šç­‰å¾…é” â†’ ä»ç¼“å­˜è·å– â†’ è¿”å›æ•°æ®</span><br><span class="line">è¯·æ±‚3ï¼šç­‰å¾…é” â†’ ä»ç¼“å­˜è·å– â†’ è¿”å›æ•°æ®</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç å®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="comment">// 3. è·å–é”å¤±è´¥ï¼Œä¼‘çœ é‡è¯•</span></span><br><span class="line">        Thread.sleep(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">return</span> queryWithMutex(id); <span class="comment">// é€’å½’é‡è¯•</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 4. è·å–é”æˆåŠŸï¼Œå†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼ˆdouble checkï¼‰</span></span><br><span class="line">        shopJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é˜²æ­¢ç¼“å­˜ç©¿é€</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 6. é‡Šæ”¾é”</span></span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æ•°æ®ä¸€è‡´æ€§å¼º</li>
<li>å®ç°ç›¸å¯¹ç®€å•</li>
<li>æ— é¢å¤–å†…å­˜å¼€é”€</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>æ€§èƒ½æŸè€—ï¼ˆä¸²è¡ŒåŒ–ï¼‰</li>
<li>å­˜åœ¨æ­»é”é£é™©</li>
<li>ç”¨æˆ·ä½“éªŒå·®ï¼ˆç­‰å¾…ï¼‰</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡åœºæ™¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-breakdown-2"><p><strong>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</strong></p>
<p><strong>å®ç°åŸç†</strong>ï¼š<br>
ä¸è®¾ç½®Redisè¿‡æœŸæ—¶é—´ï¼Œåœ¨valueä¸­å­˜å‚¨é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå¼‚æ­¥é‡å»ºç¼“å­˜<br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653328663897.png" alt="1653328663897"><br>
<strong>æµç¨‹å›¾</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚1ï¼šå‘ç°è¿‡æœŸ â†’ è·å–é” â†’ è¿”å›æ—§æ•°æ® + å¼‚æ­¥é‡å»º</span><br><span class="line">è¯·æ±‚2ï¼šå‘ç°è¿‡æœŸ â†’ ç­‰å¾…é” â†’ è¿”å›æ—§æ•°æ®</span><br><span class="line">è¯·æ±‚3ï¼šå‘ç°é‡å»ºå®Œæˆ â†’ è¿”å›æ–°æ•°æ®</span><br></pre></td></tr></table></figure>
<p><strong>æ•°æ®ç»“æ„è®¾è®¡</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;  <span class="comment">// é€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> Object data;                 <span class="comment">// å®é™…æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç å®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// ç¼“å­˜æœªå‘½ä¸­ç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ååºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// 3.1 æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.2 å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">        <span class="comment">// 4. è·å–é”æˆåŠŸï¼Œå¼‚æ­¥é‡å»ºç¼“å­˜</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// é‡å»ºç¼“å­˜</span></span><br><span class="line">                saveShop2Redis(id, <span class="number">20L</span>); <span class="comment">// 20åˆ†é’Ÿé€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ç¼“å­˜é‡å»ºå¤±è´¥&quot;</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. è¿”å›æ—§æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveShop2Redis</span><span class="params">(Long id, Long expireSeconds)</span> &#123;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°è£…é€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†™å…¥Redisï¼ˆä¸è®¾TTLï¼‰</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>æ€§èƒ½ä¼˜ç§€ï¼ˆæ— éœ€ç­‰å¾…ï¼‰</li>
<li>ç”¨æˆ·ä½“éªŒå¥½ï¼ˆç«‹å³å“åº”ï¼‰</li>
<li>æ— æ­»é”é£é™©</li>
</ul>
<p><strong>åŠ£åŠ¿</strong>ï¼š</p>
<ul>
<li>æ•°æ®ä¸€è‡´æ€§å¼±ï¼ˆå¯èƒ½è¿”å›è„æ•°æ®ï¼‰</li>
<li>å®ç°å¤æ‚</li>
<li>å ç”¨é¢å¤–å†…å­˜</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<br>
å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œèƒ½å®¹å¿çŸ­æš‚æ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-8-3-æ–¹æ¡ˆé€‰æ‹©å»ºè®®">2.8.3 æ–¹æ¡ˆé€‰æ‹©å»ºè®®</h4>
<div class="note success flat"><p><strong>é€‰æ‹©å»ºè®®</strong>ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯å’Œæ•°æ®ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ</p>
</div>
<p><strong>å¯¹æ¯”åˆ†æ</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>äº’æ–¥é”æ–¹æ¡ˆ</th>
<th>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®ä¸€è‡´æ€§</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
</tr>
<tr>
<td>æ€§èƒ½è¡¨ç°</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
<td>â˜…â˜…â˜…â˜…â˜†</td>
</tr>
<tr>
<td>ç”¨æˆ·ä½“éªŒ</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
</tr>
<tr>
<td>æ­»é”é£é™©</td>
<td>å­˜åœ¨</td>
<td>ä¸å­˜åœ¨</td>
</tr>
</tbody>
</table>
<p><strong>ä¸šåŠ¡åœºæ™¯æ¨è</strong>ï¼š</p>
<ul>
<li><strong>é‡‘èæ”¯ä»˜</strong>ï¼šäº’æ–¥é”æ–¹æ¡ˆï¼ˆå¼ºä¸€è‡´æ€§ï¼‰</li>
<li><strong>å•†å“è¯¦æƒ…</strong>ï¼šé€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼ˆé«˜æ€§èƒ½ï¼‰</li>
<li><strong>ç”¨æˆ·èµ„æ–™</strong>ï¼šäº’æ–¥é”æ–¹æ¡ˆï¼ˆæ•°æ®é‡è¦ï¼‰</li>
<li><strong>æ–°é—»èµ„è®¯</strong>ï¼šé€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼ˆå®¹å¿å»¶è¿Ÿï¼‰</li>
</ul>
<p><strong>æ··åˆç­–ç•¥</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryShop</span><span class="params">(Long id, <span class="type">boolean</span> requireConsistency)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (requireConsistency) &#123;</span><br><span class="line">        <span class="keyword">return</span> queryWithMutex(id);      <span class="comment">// å¼ºä¸€è‡´æ€§åœºæ™¯</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> queryWithLogicalExpire(id); <span class="comment">// é«˜æ€§èƒ½åœºæ™¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-9-äº’æ–¥é”æ–¹æ¡ˆå®ç°">2.9 äº’æ–¥é”æ–¹æ¡ˆå®ç°</h3>
<h4 id="2-9-1-å®ç°æ€è·¯">2.9.1 å®ç°æ€è·¯</h4>
<div class="note primary flat"><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šåœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶ï¼Œé€šè¿‡åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…é”é‡Šæ”¾åé‡è¯•ï¼Œé¿å…å¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ã€‚</p>
</div>
<p><strong>å®ç°æµç¨‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢ç¼“å­˜ â†’ ç¼“å­˜æœªå‘½ä¸­ â†’ è·å–äº’æ–¥é” â†’ å†æ¬¡æ£€æŸ¥ç¼“å­˜ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ é‡å»ºç¼“å­˜ â†’ é‡Šæ”¾é”</span><br></pre></td></tr></table></figure>
<p><strong>è®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>åŒé‡æ£€æŸ¥</strong>ï¼šè·å–é”åå†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤æŸ¥è¯¢æ•°æ®åº“</li>
<li><strong>é”è¶…æ—¶</strong>ï¼šè®¾ç½®åˆç†çš„é”è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šç¡®ä¿é”æœ€ç»ˆèƒ½è¢«é‡Šæ”¾</li>
<li><strong>é‡è¯•æœºåˆ¶</strong>ï¼šè·å–é”å¤±è´¥æ—¶é€‚å½“ä¼‘çœ åé‡è¯•</li>
</ul>
<h4 id="2-9-2-ä»£ç å®ç°">2.9.2 ä»£ç å®ç°</h4>
<div class="tabs" id="mutex-implementation"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mutex-implementation-1">å·¥å…·ç±»å°è£…</button></li><li class="tab"><button type="button" data-href="#mutex-implementation-2">Serviceå±‚å®ç°</button></li><li class="tab"><button type="button" data-href="#mutex-implementation-3">Controllerå±‚è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#mutex-implementation-4">æµ‹è¯•éªŒè¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mutex-implementation-1"><p><strong>åˆ†å¸ƒå¼é”å·¥å…·ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisLockUtil</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">DEFAULT_TIMEOUT</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">// é»˜è®¤é”è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–åˆ†å¸ƒå¼é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key, <span class="type">long</span> timeout)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_PREFIX + key;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .setIfAbsent(lockKey, Thread.currentThread().getId() + <span class="string">&quot;&quot;</span>, timeout, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾åˆ†å¸ƒå¼é”ï¼ˆå®‰å…¨é‡Šæ”¾ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_PREFIX + key;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰çº¿ç¨‹ID</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId() + <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(lockKey);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç¡®ä¿é‡Šæ”¾çš„æ˜¯è‡ªå·±æŒæœ‰çš„é”</span></span><br><span class="line">            <span class="keyword">if</span> (threadId.equals(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> BooleanUtil.isTrue(stringRedisTemplate.delete(lockKey));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;é‡Šæ”¾é”å¤±è´¥: &#123;&#125;&quot;</span>, lockKey, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”å¹¶é‡è¯•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLockWithRetry</span><span class="params">(String key, <span class="type">long</span> timeout, <span class="type">int</span> maxRetry, <span class="type">long</span> retryInterval)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; maxRetry; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tryLock(key, timeout)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; maxRetry - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(retryInterval);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mutex-implementation-2"><p><strong>Serviceå±‚å®Œæ•´å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="keyword">implements</span> <span class="title class_">IShopService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisLockUtil redisLockUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;cache:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;lock:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">CACHE_SHOP_TTL</span> <span class="operator">=</span> <span class="number">30L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">CACHE_NULL_TTL</span> <span class="operator">=</span> <span class="number">2L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç¼“å­˜å‘½ä¸­ä¸”ä¸ä¸ºç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;ç¼“å­˜å‘½ä¸­: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åˆ¤æ–­æ˜¯å¦ä¸ºç¼“å­˜ç©¿é€çš„ç©ºå€¼</span></span><br><span class="line">        <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å‘½ä¸­ç©ºå€¼ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ç¼“å­˜æœªå‘½ä¸­ï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 4.1 å°è¯•è·å–é”ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼Œé—´éš”50msï¼‰</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLockUtil.tryLockWithRetry(lockKey, <span class="number">10L</span>, <span class="number">3</span>, <span class="number">50L</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œè¿”å›å…œåº•æ•°æ®: &#123;&#125;&quot;</span>, lockKey);</span><br><span class="line">                <span class="keyword">return</span> getDefaultShop(id); <span class="comment">// è¿”å›å…œåº•æ•°æ®</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            log.debug(<span class="string">&quot;è·å–é”æˆåŠŸ: &#123;&#125;&quot;</span>, lockKey);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4.2 åŒé‡æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤æŸ¥è¯¢æ•°æ®åº“ï¼‰</span></span><br><span class="line">            shopJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åŒé‡æ£€æŸ¥å‘½ä¸­ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4.3 æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            log.debug(<span class="string">&quot;æŸ¥è¯¢æ•°æ®åº“: &#123;&#125;&quot;</span>, id);</span><br><span class="line">            shop = getById(id);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼ˆç¼“å­˜ç©¿é€å¤„ç†ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ•°æ®ä¸å­˜åœ¨ï¼Œå†™å…¥ç©ºå€¼ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. å†™å…¥ç¼“å­˜</span></span><br><span class="line">            log.debug(<span class="string">&quot;å†™å…¥ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æŸ¥è¯¢å•†æˆ·å¼‚å¸¸: &#123;&#125;&quot;</span>, id, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æŸ¥è¯¢å•†æˆ·å¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7. é‡Šæ”¾é”</span></span><br><span class="line">            redisLockUtil.unlock(lockKey);</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾é”: &#123;&#125;&quot;</span>, lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…œåº•æ•°æ®è·å–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Shop <span class="title function_">getDefaultShop</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// å¯ä»¥è¿”å›é»˜è®¤æ•°æ®æˆ–ä»å¤‡ç”¨æ•°æ®æºè·å–</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">defaultShop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shop</span>();</span><br><span class="line">        defaultShop.setId(id);</span><br><span class="line">        defaultShop.setName(<span class="string">&quot;é»˜è®¤å•†æˆ·&quot;</span>);</span><br><span class="line">        defaultShop.setTypeId(<span class="number">1L</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®å…¶ä»–é»˜è®¤å€¼...</span></span><br><span class="line">        <span class="keyword">return</span> defaultShop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mutex-implementation-3"><p><strong>Controllerå±‚è°ƒç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/shop&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;å•†æˆ·ç®¡ç†&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IShopService shopService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®IDæŸ¥è¯¢å•†æˆ·ï¼ˆäº’æ–¥é”æ–¹æ¡ˆï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;æ ¹æ®IDæŸ¥è¯¢å•†æˆ·&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShop</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span> || id &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;å•†æˆ·IDä¸èƒ½ä¸ºç©º&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨äº’æ–¥é”æŸ¥è¯¢</span></span><br><span class="line">            <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.queryWithMutex(id);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> Result.fail(<span class="string">&quot;å•†æˆ·ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æŸ¥è¯¢å•†æˆ·å¤±è´¥: &#123;&#125;&quot;</span>, id, e);</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;æŸ¥è¯¢å•†æˆ·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mutex-implementation-4"><p><strong>å¹¶å‘æµ‹è¯•éªŒè¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheBreakdownTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IShopService shopService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜å‡»ç©¿å¹¶å‘æµ‹è¯•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheBreakdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">shopId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threadCount</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// å¹¶å‘çº¿ç¨‹æ•°</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadCount);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">successCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">dbQueryCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…ˆæ¸…é™¤ç¼“å­˜ï¼Œæ¨¡æ‹Ÿç¼“å­˜å¤±æ•ˆåœºæ™¯</span></span><br><span class="line">        <span class="type">StringRedisTemplate</span> <span class="variable">stringRedisTemplate</span> <span class="operator">=</span> </span><br><span class="line">            SpringContextUtil.getBean(StringRedisTemplate.class);</span><br><span class="line">        stringRedisTemplate.delete(<span class="string">&quot;cache:shop:&quot;</span> + shopId);</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;å¼€å§‹å¹¶å‘æµ‹è¯•ï¼Œçº¿ç¨‹æ•°ï¼š&#123;&#125;ï¼Œå•†æˆ·IDï¼š&#123;&#125;&quot;</span>, threadCount, shopId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¹¶å‘æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.queryWithMutex(shopId);</span><br><span class="line">                    <span class="keyword">if</span> (shop != <span class="literal">null</span>) &#123;</span><br><span class="line">                        successCount.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;æŸ¥è¯¢å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;å¹¶å‘æµ‹è¯•å®Œæˆ&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;æ€»è€—æ—¶ï¼š&#123;&#125;ms&quot;</span>, (endTime - startTime));</span><br><span class="line">        log.info(<span class="string">&quot;æˆåŠŸæŸ¥è¯¢æ•°ï¼š&#123;&#125;&quot;</span>, successCount.get());</span><br><span class="line">        log.info(<span class="string">&quot;QPSï¼š&#123;&#125;&quot;</span>, threadCount * <span class="number">1000</span> / (endTime - startTime));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éªŒè¯ç¼“å­˜æ˜¯å¦å·²é‡å»º</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cachedData</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;cache:shop:&quot;</span> + shopId);</span><br><span class="line">        Assertions.assertNotNull(cachedData, <span class="string">&quot;ç¼“å­˜åº”è¯¥å·²é‡å»º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-9-3-æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ">2.9.3 æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ</h4>
<div class="note success flat"><p><strong>æ€§èƒ½è¡¨ç°</strong>ï¼šäº’æ–¥é”æ–¹æ¡ˆåœ¨å¹¶å‘æµ‹è¯•ä¸­è¡¨ç°ä¼˜å¼‚ï¼Œèƒ½æœ‰æ•ˆé˜²æ­¢ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
</div>
<p><strong>æµ‹è¯•å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å¹¶å‘æ•°</th>
<th>æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°</th>
<th>å¹³å‡å“åº”æ—¶é—´</th>
<th>æ•°æ®ä¸€è‡´æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— ä¿æŠ¤</td>
<td>100</td>
<td>100æ¬¡</td>
<td>50ms</td>
<td>ä¸ä¸€è‡´</td>
</tr>
<tr>
<td>äº’æ–¥é”</td>
<td>100</td>
<td>1æ¬¡</td>
<td>80ms</td>
<td>å¼ºä¸€è‡´</td>
</tr>
<tr>
<td>é€»è¾‘è¿‡æœŸ</td>
<td>100</td>
<td>1æ¬¡</td>
<td>10ms</td>
<td>æœ€ç»ˆä¸€è‡´</td>
</tr>
</tbody>
</table>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>é”ç²’åº¦æ§åˆ¶</strong>ï¼šæŒ‰ä¸šåŠ¡ç»´åº¦åŠ é”ï¼Œé¿å…å…¨å±€é”</li>
<li><strong>è¶…æ—¶è®¾ç½®</strong>ï¼šé”è¶…æ—¶æ—¶é—´è¦å¤§äºæ•°æ®åº“æŸ¥è¯¢æ—¶é—´</li>
<li><strong>é‡è¯•æœºåˆ¶</strong>ï¼šè·å–é”å¤±è´¥æ—¶è¦æœ‰é‡è¯•å’Œå…œåº•ç­–ç•¥</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç›‘æ§é”ç­‰å¾…æ—¶é—´å’Œè·å–æˆåŠŸç‡</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šç»“åˆæœ¬åœ°ç¼“å­˜å‡å°‘Redisè®¿é—®</li>
</ol>
<h3 id="2-10-é€»è¾‘è¿‡æœŸæ–¹æ¡ˆå®ç°">2.10 é€»è¾‘è¿‡æœŸæ–¹æ¡ˆå®ç°</h3>
<h4 id="2-10-1-å®ç°æ€è·¯">2.10.1 å®ç°æ€è·¯</h4>
<div class="note primary flat"><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šä¸è®¾ç½®Redisè¿‡æœŸæ—¶é—´ï¼Œåœ¨valueä¸­å­˜å‚¨é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œå½“æ•°æ®è¿‡æœŸæ—¶å¼‚æ­¥é‡å»ºç¼“å­˜ï¼Œç«‹å³è¿”å›æ—§æ•°æ®ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒã€‚</p>
</div>
<p><strong>å®ç°æµç¨‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢ç¼“å­˜ â†’ å‘½ä¸­æ•°æ® â†’ æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´ â†’ æœªè¿‡æœŸç›´æ¥è¿”å› â†’ è¿‡æœŸåˆ™å¼‚æ­¥é‡å»º â†’ è¿”å›æ—§æ•°æ®</span><br></pre></td></tr></table></figure>
<p><strong>è®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>å¼‚æ­¥é‡å»º</strong>ï¼šå¼€å¯ç‹¬ç«‹çº¿ç¨‹è¿›è¡Œç¼“å­˜é‡å»ºï¼Œä¸é˜»å¡ç”¨æˆ·è¯·æ±‚</li>
<li><strong>é€»è¾‘è¿‡æœŸ</strong>ï¼šåœ¨valueä¸­å­˜å‚¨è¿‡æœŸæ—¶é—´ï¼Œä¸ä¾èµ–Redis TTL</li>
<li><strong>é”æ§åˆ¶</strong>ï¼šé€šè¿‡åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œé‡å»º</li>
<li><strong>çº¿ç¨‹æ± ç®¡ç†</strong>ï¼šä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†å¼‚æ­¥ä»»åŠ¡ï¼Œé¿å…çº¿ç¨‹çˆ†ç‚¸</li>
</ul>
<h4 id="2-10-2-ä»£ç å®ç°">2.10.2 ä»£ç å®ç°</h4>
<div class="tabs" id="logical-expire-implementation"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#logical-expire-implementation-1">æ•°æ®æ¨¡å‹è®¾è®¡</button></li><li class="tab"><button type="button" data-href="#logical-expire-implementation-2">ç¼“å­˜é¢„çƒ­å·¥å…·</button></li><li class="tab"><button type="button" data-href="#logical-expire-implementation-3">Serviceå±‚å®ç°</button></li><li class="tab"><button type="button" data-href="#logical-expire-implementation-4">æµ‹è¯•éªŒè¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="logical-expire-implementation-1"><p><strong>é€»è¾‘è¿‡æœŸæ•°æ®æ¨¡å‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redisé€»è¾‘è¿‡æœŸæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®é™…ä¸šåŠ¡æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¿«é€Ÿæ„å»ºæ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RedisData <span class="title function_">of</span><span class="params">(Object data, Long expireSeconds)</span> &#123;</span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(data);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">        <span class="keyword">return</span> redisData;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expireTime.isBefore(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="logical-expire-implementation-2"><p><strong>ç¼“å­˜é¢„çƒ­å·¥å…·ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachePreheatUtil</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IShopService shopService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;cache:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">LOGICAL_EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">20L</span>; <span class="comment">// é€»è¾‘è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„çƒ­æŒ‡å®šå•†æˆ·æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preheatShop</span><span class="params">(Long shopId, Long expireSeconds)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + shopId;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.getById(shopId);</span><br><span class="line">            <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;å•†æˆ·ä¸å­˜åœ¨ï¼Œè·³è¿‡é¢„çƒ­: &#123;&#125;&quot;</span>, shopId);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°è£…é€»è¾‘è¿‡æœŸæ•°æ®</span></span><br><span class="line">            <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> RedisData.of(shop, expireSeconds);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†™å…¥Redisï¼ˆä¸è®¾TTLï¼‰</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;ç¼“å­˜é¢„çƒ­æˆåŠŸ: &#123;&#125;, è¿‡æœŸæ—¶é—´: &#123;&#125;ç§’&quot;</span>, key, expireSeconds);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç¼“å­˜é¢„çƒ­å¤±è´¥: &#123;&#125;&quot;</span>, shopId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡é¢„çƒ­çƒ­é—¨å•†æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preheatHotShops</span><span class="params">(List&lt;Long&gt; shopIds, Long expireSeconds)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;å¼€å§‹æ‰¹é‡é¢„çƒ­çƒ­é—¨å•†æˆ·ï¼Œæ•°é‡: &#123;&#125;&quot;</span>, shopIds.size());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Long shopId : shopIds) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                preheatShop(shopId, expireSeconds);</span><br><span class="line">                <span class="comment">// é€‚å½“ä¼‘çœ ï¼Œé¿å…å¯¹æ•°æ®åº“é€ æˆå‹åŠ›</span></span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;é¢„çƒ­å•†æˆ·å¤±è´¥: &#123;&#125;&quot;</span>, shopId, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;æ‰¹é‡é¢„çƒ­å®Œæˆ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="logical-expire-implementation-3"><p><strong>Serviceå±‚å®Œæ•´å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;ShopMapper, Shop&gt; <span class="keyword">implements</span> <span class="title class_">IShopService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisLockUtil redisLockUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHE_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;cache:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_SHOP_KEY</span> <span class="operator">=</span> <span class="string">&quot;lock:shop:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">LOGICAL_EXPIRE_TIME</span> <span class="operator">=</span> <span class="number">20L</span>; <span class="comment">// é€»è¾‘è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼“å­˜é‡å»ºçº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(</span><br><span class="line">        Runtime.getRuntime().availableProcessors(),</span><br><span class="line">        r -&gt; &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">            thread.setName(<span class="string">&quot;cache-rebuild-&quot;</span> + thread.getId());</span><br><span class="line">            thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€»è¾‘è¿‡æœŸæ–¹æ¡ˆè§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;ç¼“å­˜æœªå‘½ä¸­ï¼Œç›´æ¥è¿”å›null: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å‘½ä¸­ç¼“å­˜ï¼Œååºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!redisData.isExpired()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;ç¼“å­˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            <span class="keyword">return</span> shop;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ç¼“å­˜å·²è¿‡æœŸï¼Œéœ€è¦é‡å»º</span></span><br><span class="line">        log.debug(<span class="string">&quot;ç¼“å­˜å·²è¿‡æœŸï¼Œå¼€å§‹å¼‚æ­¥é‡å»º: &#123;&#125;&quot;</span>, key);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLockUtil.tryLock(lockKey, <span class="number">10L</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">            <span class="comment">// 5. è·å–é”æˆåŠŸï¼Œæäº¤å¼‚æ­¥é‡å»ºä»»åŠ¡</span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;å¼€å§‹å¼‚æ­¥é‡å»ºç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                    saveShop2Redis(id, LOGICAL_EXPIRE_TIME);</span><br><span class="line">                    log.info(<span class="string">&quot;å¼‚æ­¥é‡å»ºç¼“å­˜å®Œæˆ: &#123;&#125;&quot;</span>, key);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å¼‚æ­¥é‡å»ºç¼“å­˜å¤±è´¥: &#123;&#125;&quot;</span>, key, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    redisLockUtil.unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. è¿”å›æ—§æ•°æ®ï¼ˆæ— è®ºæ˜¯å¦è·å–åˆ°é”ï¼‰</span></span><br><span class="line">        log.debug(<span class="string">&quot;è¿”å›æ—§æ•°æ®: &#123;&#125;&quot;</span>, key);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜å•†æˆ·åˆ°Redisï¼ˆé€»è¾‘è¿‡æœŸï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveShop2Redis</span><span class="params">(Long id, Long expireSeconds)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">            <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">            <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;å•†æˆ·ä¸å­˜åœ¨ï¼Œè·³è¿‡ç¼“å­˜é‡å»º: &#123;&#125;&quot;</span>, id);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°è£…é€»è¾‘è¿‡æœŸæ•°æ®</span></span><br><span class="line">            <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> RedisData.of(shop, expireSeconds);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†™å…¥Redisï¼ˆä¸è®¾TTLï¼‰</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">            </span><br><span class="line">            log.debug(<span class="string">&quot;é€»è¾‘è¿‡æœŸç¼“å­˜é‡å»ºæˆåŠŸ: &#123;&#125;, è¿‡æœŸæ—¶é—´: &#123;&#125;ç§’&quot;</span>, key, expireSeconds);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;é€»è¾‘è¿‡æœŸç¼“å­˜é‡å»ºå¤±è´¥: &#123;&#125;&quot;</span>, id, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç¼“å­˜é‡å»ºå¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="logical-expire-implementation-4"><p><strong>å¹¶å‘æµ‹è¯•éªŒè¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogicalExpireTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IShopService shopService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CachePreheatUtil cachePreheatUtil;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€»è¾‘è¿‡æœŸæ–¹æ¡ˆæ€§èƒ½æµ‹è¯•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLogicalExpirePerformance</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">shopId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threadCount</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadCount);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">successCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">rebuildCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. é¢„çƒ­ç¼“å­˜ï¼ˆè®¾ç½®ä¸ºå·²è¿‡æœŸçŠ¶æ€ï¼‰</span></span><br><span class="line">        cachePreheatUtil.preheatShop(shopId, -<span class="number">1L</span>); <span class="comment">// è®¾ç½®è´Ÿå€¼ï¼Œè¡¨ç¤ºå·²è¿‡æœŸ</span></span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;å¼€å§‹é€»è¾‘è¿‡æœŸæ€§èƒ½æµ‹è¯•ï¼Œçº¿ç¨‹æ•°: &#123;&#125;ï¼Œå•†æˆ·ID: &#123;&#125;&quot;</span>, threadCount, shopId);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å¹¶å‘æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">threadStart</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.queryWithLogicalExpire(shopId);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">threadEnd</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (shop != <span class="literal">null</span>) &#123;</span><br><span class="line">                        successCount.incrementAndGet();</span><br><span class="line">                        log.debug(<span class="string">&quot;çº¿ç¨‹&#123;&#125;æŸ¥è¯¢æˆåŠŸï¼Œè€—æ—¶: &#123;&#125;ms&quot;</span>, Thread.currentThread().getId(), (threadEnd - threadStart));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;æŸ¥è¯¢å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        latch.await();</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ç­‰å¾…å¼‚æ­¥é‡å»ºå®Œæˆ</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. éªŒè¯ç»“æœ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cachedData</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;cache:shop:&quot;</span> + shopId);</span><br><span class="line">        Assertions.assertNotNull(cachedData, <span class="string">&quot;ç¼“å­˜åº”è¯¥å·²é‡å»º&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(cachedData, RedisData.class);</span><br><span class="line">        Assertions.assertFalse(redisData.isExpired(), <span class="string">&quot;é‡å»ºåçš„ç¼“å­˜åº”è¯¥æœªè¿‡æœŸ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;é€»è¾‘è¿‡æœŸæµ‹è¯•å®Œæˆ&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;æ€»è€—æ—¶: &#123;&#125;ms&quot;</span>, (endTime - startTime));</span><br><span class="line">        log.info(<span class="string">&quot;æˆåŠŸæŸ¥è¯¢æ•°: &#123;&#125;&quot;</span>, successCount.get());</span><br><span class="line">        log.info(<span class="string">&quot;QPS: &#123;&#125;&quot;</span>, threadCount * <span class="number">1000</span> / (endTime - startTime));</span><br><span class="line">        log.info(<span class="string">&quot;å¹³å‡å“åº”æ—¶é—´: &#123;&#125;ms&quot;</span>, (endTime - startTime) / threadCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµ‹è¯•ç¼“å­˜é‡å»ºè§¦å‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCacheRebuild</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">shopId</span> <span class="operator">=</span> <span class="number">2L</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. é¢„çƒ­ç¼“å­˜ï¼ˆè®¾ç½®ä¸ºå³å°†è¿‡æœŸï¼‰</span></span><br><span class="line">        cachePreheatUtil.preheatShop(shopId, <span class="number">1L</span>); <span class="comment">// 1ç§’åè¿‡æœŸ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç­‰å¾…ç¼“å­˜è¿‡æœŸ</span></span><br><span class="line">        Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è§¦å‘æŸ¥è¯¢ï¼ˆåº”è¯¥è§¦å‘å¼‚æ­¥é‡å»ºï¼‰</span></span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.queryWithLogicalExpire(shopId);</span><br><span class="line">        Assertions.assertNotNull(shop, <span class="string">&quot;åº”è¯¥è¿”å›æ—§æ•°æ®&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ç­‰å¾…å¼‚æ­¥é‡å»º</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. éªŒè¯é‡å»ºç»“æœ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cachedData</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;cache:shop:&quot;</span> + shopId);</span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(cachedData, RedisData.class);</span><br><span class="line">        </span><br><span class="line">        Assertions.assertFalse(redisData.isExpired(), <span class="string">&quot;ç¼“å­˜åº”è¯¥å·²é‡å»º&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;ç¼“å­˜é‡å»ºéªŒè¯æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-10-3-æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ">2.10.3 æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ</h4>
<div class="note success flat"><p><strong>æ€§èƒ½è¡¨ç°</strong>ï¼šé€»è¾‘è¿‡æœŸæ–¹æ¡ˆåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°ä¼˜å¼‚ï¼Œå¹³å‡å“åº”æ—¶é—´æ¯”äº’æ–¥é”æ–¹æ¡ˆæå‡80%+</p>
</div>
<p><strong>æ€§èƒ½å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>äº’æ–¥é”æ–¹æ¡ˆ</th>
<th>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</th>
<th>æå‡å¹…åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¹³å‡å“åº”æ—¶é—´</td>
<td>80ms</td>
<td>12ms</td>
<td>â†“85%</td>
</tr>
<tr>
<td>å¹¶å‘å¤„ç†èƒ½åŠ›</td>
<td>ä¸­ç­‰</td>
<td>ä¼˜ç§€</td>
<td>â†‘300%</td>
</tr>
<tr>
<td>æ•°æ®ä¸€è‡´æ€§</td>
<td>å¼ºä¸€è‡´</td>
<td>æœ€ç»ˆä¸€è‡´</td>
<td>-</td>
</tr>
<tr>
<td>ç”¨æˆ·ä½“éªŒ</td>
<td>æœ‰ç­‰å¾…</td>
<td>æ— ç­‰å¾…</td>
<td>â†‘100%</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>ç®€å•</td>
<td>å¤æ‚</td>
<td>-</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>ä½</td>
<td>é«˜</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ol>
<li><strong>é¢„çƒ­ç­–ç•¥</strong>ï¼šç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­çƒ­é—¨æ•°æ®ï¼Œé¿å…å†·å¯åŠ¨é—®é¢˜</li>
<li><strong>è¿‡æœŸæ—¶é—´</strong>ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è®¾ç½®åˆç†çš„é€»è¾‘è¿‡æœŸæ—¶é—´</li>
<li><strong>çº¿ç¨‹æ± é…ç½®</strong>ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆç†é…ç½®çº¿ç¨‹æ± å¤§å°</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œé‡å»ºé¢‘ç‡</li>
<li><strong>é™çº§ç­–ç•¥</strong>ï¼šå¼‚æ­¥é‡å»ºå¤±è´¥æ—¶è¦æœ‰é™çº§æ–¹æ¡ˆ</li>
</ol>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>è¯»å¤šå†™å°‘çš„ä¸šåŠ¡åœºæ™¯</li>
<li>å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åº”ç”¨</li>
<li>èƒ½å®¹å¿çŸ­æš‚æ•°æ®ä¸ä¸€è‡´çš„ä¸šåŠ¡</li>
<li>é«˜å¹¶å‘æŸ¥è¯¢çš„çƒ­ç‚¹æ•°æ®</li>
</ul>
<h3 id="2-11-Rediså·¥å…·ç±»å°è£…">2.11 Rediså·¥å…·ç±»å°è£…</h3>
<h4 id="2-11-1-éœ€æ±‚åˆ†æ">2.11.1 éœ€æ±‚åˆ†æ</h4>
<p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<div class="tabs" id="cache-client-requirements"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cache-client-requirements-1">åŸºç¡€åŠŸèƒ½</button></li><li class="tab"><button type="button" data-href="#cache-client-requirements-2">æŸ¥è¯¢åŠŸèƒ½</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cache-client-requirements-1"><p><strong>åŸºç¡€åŠŸèƒ½</strong></p>
<ul>
<li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li>
<li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-client-requirements-2"><p><strong>æŸ¥è¯¢åŠŸèƒ½</strong></p>
<ul>
<li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li>
<li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-11-2-ä»£ç å®ç°">2.11.2 ä»£ç å®ç°</h4>
<div class="tabs" id="cache-client-implementation"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cache-client-implementation-1">å·¥å…·ç±»å®Œæ•´å®ç°</button></li><li class="tab"><button type="button" data-href="#cache-client-implementation-2">é€»è¾‘è¿‡æœŸæŸ¥è¯¢</button></li><li class="tab"><button type="button" data-href="#cache-client-implementation-3">äº’æ–¥é”æŸ¥è¯¢</button></li><li class="tab"><button type="button" data-href="#cache-client-implementation-4">å·¥å…·æ–¹æ³•</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cache-client-implementation-1"><p><strong>CacheClientå·¥å…·ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®ç¼“å­˜ï¼ˆTTLè¿‡æœŸï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®ç¼“å­˜ï¼ˆé€»è¾‘è¿‡æœŸï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicalExpire</span><span class="params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢ç¼“å­˜ï¼ˆç¼“å­˜ç©¿é€ä¿æŠ¤ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R,ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(</span></span><br><span class="line"><span class="params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1.ä»redisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.ç¼“å­˜å‘½ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.å‘½ä¸­ç©ºå€¼ï¼ˆç¼“å­˜ç©¿é€ä¿æŠ¤ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.æ•°æ®åº“ä¸­ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6.æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œå†™å…¥ç¼“å­˜</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, unit);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-client-implementation-2"><p><strong>é€»è¾‘è¿‡æœŸæŸ¥è¯¢æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŸ¥è¯¢ç¼“å­˜ï¼ˆé€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(</span></span><br><span class="line"><span class="params">        String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.ä»redisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.å‘½ä¸­ï¼Œååºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="keyword">return</span> r; <span class="comment">// æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isLock) &#123;</span><br><span class="line">        <span class="comment">// 5.è·å–é”æˆåŠŸï¼Œå¼‚æ­¥é‡å»ºç¼“å­˜</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">newR</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                <span class="built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6.è¿”å›æ—§æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-client-implementation-3"><p><strong>äº’æ–¥é”æŸ¥è¯¢æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŸ¥è¯¢ç¼“å­˜ï¼ˆäº’æ–¥é”æ–¹æ¡ˆï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(</span></span><br><span class="line"><span class="params">        String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.ä»redisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, type);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.å‘½ä¸­ç©ºå€¼ï¼ˆç¼“å­˜ç©¿é€ä¿æŠ¤ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.å®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>); <span class="comment">// è·å–é”å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•</span></span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4.è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        r = dbFallback.apply(id);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.å†™å…¥ç¼“å­˜</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, unit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-client-implementation-4"><p><strong>é”å·¥å…·æ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–åˆ†å¸ƒå¼é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾åˆ†å¸ƒå¼é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-11-3-ä½¿ç”¨ç¤ºä¾‹">2.11.3 ä½¿ç”¨ç¤ºä¾‹</h4>
<div class="tabs" id="cache-client-usage"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cache-client-usage-1">Serviceå±‚è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#cache-client-usage-2">æ–¹æ¡ˆå¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cache-client-usage-1"><p><strong>ShopServiceImplä¸­çš„ä½¿ç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// è§£å†³ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient</span><br><span class="line">            .queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.class, <span class="built_in">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithMutex(CACHE_SHOP_KEY, id, Shop.class, this::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="comment">// Shop shop = cacheClient</span></span><br><span class="line">    <span class="comment">//         .queryWithLogicalExpire(CACHE_SHOP_KEY, id, Shop.class, this::getById, 20L, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cache-client-usage-2"><p><strong>ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¼“å­˜ç©¿é€ä¿æŠ¤</td>
<td>æ•°æ®ä¸å­˜åœ¨åœºæ™¯</td>
<td>å®ç°ç®€å•ï¼Œæœ‰æ•ˆé˜²æ­¢ç©¿é€</td>
<td>æœ‰çŸ­æš‚ç©ºå€¼ç¼“å­˜</td>
</tr>
<tr>
<td>äº’æ–¥é”æ–¹æ¡ˆ</td>
<td>å¼ºä¸€è‡´æ€§è¦æ±‚</td>
<td>æ•°æ®ä¸€è‡´æ€§å¼º</td>
<td>æ€§èƒ½è¾ƒå·®ï¼Œæœ‰ç­‰å¾…</td>
</tr>
<tr>
<td>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</td>
<td>é«˜æ€§èƒ½è¦æ±‚</td>
<td>æ€§èƒ½ä¼˜ç§€ï¼Œæ— ç­‰å¾…</td>
<td>å®ç°å¤æ‚ï¼Œå¯èƒ½è¿”å›æ—§æ•°æ®</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="2-11-4-æœ€ä½³å®è·µæ€»ç»“">2.11.4 æœ€ä½³å®è·µæ€»ç»“</h4>
<div class="note success flat"><p><strong>æ¨èä½¿ç”¨</strong>ï¼šCacheClientå·¥å…·ç±»å°è£…äº†ä¸‰ç§ç¼“å­˜ç­–ç•¥ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯çµæ´»é€‰æ‹©</p>
</div>
<p><strong>é€‰æ‹©å»ºè®®</strong>ï¼š</p>
<ol>
<li><strong>å¸¸è§„æŸ¥è¯¢</strong>ï¼šä¼˜å…ˆä½¿ç”¨<code>queryWithPassThrough</code>ï¼ˆç¼“å­˜ç©¿é€ä¿æŠ¤ï¼‰</li>
<li><strong>çƒ­ç‚¹æ•°æ®</strong>ï¼šä½¿ç”¨<code>queryWithLogicalExpire</code>ï¼ˆé€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼‰</li>
<li><strong>å…³é”®æ•°æ®</strong>ï¼šä½¿ç”¨<code>queryWithMutex</code>ï¼ˆäº’æ–¥é”æ–¹æ¡ˆï¼‰</li>
</ol>
<p><strong>ä½¿ç”¨ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>âœ… ä»£ç å¤ç”¨æ€§é«˜ï¼Œé¿å…é‡å¤å®ç°</li>
<li>âœ… ç­–ç•¥çµæ´»ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©</li>
<li>âœ… å°è£…å®Œå–„ï¼ŒåŒ…å«å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—</li>
<li>âœ… æ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æŒå¼‚æ­¥é‡å»ºå’ŒåŒé‡æ£€æŸ¥</li>
</ul>
<h2 id="3-ä¼˜æƒ åˆ¸ç§’æ€">3. ä¼˜æƒ åˆ¸ç§’æ€</h2>
<h3 id="3-1-rediså®ç°å…¨å±€å”¯ä¸€ID">3.1 rediså®ç°å…¨å±€å”¯ä¸€ID</h3>
<h4 id="3-1-1-å…¨å±€å”¯ä¸€IDç”Ÿæˆ">3.1.1 å…¨å±€å”¯ä¸€IDç”Ÿæˆ</h4>
<p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œå½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¡¨ä¸­ã€‚</p>
<div class="tabs" id="id-requirement-analysis"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#id-requirement-analysis-1">é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#id-requirement-analysis-2">è§£å†³æ–¹æ¡ˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="id-requirement-analysis-1"><p><strong>æ•°æ®åº“è‡ªå¢IDå­˜åœ¨çš„é—®é¢˜</strong></p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>æè¿°</th>
<th>å½±å“</th>
</tr>
</thead>
<tbody>
<tr>
<td>è§„å¾‹æ€§æ˜æ˜¾</td>
<td>IDæŒ‰é¡ºåºé€’å¢ï¼Œå®¹æ˜“è¢«çŒœæµ‹</td>
<td>æ³„éœ²ä¸šåŠ¡æ•°æ®</td>
</tr>
<tr>
<td>å•è¡¨é™åˆ¶</td>
<td>MySQLå•è¡¨å®¹é‡ä¸å®œè¶…è¿‡500W</td>
<td>åˆ¶çº¦ä¸šåŠ¡æ‰©å±•</td>
</tr>
<tr>
<td>åˆ†åº“åˆ†è¡¨å›°éš¾</td>
<td>åˆ†å¸ƒå¼ç¯å¢ƒä¸‹IDå†²çª</td>
<td>ç³»ç»Ÿå¤æ‚åº¦å¢åŠ </td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="id-requirement-analysis-2"><p><strong>å…¨å±€IDç”Ÿæˆå™¨è¦æ±‚</strong></p>
<div class="note primary flat"><p>å…¨å±€IDç”Ÿæˆå™¨æ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·</p>
</div>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¦æ±‚</th>
<th>å®ç°æ€è·¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>å”¯ä¸€æ€§</td>
<td>å…¨å±€å”¯ä¸€</td>
<td>æ—¶é—´æˆ³+åºåˆ—å·</td>
</tr>
<tr>
<td>é«˜å¯ç”¨</td>
<td>99.99%å¯ç”¨</td>
<td>Redisé›†ç¾¤</td>
</tr>
<tr>
<td>é«˜æ€§èƒ½</td>
<td>10W+QPS</td>
<td>å†…å­˜æ“ä½œ</td>
</tr>
<tr>
<td>é€’å¢æ€§</td>
<td>è¶‹åŠ¿é€’å¢</td>
<td>æ—¶é—´æˆ³ä¿è¯</td>
</tr>
<tr>
<td>å®‰å…¨æ€§</td>
<td>æ— è§„åˆ™</td>
<td>æ‹¼æ¥éšæœºä½</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>IDç»“æ„è®¾è®¡</strong></p>
<div class="note info flat"><p><strong>IDç»„æˆç»“æ„</strong>ï¼šç¬¦å·ä½ + æ—¶é—´æˆ³ + åºåˆ—å·ï¼Œæ€»è®¡64ä½</p>
</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€ç¬¦å·ä½â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€æ—¶é—´æˆ³â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€åºåˆ—å·â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚    1bit   â”‚      31bit       â”‚      32bit       â”‚</span><br><span class="line">â”‚    æ°¸è¿œ0   â”‚  ç§’çº§æ—¶é—´æˆ³(69å¹´)  â”‚  ç§’å†…è®¡æ•°å™¨(2^32)  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>
<p><strong>è®¾è®¡ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>âœ… <strong>ç¬¦å·ä½</strong>ï¼š1bitï¼Œæ°¸è¿œä¸º0ï¼Œä¿è¯IDä¸ºæ­£æ•°</li>
<li>âœ… <strong>æ—¶é—´æˆ³</strong>ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li>
<li>âœ… <strong>åºåˆ—å·</strong>ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</li>
<li>âœ… <strong>å®‰å…¨æ€§</strong>ï¼šä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢æ•°å€¼ï¼Œé¿å…æ³„éœ²ä¸šåŠ¡é‡</li>
</ul>
<h4 id="3-1-2-Rediså®ç°æ–¹æ¡ˆ">3.1.2 Rediså®ç°æ–¹æ¡ˆ</h4>
<div class="tabs" id="redis-id-implementation"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redis-id-implementation-1">æ ¸å¿ƒä»£ç </button></li><li class="tab"><button type="button" data-href="#redis-id-implementation-2">ä»£ç è§£æ</button></li><li class="tab"><button type="button" data-href="#redis-id-implementation-3">æµ‹è¯•éªŒè¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redis-id-implementation-1"><p><strong>RedisIdWorkerå·¥å…·ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹æ—¶é—´æˆ³ - 2022-01-01 00:00:00</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆå…¨å±€å”¯ä¸€ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPrefix ä¸šåŠ¡å‰ç¼€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å…¨å±€å”¯ä¸€ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. ç”Ÿæˆåºåˆ—å· - Redisè‡ªå¢</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">                .increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-id-implementation-2"><p><strong>å®ç°åŸç†è§£æ</strong></p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ“ä½œ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ç”Ÿæˆæ—¶é—´æˆ³</td>
<td>å½“å‰æ—¶é—´ - èµ·å§‹æ—¶é—´(2022-01-01)</td>
</tr>
<tr>
<td>2</td>
<td>ç”Ÿæˆåºåˆ—å·</td>
<td>Redisè‡ªå¢ï¼ŒæŒ‰å¤©åˆ†ç»„é¿å…æº¢å‡º</td>
</tr>
<tr>
<td>3</td>
<td>ä½è¿ç®—æ‹¼æ¥</td>
<td><code>timestamp &lt;&lt; 32 | count</code></td>
</tr>
</tbody>
</table>
<p><strong>å…³é”®è®¾è®¡</strong>ï¼š</p>
<ul>
<li>âœ… <strong>æ—¶é—´æˆ³åŸºå‡†</strong>ï¼šä½¿ç”¨2022-01-01ä½œä¸ºèµ·å§‹æ—¶é—´ï¼Œæ”¯æŒ69å¹´ä½¿ç”¨æœŸ</li>
<li>âœ… <strong>æŒ‰å¤©åˆ†ç‰‡</strong>ï¼šRedis keyåŒ…å«æ—¥æœŸï¼Œé¿å…è‡ªå¢æ•°å€¼è¿‡å¤§</li>
<li>âœ… <strong>ä½è¿ç®—ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ä½ç§»å’Œæˆ–è¿ç®—å¿«é€Ÿæ‹¼æ¥ID</li>
<li>âœ… <strong>çº¿ç¨‹å®‰å…¨</strong>ï¼šRedisè‡ªå¢æ“ä½œä¿è¯å¹¶å‘å®‰å…¨</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-id-implementation-3"><p><strong>æ€§èƒ½æµ‹è¯•ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testIdWorker</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">300</span>);</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;id = &quot;</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 300ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ç”Ÿæˆ100ä¸ªID</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">300</span>; i++) &#123;</span><br><span class="line">        es.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.await();</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;time = &quot;</span> + (end - begin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æµ‹è¯•ç»“æœ</strong>ï¼š</p>
<ul>
<li>ğŸš€ <strong>ç”Ÿæˆé€Ÿåº¦</strong>ï¼š3ä¸‡ä¸ªIDä»…éœ€å‡ ç™¾æ¯«ç§’</li>
<li>ğŸš€ <strong>å¹¶å‘å®‰å…¨</strong>ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ— é‡å¤ID</li>
<li>ğŸš€ <strong>è¶‹åŠ¿é€’å¢</strong>ï¼šIDæ•´ä½“å‘ˆé€’å¢è¶‹åŠ¿</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="3-1-3-æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“">3.1.3 æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“</h4>
<div class="note success flat"><p><strong>Redisæ–¹æ¡ˆ vs å…¶ä»–æ–¹æ¡ˆ</strong></p>
</div>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°å¤æ‚åº¦</th>
<th>æ€§èƒ½</th>
<th>å¯ç”¨æ€§</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Redisæ–¹æ¡ˆ</strong></td>
<td>â­â­ ç®€å•</td>
<td>â­â­â­â­â­ 10W+QPS</td>
<td>â­â­â­â­ ä¸»ä»æ¶æ„</td>
<td>ä¸­å°å‹ç³»ç»Ÿ</td>
</tr>
<tr>
<td><strong>é›ªèŠ±ç®—æ³•</strong></td>
<td>â­â­â­ ä¸­ç­‰</td>
<td>â­â­â­â­â­ æ›´é«˜</td>
<td>â­â­ ä¾èµ–æ—¶é’Ÿ</td>
<td>å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td><strong>æ•°æ®åº“è‡ªå¢</strong></td>
<td>â­ æœ€ç®€å•</td>
<td>â­â­ åƒçº§QPS</td>
<td>â­â­ å•ç‚¹æ•…éšœ</td>
<td>å•æœºç³»ç»Ÿ</td>
</tr>
<tr>
<td><strong>UUID</strong></td>
<td>â­ ç®€å•</td>
<td>â­â­â­ ä¸­ç­‰</td>
<td>â­â­â­â­â­ å®Œå…¨åˆ†å¸ƒå¼</td>
<td>å¯¹é¡ºåºæ— è¦æ±‚åœºæ™¯</td>
</tr>
</tbody>
</table>
<h3 id="3-2-ä¼˜æƒ åˆ¸ç®¡ç†">3.2 ä¼˜æƒ åˆ¸ç®¡ç†</h3>
<h4 id="3-2-1-ä¼˜æƒ åˆ¸ç±»å‹è®¾è®¡">3.2.1 ä¼˜æƒ åˆ¸ç±»å‹è®¾è®¡</h4>
<div class="tabs" id="voucher-types"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#voucher-types-1">ä¸šåŠ¡åœºæ™¯</button></li><li class="tab"><button type="button" data-href="#voucher-types-2">æ•°æ®æ¨¡å‹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="voucher-types-1"><p><strong>ä¼˜æƒ åˆ¸ä¸šåŠ¡æ¨¡å‹</strong></p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç‰¹ç‚¹</th>
<th>ä½¿ç”¨åœºæ™¯</th>
<th>è¡¨ç»“æ„</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ™®é€šåˆ¸</strong></td>
<td>ä¼˜æƒ åŠ›åº¦å°ï¼Œä»»æ„é¢†å–</td>
<td>æ—¥å¸¸ä¿ƒé”€</td>
<td>tb_voucher</td>
</tr>
<tr>
<td><strong>ç§’æ€åˆ¸</strong></td>
<td>ä¼˜æƒ åŠ›åº¦å¤§ï¼Œé™æ—¶é™é‡</td>
<td>å¼•æµè·å®¢</td>
<td>tb_voucher + tb_seckill_voucher</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="voucher-types-2"><p><strong>è¡¨ç»“æ„è®¾è®¡</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸åŸºç¡€ä¿¡æ¯è¡¨</span></span><br><span class="line">tb_voucher (</span><br><span class="line">    id <span class="type">bigint</span> <span class="keyword">PRIMARY KEY</span>,          <span class="comment">-- ä¼˜æƒ åˆ¸ID</span></span><br><span class="line">    shop_id <span class="type">bigint</span>,                 <span class="comment">-- å•†é“ºID</span></span><br><span class="line">    title <span class="type">varchar</span>(<span class="number">255</span>),             <span class="comment">-- ä¼˜æƒ åˆ¸æ ‡é¢˜</span></span><br><span class="line">    sub_title <span class="type">varchar</span>(<span class="number">255</span>),         <span class="comment">-- å‰¯æ ‡é¢˜</span></span><br><span class="line">    rules <span class="type">varchar</span>(<span class="number">1024</span>),            <span class="comment">-- ä½¿ç”¨è§„åˆ™</span></span><br><span class="line">    pay_value <span class="type">bigint</span>,               <span class="comment">-- æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰</span></span><br><span class="line">    actual_value <span class="type">bigint</span>,            <span class="comment">-- æŠµæ‰£é‡‘é¢ï¼ˆåˆ†ï¼‰</span></span><br><span class="line">    type tinyint,                   <span class="comment">-- ç±»å‹ï¼š1-æ™®é€šåˆ¸ï¼Œ2-ç§’æ€åˆ¸</span></span><br><span class="line">    status tinyint,                 <span class="comment">-- çŠ¶æ€ï¼š1-ä¸Šæ¶ï¼Œ2-ä¸‹æ¶ï¼Œ3-è¿‡æœŸ</span></span><br><span class="line">    create_time datetime,           <span class="comment">-- åˆ›å»ºæ—¶é—´</span></span><br><span class="line">    update_time datetime            <span class="comment">-- æ›´æ–°æ—¶é—´</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç§’æ€ä¼˜æƒ åˆ¸æ‰©å±•è¡¨</span></span><br><span class="line">tb_seckill_voucher (</span><br><span class="line">    voucher_id <span class="type">bigint</span> <span class="keyword">PRIMARY KEY</span>,  <span class="comment">-- ä¼˜æƒ åˆ¸ID</span></span><br><span class="line">    stock <span class="type">int</span>,                      <span class="comment">-- åº“å­˜</span></span><br><span class="line">    create_time datetime,           <span class="comment">-- åˆ›å»ºæ—¶é—´</span></span><br><span class="line">    begin_time datetime,            <span class="comment">-- å¼€å§‹æŠ¢è´­æ—¶é—´</span></span><br><span class="line">    end_time datetime               <span class="comment">-- ç»“æŸæŠ¢è´­æ—¶é—´</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="3-2-2-ä¼˜æƒ åˆ¸å‘å¸ƒå®ç°">3.2.2 ä¼˜æƒ åˆ¸å‘å¸ƒå®ç°</h4>
<div class="tabs" id="voucher-implementation"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#voucher-implementation-1">æ™®é€šåˆ¸å‘å¸ƒ</button></li><li class="tab"><button type="button" data-href="#voucher-implementation-2">ç§’æ€åˆ¸å‘å¸ƒ</button></li><li class="tab"><button type="button" data-href="#voucher-implementation-3">å‰ç«¯è°ƒç”¨æœåŠ¡</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="voucher-implementation-1"><p><strong>Controllerå±‚æ¥å£</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢æ™®é€šåˆ¸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> voucher ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.save(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="voucher-implementation-2"><p><strong>Controllerå±‚æ¥å£</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢ç§’æ€åˆ¸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> voucher ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼ŒåŒ…å«ç§’æ€ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">addSeckillVoucher</span><span class="params">(<span class="meta">@RequestBody</span> Voucher voucher)</span> &#123;</span><br><span class="line">    voucherService.addSeckillVoucher(voucher);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(voucher.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Serviceå±‚å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ä¿å­˜ä¼˜æƒ åˆ¸åŸºç¡€ä¿¡æ¯</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ä¿å­˜ç§’æ€æ‰©å±•ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åŒæ­¥åº“å­˜åˆ°Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue()</span><br><span class="line">        .set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è®¾è®¡è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… <strong>äº‹åŠ¡æ§åˆ¶</strong>ï¼šä½¿ç”¨<code>@Transactional</code>ä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
<li>âœ… <strong>RedisåŒæ­¥</strong>ï¼šå°†åº“å­˜ä¿¡æ¯ç¼“å­˜åˆ°Redisï¼Œæå‡æŸ¥è¯¢æ€§èƒ½</li>
<li>âœ… <strong>æ—¶é—´çª—å£</strong>ï¼šè®¾ç½®ç§’æ€å¼€å§‹å’Œç»“æŸæ—¶é—´</li>
<li>âœ… <strong>åº“å­˜éš”ç¦»</strong>ï¼šç§’æ€åˆ¸æœ‰ç‹¬ç«‹åº“å­˜ç®¡ç†</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="voucher-implementation-3"><p><strong>ç”¨POSTMANæ¨¡æ‹Ÿå‘é€è¯·æ±‚æ¥æ–°å¢ç§’æ€åˆ¸ï¼Œè¯·æ±‚è·¯å¾„http://localhost:8081/voucher/seckillï¼Œ è¯·æ±‚æ–¹å¼POSTï¼ŒJSONæ•°æ®å¦‚ä¸‹</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shopId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subTitle&quot;</span><span class="punctuation">:</span><span class="string">&quot;å‘¨ä¸€è‡³å‘¨äº”å¯ç”¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="string">&quot;å…¨åœºé€šç”¨\\næ— éœ€é¢„çº¦\\nå¯æ— é™å åŠ &quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payValue&quot;</span><span class="punctuation">:</span><span class="number">8000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actualValue&quot;</span><span class="punctuation">:</span><span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beginTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-01-01T00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-10-31T23:59:59&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="3-3-ç§’æ€ä¸‹å•å®ç°">3.3 ç§’æ€ä¸‹å•å®ç°</h3>
<h4 id="3-3-1-ä¸šåŠ¡éœ€æ±‚åˆ†æ">3.3.1 ä¸šåŠ¡éœ€æ±‚åˆ†æ</h4>
<div class="tabs" id="seckill-requirement"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#seckill-requirement-1">ä¸šåŠ¡æµç¨‹</button></li><li class="tab"><button type="button" data-href="#seckill-requirement-2">å‰ç½®æ¡ä»¶</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="seckill-requirement-1"><p><strong>ç§’æ€ä¸‹å•æ ¸å¿ƒé€»è¾‘</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[ç”¨æˆ·ç‚¹å‡»æŠ¢è´­] --&gt; B[æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯]</span><br><span class="line">    B --&gt; C&#123;ç§’æ€æ˜¯å¦å¼€å§‹?&#125;</span><br><span class="line">    C --&gt;|æœªå¼€å§‹| D[è¿”å›å¤±è´¥:ç§’æ€å°šæœªå¼€å§‹]</span><br><span class="line">    C --&gt;|å·²å¼€å§‹| E&#123;ç§’æ€æ˜¯å¦ç»“æŸ?&#125;</span><br><span class="line">    E --&gt;|å·²ç»“æŸ| F[è¿”å›å¤±è´¥:ç§’æ€å·²ç»“æŸ]</span><br><span class="line">    E --&gt;|è¿›è¡Œä¸­| G&#123;åº“å­˜æ˜¯å¦å……è¶³?&#125;</span><br><span class="line">    G --&gt;|ä¸è¶³| H[è¿”å›å¤±è´¥:åº“å­˜ä¸è¶³]</span><br><span class="line">    G --&gt;|å……è¶³| I[æ‰£å‡åº“å­˜]</span><br><span class="line">    I --&gt; J[åˆ›å»ºè®¢å•]</span><br><span class="line">    J --&gt; K[è¿”å›è®¢å•ID]</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="seckill-requirement-2"><p><strong>ä¸‹å•æ ¡éªŒè§„åˆ™</strong></p>
<table>
<thead>
<tr>
<th>æ ¡éªŒé¡¹</th>
<th>åˆ¤æ–­æ¡ä»¶</th>
<th>å¤±è´¥æç¤º</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç§’æ€æ—¶é—´</td>
<td>beginTime &gt; å½“å‰æ—¶é—´</td>
<td>ç§’æ€å°šæœªå¼€å§‹ï¼</td>
</tr>
<tr>
<td>ç§’æ€æ—¶é—´</td>
<td>endTime &lt; å½“å‰æ—¶é—´</td>
<td>ç§’æ€å·²ç»“æŸï¼</td>
</tr>
<tr>
<td>åº“å­˜æ£€æŸ¥</td>
<td>stock &lt; 1</td>
<td>åº“å­˜ä¸è¶³ï¼</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="3-3-2-åŸºç¡€å®ç°æ–¹æ¡ˆ">3.3.2 åŸºç¡€å®ç°æ–¹æ¡ˆ</h4>
<div class="tabs" id="seckill-basic"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#seckill-basic-1">controllerå±‚è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#seckill-basic-2">Service</button></li><li class="tab"><button type="button" data-href="#seckill-basic-3">Serviceå±‚å®ç°</button></li><li class="tab"><button type="button" data-href="#seckill-basic-4">é—®é¢˜åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="seckill-basic-1"><p><strong>VoucherController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/voucher-order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService voucherOrderService;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/seckill/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long voucherId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> voucherOrderService.seckillVoucher(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="seckill-basic-2"><p><strong>VoucherOrderService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IVoucherOrderService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;VoucherOrder&gt; &#123;</span><br><span class="line">    Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="seckill-basic-3"><p><strong>VoucherOrderServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .update();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1 è®¢å•ID</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2 ç”¨æˆ·ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3 ä»£é‡‘åˆ¸ID</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. ä¿å­˜è®¢å•</span></span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. è¿”å›è®¢å•ID</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="seckill-basic-4"><p><strong>å½“å‰æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜</strong></p>
<div class="note warning flat"><p><strong>é«˜å¹¶å‘ä¸‹çš„é—®é¢˜åˆ†æ</strong></p>
</div>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ç°è±¡</th>
<th>åŸå› </th>
<th>å½±å“</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>è¶…å–é—®é¢˜</strong></td>
<td>åº“å­˜ä¸ºè´Ÿ</td>
<td>å¹¶å‘æ‰£å‡åº“å­˜</td>
<td>å•†å®¶æŸå¤±</td>
</tr>
<tr>
<td><strong>é‡å¤ä¸‹å•</strong></td>
<td>åŒä¸€ç”¨æˆ·å¤šå•</td>
<td>å¹¶å‘åˆ›å»ºè®¢å•</td>
<td>ç”¨æˆ·ä½“éªŒå·®</td>
</tr>
<tr>
<td><strong>æ€§èƒ½ç“¶é¢ˆ</strong></td>
<td>å“åº”æ…¢</td>
<td>æ•°æ®åº“å‹åŠ›å¤§</td>
<td>ç³»ç»Ÿå´©æºƒ</td>
</tr>
</tbody>
</table>
<p><strong>é—®é¢˜æ ¹å› </strong>ï¼š</p>
<ul>
<li>âŒ <strong>æ— å¹¶å‘æ§åˆ¶</strong>ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰£å‡åº“å­˜</li>
<li>âŒ <strong>æ— å¹‚ç­‰ä¿éšœ</strong>ï¼šåŒä¸€ç”¨æˆ·å¯é‡å¤ä¸‹å•</li>
<li>âŒ <strong>æ•°æ®åº“å‹åŠ›å¤§</strong>ï¼šæ‰€æœ‰æ“ä½œéƒ½èµ°æ•°æ®åº“</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="3-4-åº“å­˜è¶…å–é—®é¢˜åˆ†æ">3.4 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</h3>
<div class="tabs" id="oversell-analysis"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#oversell-analysis-1">é—®é¢˜å¤ç°</button></li><li class="tab"><button type="button" data-href="#oversell-analysis-2">è§£å†³æ–¹æ¡ˆå¯¹æ¯”</button></li><li class="tab"><button type="button" data-href="#oversell-analysis-3">ä¹è§‚é”ä¼˜åŒ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="oversell-analysis-1"><p><strong>å¹¶å‘åœºæ™¯ä¸‹çš„è¶…å–é—®é¢˜</strong></p>
<p>å‡è®¾åº“å­˜ä¸º1ï¼ŒåŒæ—¶æœ‰100ä¸ªçº¿ç¨‹å¹¶å‘ä¸‹å•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´ç‚¹ | çº¿ç¨‹1 | çº¿ç¨‹2 | çº¿ç¨‹3 | ... | åº“å­˜</span><br><span class="line">-------|-------|-------|-------|-----|-----</span><br><span class="line">t1     | æŸ¥è¯¢åº“å­˜=1 | æŸ¥è¯¢åº“å­˜=1 | æŸ¥è¯¢åº“å­˜=1 | ... | 1</span><br><span class="line">t2     | åˆ¤æ–­åº“å­˜&gt;0âœ… | åˆ¤æ–­åº“å­˜&gt;0âœ… | åˆ¤æ–­åº“å­˜&gt;0âœ… | ... | 1</span><br><span class="line">t3     | æ‰£å‡åº“å­˜ | æ‰£å‡åº“å­˜ | æ‰£å‡åº“å­˜ | ... | 1â†’0â†’-1â†’-2...</span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜æœ¬è´¨</strong>ï¼š</p>
<ul>
<li>âŒ <strong>è¯»-æ”¹-å†™</strong>æ“ä½œéåŸå­æ€§</li>
<li>âŒ <strong>å¹¶å‘æ§åˆ¶ç¼ºå¤±</strong>å¯¼è‡´æ•°æ®ç«äº‰</li>
<li>âŒ <strong>åº“å­˜æ ¡éªŒ</strong>ä¸<strong>åº“å­˜æ‰£å‡</strong>åˆ†ç¦»</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="oversell-analysis-2"><p><strong>æ‚²è§‚é” vs ä¹è§‚é”</strong></p>
<div class="note info flat"><p><strong>æ‚²è§‚é”</strong>ï¼šå‡å®šä¼šå‘ç”Ÿå¹¶å‘å†²çªï¼Œå±è”½ä¸€åˆ‡å¯èƒ½è¿åæ•°æ®å®Œæ•´æ€§çš„æ“ä½œ</p>
</div>
<div class="note info flat"><p><strong>ä¹è§‚é”</strong>ï¼šè®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å†å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹</p>
</div>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>å®ç°æ–¹å¼</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ‚²è§‚é”</strong></td>
<td><code>synchronized</code>/<code>ReentrantLock</code></td>
<td>ç®€å•æ˜“ç†è§£</td>
<td>æ€§èƒ½å·®ï¼Œé˜»å¡ä¸¥é‡</td>
<td>å¹¶å‘é‡ä½çš„åœºæ™¯</td>
</tr>
<tr>
<td><strong>ä¹è§‚é”</strong></td>
<td>ç‰ˆæœ¬å·æœºåˆ¶/CAS</td>
<td>æ€§èƒ½å¥½ï¼Œæ— é˜»å¡</td>
<td>å®ç°å¤æ‚ï¼ŒABAé—®é¢˜</td>
<td>å¹¶å‘é‡é«˜çš„åœºæ™¯</td>
</tr>
</tbody>
</table>
<p><strong>ä¹è§‚é”å®ç°åŸç†</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‰ˆæœ¬å·æœºåˆ¶</span></span><br><span class="line">UPDATE tb_seckill_voucher </span><br><span class="line"><span class="type">SET</span> <span class="variable">stock</span> <span class="operator">=</span> stock - <span class="number">1</span>, version = version + <span class="number">1</span> </span><br><span class="line"><span class="type">WHERE</span> <span class="variable">voucher_id</span> <span class="operator">=</span> ? <span class="type">AND</span> <span class="variable">version</span> <span class="operator">=</span> ?</span><br><span class="line"></span><br><span class="line"><span class="comment">// CASæœºåˆ¶ï¼ˆåº“å­˜å¤§äº0ï¼‰  </span></span><br><span class="line">UPDATE tb_seckill_voucher </span><br><span class="line"><span class="type">SET</span> <span class="variable">stock</span> <span class="operator">=</span> stock - <span class="number">1</span> </span><br><span class="line"><span class="type">WHERE</span> <span class="variable">voucher_id</span> <span class="operator">=</span> ? AND stock &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="oversell-analysis-3"><p><strong>ä¹è§‚é”æ–¹æ¡ˆæ¼”è¿›</strong></p>
<div class="note warning flat"><p><strong>æ–¹æ¡ˆä¸€ï¼šç‰ˆæœ¬å·æ§åˆ¶</strong>ï¼ˆæˆåŠŸç‡ä½ï¼‰</p>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">    .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .eq(<span class="string">&quot;stock&quot;</span>, voucher.getStock())  <span class="comment">// ç‰ˆæœ¬å·æ ¡éªŒ</span></span><br><span class="line">    .update();</span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜åˆ†æ</strong>ï¼š</p>
<ul>
<li>âŒ <strong>æˆåŠŸç‡æä½</strong>ï¼š100ä¸ªçº¿ç¨‹åŒæ—¶æ‹¿åˆ°stock=100ï¼Œåªæœ‰1ä¸ªèƒ½æˆåŠŸ</li>
<li>âŒ <strong>é‡è¯•å‹åŠ›å¤§</strong>ï¼šå¤±è´¥çº¿ç¨‹éœ€è¦é‡æ–°æŸ¥è¯¢ç‰ˆæœ¬å·å†é‡è¯•</li>
<li>âŒ <strong>ç”¨æˆ·ä½“éªŒå·®</strong>ï¼šå¤§é‡è¯·æ±‚è¿”å›å¤±è´¥</li>
</ul>
<div class="note success flat"><p><strong>æ–¹æ¡ˆäºŒï¼šåº“å­˜å¤§äº0æ§åˆ¶</strong>ï¼ˆæ¨èï¼‰</p>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">    .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)  <span class="comment">// åªéœ€ä¿è¯åº“å­˜å¤§äº0</span></span><br><span class="line">    .update();</span><br></pre></td></tr></table></figure>
<p><strong>ä¼˜åŠ¿åˆ†æ</strong>ï¼š</p>
<ul>
<li>âœ… <strong>æˆåŠŸç‡é«˜</strong>ï¼šåªè¦è¿˜æœ‰åº“å­˜å°±èƒ½æˆåŠŸ</li>
<li>âœ… <strong>å®ç°ç®€å•</strong>ï¼šæ— éœ€ç»´æŠ¤ç‰ˆæœ¬å·</li>
<li>âœ… <strong>æ€§èƒ½ä¼˜ç§€</strong>ï¼šæ— è‡ªæ—‹é‡è¯•ï¼Œä¸€æ¬¡æ“ä½œå®Œæˆ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="3-5-ä¸€äººä¸€å•é—®é¢˜">3.5 ä¸€äººä¸€å•é—®é¢˜</h3>
<div class="tabs" id="one-user-one-order"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#one-user-one-order-1">ä¸šåŠ¡éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#one-user-one-order-2">å¹¶å‘é—®é¢˜</button></li><li class="tab"><button type="button" data-href="#one-user-one-order-3">è§£å†³æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#one-user-one-order-4">äº‹åŠ¡é—®é¢˜</button></li><li class="tab"><button type="button" data-href="#one-user-one-order-5">å¼•å…¥é…ç½®å’Œä¾èµ–</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="one-user-one-order-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<div class="note primary flat"><p><strong>ä¸šåŠ¡è§„åˆ™</strong>ï¼šåŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p>
</div>
<p><strong>é—®é¢˜èƒŒæ™¯</strong>ï¼š</p>
<ul>
<li>ğŸ¯ <strong>è¥é”€ç›®çš„</strong>ï¼šä¼˜æƒ åˆ¸ç”¨äºå¼•æµè·å®¢ï¼Œéœ€è¦æ§åˆ¶æˆæœ¬</li>
<li>ğŸ¯ <strong>å…¬å¹³æ€§</strong>ï¼šé˜²æ­¢é»„ç‰›å…šæ¶æ„åˆ·å•</li>
<li>ğŸ¯ <strong>ç”¨æˆ·ä½“éªŒ</strong>ï¼šè®©æ›´å¤šç”¨æˆ·äº«å—åˆ°ä¼˜æƒ </li>
</ul>
<p><strong>å®ç°æ€è·¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ä¸‹å•å‰ â†’ æŸ¥è¯¢è¯¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹° â†’ å·²è´­ä¹°åˆ™æ‹’ç» â†’ æœªè´­ä¹°åˆ™å…è®¸ä¸‹å•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="one-user-one-order-2"><p><strong>å¹¶å‘åœºæ™¯ä¸‹çš„é—®é¢˜</strong></p>
<p>å‡è®¾ç”¨æˆ·AåŒæ—¶å‘èµ·5ä¸ªè¯·æ±‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´ç‚¹ | è¯·æ±‚1 | è¯·æ±‚2 | è¯·æ±‚3 | è¯·æ±‚4 | è¯·æ±‚5</span><br><span class="line">-------|-------|-------|-------|-------|------</span><br><span class="line">t1     | æŸ¥è¯¢è®¢å•=0âœ… | æŸ¥è¯¢è®¢å•=0âœ… | æŸ¥è¯¢è®¢å•=0âœ… | æŸ¥è¯¢è®¢å•=0âœ… | æŸ¥è¯¢è®¢å•=0âœ…</span><br><span class="line">t2     | åˆ›å»ºè®¢å• | åˆ›å»ºè®¢å• | åˆ›å»ºè®¢å• | åˆ›å»ºè®¢å• | åˆ›å»ºè®¢å•</span><br><span class="line">t3     | æˆåŠŸ | æˆåŠŸ | æˆåŠŸ | æˆåŠŸ | æˆåŠŸ</span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜æœ¬è´¨</strong>ï¼š</p>
<ul>
<li>âŒ <strong>æŸ¥è¯¢-åˆ¤æ–­-åˆ›å»º</strong>æ“ä½œéåŸå­æ€§</li>
<li>âŒ <strong>æ— å¹¶å‘æ§åˆ¶</strong>å¯¼è‡´é‡å¤ä¸‹å•</li>
<li>âŒ <strong>æ•°æ®åº“å”¯ä¸€çº¦æŸ</strong>æ— æ³•é˜²æ­¢å¹¶å‘æ’å…¥</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="one-user-one-order-3"><p><strong>æ‚²è§‚é”è§£å†³æ–¹æ¡ˆ</strong></p>
<div class="note success flat"><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šå¯¹<strong>ç”¨æˆ·ID</strong>åŠ é”ï¼Œä¿è¯åŒä¸€ç”¨æˆ·å¹¶å‘è¯·æ±‚ä¸²è¡Œå¤„ç†</p>
</div>
<p><strong>ä»£ç å®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ä¸€äººä¸€å•æ§åˆ¶</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;        </span><br><span class="line">        <span class="comment">// åˆ›å»ºè®¢å•ï¼ˆåŒ…å«ä¸€äººä¸€å•æ ¡éªŒæ‰£å‡åº“å­˜é€»è¾‘ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> createVoucherOrder(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">//6.1 è®¾ç½®è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//6.2 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(id);</span><br><span class="line">    <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//8. è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®è®¾è®¡</strong>ï¼š</p>
<ul>
<li>âœ… <strong>é”ç²’åº¦</strong>ï¼šæŒ‰ç”¨æˆ·IDåŠ é”ï¼Œä¸åŒç”¨æˆ·äº’ä¸å½±å“</li>
<li>âœ… <strong>å­—ç¬¦ä¸²å¸¸é‡æ± </strong>ï¼šä½¿ç”¨<code>intern()</code>ç¡®ä¿åŒä¸€æŠŠé”</li>
<li>âœ… <strong>äº‹åŠ¡è¾¹ç•Œ</strong>ï¼šé”è¦åŒ…è£¹æ•´ä¸ªäº‹åŠ¡æ“ä½œ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="one-user-one-order-4"><p><strong>äº‹åŠ¡ä¸é”çš„ååŒæœºåˆ¶</strong></p>
<div class="note warning flat"><p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼šSpringäº‹åŠ¡ä¸JVMé”çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´</p>
</div>
<p><strong>é—®é¢˜æ ¹æº</strong>ï¼š<br>
ç›´æ¥é€šè¿‡<code>this</code>è°ƒç”¨åŒç±»æ–¹æ³•ä¼šå¯¼è‡´Springäº‹åŠ¡å¤±æ•ˆï¼Œå› ä¸ºäº‹åŠ¡æ˜¯é€šè¿‡AOPä»£ç†æœºåˆ¶å®ç°çš„ã€‚Springçš„äº‹åŠ¡ç®¡ç†åŸºäºåŠ¨æ€ä»£ç†ï¼Œåªæœ‰é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•æ‰èƒ½è¢«äº‹åŠ¡æ‹¦æˆªå™¨å¤„ç†ã€‚</p>
<p><strong>ç”Ÿå‘½å‘¨æœŸå†²çª</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡æ“ä½œ</span></span><br><span class="line">    &#125; <span class="comment">// ğŸ”’é”å·²é‡Šæ”¾ï¼Œä½†äº‹åŠ¡è¿˜æœªæäº¤</span></span><br><span class="line">&#125; <span class="comment">// ğŸ’¥äº‹åŠ¡æäº¤ï¼Œä½†å…¶ä»–çº¿ç¨‹å¯èƒ½å·²è·å–é”å¹¶è¯»å–åˆ°è„æ•°æ®</span></span><br></pre></td></tr></table></figure>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šè·å–Springä»£ç†å¯¹è±¡ç¡®ä¿äº‹åŠ¡ç”Ÿæ•ˆ<br>
ä½¿ç”¨<code>AopContext.currentProxy()</code>è·å–å½“å‰ä»£ç†å¯¹è±¡ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼Œç¡®ä¿é”åœ¨äº‹åŠ¡æäº¤åæ‰é‡Šæ”¾ã€‚</p>
<p><strong>æŠ€æœ¯å®ç°è¦ç‚¹</strong>ï¼š</p>
<ol>
<li>å¯ç”¨æš´éœ²ä»£ç†ï¼š<code>@EnableAspectJAutoProxy(exposeProxy = true)</code></li>
<li>æ¥å£å®šä¹‰ï¼šåœ¨<code>IVoucherOrderService</code>æ¥å£ä¸­å£°æ˜<code>createVoucherOrder</code>æ–¹æ³•</li>
<li>ä»£ç†è°ƒç”¨ï¼šé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ç¡®ä¿äº‹åŠ¡æ‹¦æˆªå™¨ç”Ÿæ•ˆ</li>
</ol>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// å‰ç½®æ ¡éªŒæ–¹æ¡ˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">        <span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼Œç¡®ä¿äº‹åŠ¡ç”Ÿæ•ˆ</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">	<span class="keyword">synchronized</span>(userId.toString().intern())&#123;</span><br><span class="line">         <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">// 7.1.è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">// 7.2.ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        <span class="comment">// 7.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="one-user-one-order-5"><p><strong>å¼•å…¥é…ç½®å’Œä¾èµ–</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•å…¥aspectjweaverä¾èµ–</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š@EnableAspectJAutoProxy(exposeProxy = true)æ³¨è§£</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hmdp.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HmDianPingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HmDianPingApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="3-6-é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">3.6 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h3>
<div class="tabs" id="cluster-concurrency"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#cluster-concurrency-1">é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#cluster-concurrency-2">åˆ†å¸ƒå¼é”éœ€æ±‚</button></li><li class="tab"><button type="button" data-href="#cluster-concurrency-3">Redisåˆ†å¸ƒå¼é”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="cluster-concurrency-1"><p><strong>é›†ç¾¤æ¨¡å¼ä¸‹çš„æ–°é—®é¢˜</strong></p>
<div class="note danger flat"><p><strong>JVMé”å¤±æ•ˆ</strong>ï¼šé›†ç¾¤ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªJVMå®ä¾‹æœ‰è‡ªå·±çš„é”</p>
</div>
<p><strong>åœºæ™¯å¤ç°</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·Açš„è¯·æ±‚ â†’ Nginxè´Ÿè½½å‡è¡¡ â†’ 8081ç«¯å£ï¼ˆJVMé”ç”Ÿæ•ˆï¼‰</span><br><span class="line">ç”¨æˆ·Açš„è¯·æ±‚ â†’ Nginxè´Ÿè½½å‡è¡¡ â†’ 8082ç«¯å£ï¼ˆJVMé”å¤±æ•ˆï¼‰</span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜æœ¬è´¨</strong>ï¼š</p>
<ul>
<li>âŒ <strong>JVMé”ä½œç”¨åŸŸ</strong>ï¼šåªåœ¨å•ä¸ªJVMå®ä¾‹å†…æœ‰æ•ˆ</li>
<li>âŒ <strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåŒä¸€ç”¨æˆ·çš„è¯·æ±‚å¯èƒ½åˆ†å‘åˆ°ä¸åŒå®ä¾‹</li>
<li>âŒ <strong>åˆ†å¸ƒå¼ç¯å¢ƒ</strong>ï¼šéœ€è¦<strong>åˆ†å¸ƒå¼é”</strong>è§£å†³æ–¹æ¡ˆ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cluster-concurrency-2"><p><strong>åˆ†å¸ƒå¼é”æ ¸å¿ƒè¦æ±‚</strong></p>
<div class="note info flat"><p><strong>åˆ†å¸ƒå¼é”</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹å…±äº«çš„é”æœºåˆ¶</p>
</div>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¦æ±‚</th>
<th>å®ç°æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>äº’æ–¥æ€§</strong></td>
<td>åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å–é”</td>
<td>Redis SETNX</td>
</tr>
<tr>
<td><strong>å®‰å…¨æ€§</strong></td>
<td>é”åªèƒ½è¢«æŒæœ‰è€…é‡Šæ”¾</td>
<td>å”¯ä¸€æ ‡è¯† + Luaè„šæœ¬</td>
</tr>
<tr>
<td><strong>æ­»é”é¿å…</strong></td>
<td>é”å¿…é¡»æœ‰è¶…æ—¶æ—¶é—´</td>
<td>Redis EXPIRE</td>
</tr>
<tr>
<td><strong>å¯ç”¨æ€§</strong></td>
<td>é«˜å¯ç”¨çš„é”æœåŠ¡</td>
<td>Redisé›†ç¾¤</td>
</tr>
<tr>
<td><strong>å¯é‡å…¥æ€§</strong></td>
<td>åŒä¸€å®¢æˆ·ç«¯å¯é‡å¤è·å–é”</td>
<td>ThreadLocal + è®¡æ•°å™¨</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="cluster-concurrency-3"><p><strong>Redisåˆ†å¸ƒå¼é”å®ç°</strong></p>
<p><strong>åŸºæœ¬å‘½ä»¤</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–é”ï¼ˆSETNX + EXPIREï¼‰</span></span><br><span class="line">SET lock_key unique_value NX EX 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡Šæ”¾é”ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>, KEYS[1]) == ARGV[1] <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> redis.call(<span class="string">&quot;del&quot;</span>, KEYS[1])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>å®ç°ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>âœ… <strong>é«˜æ€§èƒ½</strong>ï¼šRediså†…å­˜æ“ä½œï¼Œ10W+QPS</li>
<li>âœ… <strong>é«˜å¯ç”¨</strong>ï¼šRedisä¸»ä»æ¶æ„ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢</li>
<li>âœ… <strong>æ˜“å®ç°</strong>ï¼šå‘½ä»¤ç®€å•ï¼Œå®¢æˆ·ç«¯æ”¯æŒå¥½</li>
<li>âœ… <strong>å¯æ‰©å±•</strong>ï¼šæ”¯æŒRedLockç®—æ³•ï¼Œå¤šRediså®ä¾‹</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<div class="note info flat"><p><strong>æœ‰å…³é”å¤±æ•ˆåŸå› åˆ†æ</strong>ï¼šè¿™å°±æ˜¯é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©é”ä¸å­˜åœ¨äºæ¯ä¸ªjvmçš„å†…éƒ¨ï¼Œè€Œæ˜¯è®©æ‰€æœ‰jvmå…¬ç”¨å¤–éƒ¨çš„ä¸€æŠŠé”ï¼ˆRedisï¼‰</p>
</div>
<h2 id="4-åˆ†å¸ƒå¼é”">4. åˆ†å¸ƒå¼é”</h2>
<h3 id="4-1-åˆ†å¸ƒå¼é”æ¦‚è¿°">4.1 åˆ†å¸ƒå¼é”æ¦‚è¿°</h3>
<div class="tabs" id="distributed-lock-overview"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#distributed-lock-overview-1">åŸºæœ¬æ¦‚å¿µ</button></li><li class="tab"><button type="button" data-href="#distributed-lock-overview-2">æ ¸å¿ƒè¦æ±‚</button></li><li class="tab"><button type="button" data-href="#distributed-lock-overview-3">å®ç°æ–¹æ¡ˆå¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="distributed-lock-overview-1"><p><strong>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”</strong></p>
<div class="note primary flat"><p><strong>åˆ†å¸ƒå¼é”</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªè¿›ç¨‹å¯è§ä¸”äº’æ–¥çš„é”æœºåˆ¶</p>
</div>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šæ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨<strong>åŒä¸€æŠŠé”</strong>ï¼Œç¡®ä¿ç¨‹åºä¸²è¡Œæ‰§è¡Œ</p>
<p><strong>ä¸JVMé”çš„åŒºåˆ«</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JVMé”ï¼šåªåœ¨å•ä¸ªJVMå®ä¾‹å†…æœ‰æ•ˆï¼ˆsynchronizedã€ReentrantLockï¼‰</span><br><span class="line">åˆ†å¸ƒå¼é”ï¼šåœ¨å¤šä¸ªèŠ‚ç‚¹é—´å…±äº«ï¼Œæ‰€æœ‰å®ä¾‹éƒ½èƒ½æ„ŸçŸ¥é”çŠ¶æ€</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-overview-2"><p><strong>åˆ†å¸ƒå¼é”å¿…å¤‡ç‰¹æ€§</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
<th>å®ç°æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>äº’æ–¥æ€§</strong></td>
<td>åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å–é”</td>
<td>Redis SETNX</td>
</tr>
<tr>
<td><strong>å¯è§æ€§</strong></td>
<td>æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½æ„ŸçŸ¥é”çŠ¶æ€å˜åŒ–</td>
<td>Rediså‘å¸ƒè®¢é˜…</td>
</tr>
<tr>
<td><strong>é«˜å¯ç”¨</strong></td>
<td>é”æœåŠ¡ä¸æ˜“å´©æºƒï¼Œæ•…éšœå¯æ¢å¤</td>
<td>Redisé›†ç¾¤/å“¨å…µ</td>
</tr>
<tr>
<td><strong>é«˜æ€§èƒ½</strong></td>
<td>åŠ é”/è§£é”æ“ä½œå“åº”å¿«</td>
<td>å†…å­˜æ“ä½œ</td>
</tr>
<tr>
<td><strong>å®‰å…¨æ€§</strong></td>
<td>é”åªèƒ½è¢«æŒæœ‰è€…é‡Šæ”¾</td>
<td>å”¯ä¸€æ ‡è¯†éªŒè¯</td>
</tr>
<tr>
<td><strong>æ­»é”é¿å…</strong></td>
<td>é”å¿…é¡»æœ‰è¶…æ—¶æ—¶é—´</td>
<td>TTLè¿‡æœŸæœºåˆ¶</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-overview-3"><p><strong>å¸¸è§åˆ†å¸ƒå¼é”å®ç°</strong></p>
<div class="note info flat"><p><strong>ä¸‰ç§ä¸»æµæ–¹æ¡ˆå¯¹æ¯”</strong></p>
</div>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MySQL</strong></td>
<td>å®ç°ç®€å•ï¼Œäº‹åŠ¡æ”¯æŒ</td>
<td>æ€§èƒ½å·®ï¼Œé”è¡¨é£é™©</td>
<td>ä½é¢‘æ“ä½œ</td>
</tr>
<tr>
<td><strong>Redis</strong></td>
<td>é«˜æ€§èƒ½ï¼Œ10W+QPS</td>
<td>éœ€è¦å¤„ç†é”è¶…æ—¶</td>
<td>é«˜é¢‘å¹¶å‘</td>
</tr>
<tr>
<td><strong>Zookeeper</strong></td>
<td>å¼ºä¸€è‡´æ€§ï¼ŒWatchæœºåˆ¶</td>
<td>å®ç°å¤æ‚ï¼Œæ€§èƒ½ä¸€èˆ¬</td>
<td>å¼ºä¸€è‡´æ€§è¦æ±‚</td>
</tr>
</tbody>
</table>
<p><strong>ä¼ä¸šçº§é€‰æ‹©</strong>ï¼š</p>
<ul>
<li>âœ… <strong>Redis</strong>ï¼š99%åœºæ™¯çš„é¦–é€‰ï¼ˆæ€§èƒ½+å¯ç”¨æ€§å¹³è¡¡ï¼‰</li>
<li>âœ… <strong>Redisson</strong>ï¼šJavaç”Ÿæ€æœ€æˆç†Ÿçš„åˆ†å¸ƒå¼é”æ¡†æ¶</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="4-2-Redisåˆ†å¸ƒå¼é”å®ç°">4.2 Redisåˆ†å¸ƒå¼é”å®ç°</h3>
<div class="tabs" id="redis-distributed-lock"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redis-distributed-lock-1">æ ¸å¿ƒå‘½ä»¤</button></li><li class="tab"><button type="button" data-href="#redis-distributed-lock-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#redis-distributed-lock-3">ä¸šåŠ¡é›†æˆ</button></li><li class="tab"><button type="button" data-href="#redis-distributed-lock-4">è¯¯åˆ é—®é¢˜</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redis-distributed-lock-1"><p><strong>Redisé”å®ç°åŸç†</strong></p>
<p><strong>è·å–é”</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸå­æ€§æ“ä½œï¼šSETNX + EXPIRE</span></span><br><span class="line">SET lock_key unique_value NX EX 30</span><br></pre></td></tr></table></figure>
<p><strong>å‚æ•°è¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>NX</code>ï¼škeyä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼ˆäº’æ–¥æ€§ï¼‰</li>
<li><code>EX 30</code>ï¼š30ç§’è‡ªåŠ¨è¿‡æœŸï¼ˆæ­»é”é¿å…ï¼‰</li>
<li><code>unique_value</code>ï¼šçº¿ç¨‹å”¯ä¸€æ ‡è¯†ï¼ˆå®‰å…¨æ€§ï¼‰</li>
</ul>
<p><strong>é‡Šæ”¾é”</strong>ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åŸå­æ€§è„šæœ¬ï¼šå…ˆéªŒè¯å†åˆ é™¤</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;del&quot;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-distributed-lock-2"><p><strong>SimpleRedisLockå®ç°</strong></p>
<p><strong>é”æ¥å£å®šä¹‰</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeoutSec é”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true-è·å–æˆåŠŸï¼Œfalse-è·å–å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒå®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">//é”çš„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="comment">//å…·ä½“ä¸šåŠ¡åç§°ï¼Œå°†å‰ç¼€å’Œä¸šåŠ¡åæ‹¼æ¥ä¹‹åå½“åšKey</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¸æ˜¯@Autowiredæ³¨å…¥ï¼Œé‡‡ç”¨çš„æ˜¯æ„é€ å™¨æ³¨å…¥ï¼Œåœ¨åˆ›å»ºSimpleRedisLockæ—¶ï¼Œå°†RedisTemplateä½œä¸ºå‚æ•°ä¼ å…¥</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”ï¼Œä½¿ç”¨SETNXæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//è‡ªåŠ¨æ‹†ç®±å¯èƒ½ä¼šå‡ºç°nullï¼Œè¿™æ ·å†™æ›´ç¨³å¦¥</span></span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡DELæ¥åˆ é™¤é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-distributed-lock-3"><p><strong>ç§’æ€ä¸šåŠ¡æ”¹é€ </strong></p>
<p><strong>é›†æˆåˆ†å¸ƒå¼é”</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ... å‰ç½®æ ¡éªŒä»£ç  ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºåˆ†å¸ƒå¼é”å¯¹è±¡</span></span><br><span class="line">    <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨Jmeterè¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œè¯·æ±‚å¤´ä¸­æºå¸¦ç™»å½•ç”¨æˆ·çš„tokenï¼Œæœ€ç»ˆåªèƒ½æŠ¢åˆ°ä¸€å¼ ä¼˜æƒ åˆ¸</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-distributed-lock-4"><p><strong>é”è¯¯åˆ é—®é¢˜åˆ†æ</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653385920025.png" alt="1653385920025"></p>
<div class="note warning flat"><p><strong>é—®é¢˜åœºæ™¯</strong>ï¼šçº¿ç¨‹é˜»å¡å¯¼è‡´é”è¶…æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è·å–é”åï¼ŒåŸçº¿ç¨‹æ¢å¤è¯¯åˆ é”</p>
</div>
<p><strong>é—®é¢˜å¤ç°</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´çº¿ï¼š</span><br><span class="line">t1: çº¿ç¨‹Aè·å–é”ï¼ˆé”è¶…æ—¶30sï¼‰</span><br><span class="line">t2: çº¿ç¨‹Aä¸šåŠ¡é˜»å¡ï¼ˆè¶…è¿‡30sï¼‰</span><br><span class="line">t3: é”è‡ªåŠ¨è¿‡æœŸé‡Šæ”¾</span><br><span class="line">t4: çº¿ç¨‹Bè·å–é”æˆåŠŸ</span><br><span class="line">t5: çº¿ç¨‹Aæ¢å¤ï¼Œæ‰§è¡Œåˆ é”æ“ä½œï¼ˆè¯¯åˆ çº¿ç¨‹Bçš„é”ï¼‰</span><br></pre></td></tr></table></figure>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å”¯ä¸€æ ‡è¯†</strong>ï¼šæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ä¸åŒçš„æ ‡è¯†</li>
<li>âœ… <strong>éªŒè¯æœºåˆ¶</strong>ï¼šåˆ é™¤å‰éªŒè¯é”çš„æŒæœ‰è€…</li>
<li>âœ… <strong>åŸå­æ“ä½œ</strong>ï¼šä½¿ç”¨Luaè„šæœ¬ä¿è¯éªŒè¯+åˆ é™¤çš„åŸå­æ€§</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="4-3-åˆ†å¸ƒå¼é”æ¼”è¿›">4.3 åˆ†å¸ƒå¼é”æ¼”è¿›</h3>
<div class="tabs" id="distributed-lock-evolution"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#distributed-lock-evolution-1">åŸºç¡€ç‰ˆæœ¬</button></li><li class="tab"><button type="button" data-href="#distributed-lock-evolution-2">æ ‡è¯†ç‰ˆæœ¬</button></li><li class="tab"><button type="button" data-href="#distributed-lock-evolution-3">Luaè„šæœ¬ç‰ˆæœ¬</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="distributed-lock-evolution-1"><p><strong>ç‰ˆæœ¬ä¸€ï¼šåŸºç¡€å®ç°</strong></p>
<div class="note primary flat"><p><strong>æ ¸å¿ƒåŠŸèƒ½</strong>ï¼šSETNX + EXPIRE åŸå­æ“ä½œ</p>
</div>
<p><strong>é—®é¢˜</strong>ï¼šé‡Šæ”¾é”æ—¶å¯èƒ½è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é”ï¼ˆåŸå­æ€§ï¼‰</span></span><br><span class="line"><span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">    .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”ï¼ˆéåŸå­æ€§ï¼‰</span></span><br><span class="line">stringRedisTemplate.delete(KEY_PREFIX + name);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-evolution-2"><p><strong>ç‰ˆæœ¬äºŒï¼šçº¿ç¨‹æ ‡è¯†</strong></p>
<div class="note warning flat"><p><strong>æ”¹è¿›</strong>ï¼šå¢åŠ çº¿ç¨‹å”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢è¯¯åˆ </p>
</div>
<p><strong>å®ç°é€»è¾‘</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–é”ï¼ˆåŸå­æ€§æ“ä½œï¼‰</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue()</span><br><span class="line">            .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–é”ä¸­çš„æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éªŒè¯æ˜¯å¦ä¸ºè‡ªå·±çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (threadId.equals(id)) &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–°é—®é¢˜</strong>ï¼š<strong>éªŒè¯å’Œåˆ é™¤éåŸå­æ€§</strong>ï¼Œä»å­˜åœ¨ç«æ€æ¡ä»¶</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-evolution-3"><p><strong>ç‰ˆæœ¬ä¸‰ï¼šLuaè„šæœ¬</strong></p>
<div class="note success flat"><p><strong>æœ€ç»ˆæ–¹æ¡ˆ</strong>ï¼šLuaè„šæœ¬ä¿è¯<strong>éªŒè¯+åˆ é™¤</strong>çš„åŸå­æ€§</p>
</div>
<p><strong>Luaè„šæœ¬å®ç°</strong>ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- é‡Šæ”¾é”è„šæœ¬ï¼ˆunlock.luaï¼‰</span></span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">&quot;del&quot;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>Javaè°ƒç”¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">    UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">    UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.execute(</span><br><span class="line">        UNLOCK_SCRIPT,</span><br><span class="line">        Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">        ID_PREFIX + Thread.currentThread().getId()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="4-4-Luaè„šæœ¬è¯¦è§£">4.4 Luaè„šæœ¬è¯¦è§£</h3>
<div class='liushen-tag-link'><a class="tag-Link" target="_blank" href=" https://www.runoob.com/lua/lua-tutorial.html">
    <div class="tag-link-tips">ğŸª§å¼•ç”¨ç«™å¤–åœ°å€ï¼Œä¸ä¿è¯ç«™ç‚¹çš„å¯ç”¨æ€§å’Œå®‰å…¨æ€§</div>
    <div class="tag-link-bottom">
        <div class="tag-link-left" style="background-image: url(https://source.adoreorg.cn/webp/icon/66a4632bbf06e.webp);"></div>
        <div class="tag-link-right">
            <div class="tag-link-title">Luaè„šæœ¬è¯¦è§£</div>
            <div class="tag-link-sitename"> https://source.adoreorg.cn/webp/icon/66a4632bbf06e.webp</div>
        </div>
        <i class="fa-solid fa-angle-right"></i>
    </div>
    </a></div>
<div class="tabs" id="lua-script-detail"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#lua-script-detail-1">åŸºç¡€è¯­æ³•</button></li><li class="tab"><button type="button" data-href="#lua-script-detail-2">è„šæœ¬è°ƒç”¨</button></li><li class="tab"><button type="button" data-href="#lua-script-detail-3">åŸå­æ€§ä¿è¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="lua-script-detail-1"><p><strong>Redis Luaè„šæœ¬åŸºç¡€</strong></p>
<div class="note info flat"><p><strong>Luaè„šæœ¬</strong>ï¼šåœ¨RedisæœåŠ¡å™¨ç«¯æ‰§è¡Œçš„è„šæœ¬ï¼Œä¿è¯<strong>å¤šæ¡å‘½ä»¤åŸå­æ€§</strong></p>
</div>
<p><strong>åŸºæœ¬è¯­æ³•</strong>ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Rediså‘½ä»¤è°ƒç”¨</span></span><br><span class="line">redis.call(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç¤ºä¾‹ï¼šset name jack</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç¤ºä¾‹ï¼šå…ˆsetå†get</span></span><br><span class="line">redis.call(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"><span class="keyword">local</span> name = redis.call(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> name</span><br></pre></td></tr></table></figure>
<p><strong>å‚æ•°ä¼ é€’</strong>ï¼š</p>
<ul>
<li><code>KEYSæ•°ç»„</code>ï¼šæ¥æ”¶keyç±»å‹å‚æ•°</li>
<li><code>ARGVæ•°ç»„</code>ï¼šæ¥æ”¶å…¶ä»–å‚æ•°</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="lua-script-detail-2"><p><strong>Redisè„šæœ¬è°ƒç”¨</strong></p>
<p><strong>å‘½ä»¤è¡Œè°ƒç”¨</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬</span></span><br><span class="line">EVAL <span class="string">&quot;redis.call(&#x27;set&#x27;, &#x27;name&#x27;, &#x27;jack&#x27;)&quot;</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¦å‚æ•°è°ƒç”¨</span></span><br><span class="line">EVAL <span class="string">&quot;redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot;</span> 1 name Rose</span><br></pre></td></tr></table></figure>
<p><strong>Javaè°ƒç”¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è„šæœ¬å®šä¹‰</span></span><br><span class="line">DefaultRedisScript&lt;Long&gt; script = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">script.setScriptText(<span class="string">&quot;redis.call(&#x27;set&#x27;, KEYS[1], ARGV[1])&quot;</span>);</span><br><span class="line">script.setResultType(Long.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œè„šæœ¬</span></span><br><span class="line">redisTemplate.execute(script, </span><br><span class="line">    Collections.singletonList(<span class="string">&quot;name&quot;</span>), </span><br><span class="line">    <span class="string">&quot;Jack&quot;</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="lua-script-detail-3"><p><strong>åŸå­æ€§ä¿è¯æœºåˆ¶</strong></p>
<div class="note success flat"><p><strong>Rediså•çº¿ç¨‹æ¨¡å‹</strong>ï¼šLuaè„šæœ¬æ‰§è¡ŒæœŸé—´ï¼ŒRedisä¸ä¼šæ‰§è¡Œå…¶ä»–å‘½ä»¤</p>
</div>
<p><strong>åŸå­æ€§éªŒè¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹Aï¼šæ‰§è¡ŒLuaè„šæœ¬ï¼ˆéªŒè¯+åˆ é™¤ï¼‰</span><br><span class="line">Redisï¼šè„šæœ¬æ‰§è¡ŒæœŸé—´ï¼Œçº¿ç¨‹Bçš„è¯·æ±‚æ’é˜Ÿç­‰å¾…</span><br><span class="line">ç»“æœï¼šä¿è¯éªŒè¯å’Œåˆ é™¤æ“ä½œçš„åŸå­æ€§</span><br></pre></td></tr></table></figure>
<p><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li>âœ… <strong>ç½‘ç»œå¼€é”€å°‘</strong>ï¼šä¸€æ¬¡äº¤äº’å®Œæˆå¤šä¸ªæ“ä½œ</li>
<li>âœ… <strong>åŸå­æ€§ä¿è¯</strong>ï¼šRediså•çº¿ç¨‹æ‰§è¡Œ</li>
<li>âœ… <strong>å‡å°‘ç«æ€</strong>ï¼šé¿å…å®¢æˆ·ç«¯å¹¶å‘é—®é¢˜</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="4-5-åˆ†å¸ƒå¼é”æ€»ç»“">4.5 åˆ†å¸ƒå¼é”æ€»ç»“</h3>
<div class="tabs" id="distributed-lock-summary"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#distributed-lock-summary-1">å®ç°æ¼”è¿›</button></li><li class="tab"><button type="button" data-href="#distributed-lock-summary-2">æ ¸å¿ƒç‰¹æ€§</button></li><li class="tab"><button type="button" data-href="#distributed-lock-summary-3">æœ€ä½³å®è·µ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="distributed-lock-summary-1"><p><strong>åˆ†å¸ƒå¼é”æ¼”è¿›å†ç¨‹</strong></p>
<div class="note primary flat"><p><strong>ä»ç®€å•åˆ°å®Œå–„çš„æ¼”è¿›è¿‡ç¨‹</strong></p>
</div>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>å®ç°æ–¹å¼</th>
<th>è§£å†³é—®é¢˜</th>
<th>å­˜åœ¨é—®é¢˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>V1</strong></td>
<td>SETNX + DEL</td>
<td>åŸºæœ¬äº’æ–¥</td>
<td>è¯¯åˆ é”ã€æ­»é”</td>
</tr>
<tr>
<td><strong>V2</strong></td>
<td>SET NX EX + çº¿ç¨‹æ ‡è¯†</td>
<td>æ­»é”é¿å…</td>
<td>è¯¯åˆ é—®é¢˜</td>
</tr>
<tr>
<td><strong>V3</strong></td>
<td>çº¿ç¨‹æ ‡è¯† + éªŒè¯åˆ é™¤</td>
<td>é˜²è¯¯åˆ </td>
<td>åŸå­æ€§é—®é¢˜</td>
</tr>
<tr>
<td><strong>V4</strong></td>
<td>Luaè„šæœ¬åŸå­æ“ä½œ</td>
<td>åŸå­æ€§ä¿è¯</td>
<td>åŠŸèƒ½å•ä¸€</td>
</tr>
<tr>
<td><strong>V5</strong></td>
<td>Redissonæ¡†æ¶</td>
<td>å®Œæ•´åŠŸèƒ½</td>
<td>ä¾èµ–ç¬¬ä¸‰æ–¹</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-summary-2"><p><strong>Redisåˆ†å¸ƒå¼é”æ ¸å¿ƒç‰¹æ€§</strong></p>
<div class="note success flat"><p><strong>ä¼ä¸šçº§å®ç°è¦æ±‚</strong></p>
</div>
<p><strong>åŸºæœ¬ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>âœ… <strong>äº’æ–¥æ€§</strong>ï¼šSETNXä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å–é”</li>
<li>âœ… <strong>æ­»é”é¿å…</strong>ï¼šEXPIREè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢æ­»é”</li>
<li>âœ… <strong>å®‰å…¨æ€§</strong>ï¼šçº¿ç¨‹å”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢è¯¯åˆ </li>
<li>âœ… <strong>åŸå­æ€§</strong>ï¼šLuaè„šæœ¬ä¿è¯æ“ä½œåŸå­æ€§</li>
</ul>
<p><strong>é«˜çº§ç‰¹æ€§</strong>ï¼ˆRedissonæä¾›ï¼‰ï¼š</p>
<ul>
<li>ğŸ”„ <strong>å¯é‡å…¥æ€§</strong>ï¼šåŒä¸€çº¿ç¨‹å¯é‡å¤è·å–é”</li>
<li>â° <strong>é”ç»­æœŸ</strong>ï¼šWatchDogè‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢ä¸šåŠ¡æœªæ‰§è¡Œå®Œé”è¿‡æœŸ</li>
<li>ğŸ”„ <strong>å¯é‡è¯•</strong>ï¼šè·å–é”å¤±è´¥å¯è‡ªåŠ¨é‡è¯•</li>
<li>ğŸ—ï¸ <strong>ä¸»ä»ä¸€è‡´æ€§</strong>ï¼šRedLockç®—æ³•ä¿è¯ä¸»ä»ä¸€è‡´æ€§</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="distributed-lock-summary-3"><p><strong>ä½¿ç”¨å»ºè®®</strong></p>
<div class="note warning flat"><p><strong>ä¸åŒåœºæ™¯çš„é€‰æ‹©ç­–ç•¥</strong></p>
</div>
<p><strong>ç®€å•åœºæ™¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•åˆ†å¸ƒå¼é”ï¼ˆé€‚åˆä½é¢‘æ“ä½œï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:business:&quot;</span> + userId;</span><br><span class="line"><span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="type">boolean</span> <span class="variable">locked</span> <span class="operator">=</span> redisTemplate.opsForValue()</span><br><span class="line">    .setIfAbsent(lockKey, threadId, <span class="number">30</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<p><strong>å¤æ‚åœºæ™¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Redissonï¼ˆé€‚åˆé«˜é¢‘å¹¶å‘ï¼‰</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line"><span class="comment">// å¯é‡å…¥ã€å¯ç»­æœŸã€å¯é‡è¯•</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">locked</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<p><strong>é€‰æ‹©åŸåˆ™</strong>ï¼š</p>
<ul>
<li><strong>ä½é¢‘ç®€å•æ“ä½œ</strong>ï¼šæ‰‹å†™Redisåˆ†å¸ƒå¼é”</li>
<li><strong>é«˜é¢‘å¹¶å‘åœºæ™¯</strong>ï¼šRedissonæ¡†æ¶</li>
<li><strong>å¼ºä¸€è‡´æ€§è¦æ±‚</strong>ï¼šZookeeperåˆ†å¸ƒå¼é”</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="5-åˆ†å¸ƒå¼é”-redission">5. åˆ†å¸ƒå¼é”-redission</h2>
<h3 id="5-1-Redissonæ¦‚è¿°">5.1 Redissonæ¦‚è¿°</h3>
<div class="tabs" id="redisson-overview"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-overview-1">åŸºæœ¬ä»‹ç»</button></li><li class="tab"><button type="button" data-href="#redisson-overview-2">é—®é¢˜è§£å†³</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-overview-1"><p><strong>ä»€ä¹ˆæ˜¯Redisson</strong></p>
<div class="note primary flat"><p><strong>Redisson</strong>ï¼šåŸºäºRedisçš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰</p>
</div>
<p><strong>æ ¸å¿ƒåŠŸèƒ½</strong>ï¼š</p>
<ul>
<li>ğŸ”’ <strong>åˆ†å¸ƒå¼é”</strong>ï¼šå¯é‡å…¥é”ã€å…¬å¹³é”ã€è”é”ã€çº¢é”ç­‰</li>
<li>ğŸ“¦ <strong>åˆ†å¸ƒå¼å¯¹è±¡</strong>ï¼šObjectã€Listã€Setã€Mapã€Queueç­‰</li>
<li>ğŸ”„ <strong>åˆ†å¸ƒå¼æœåŠ¡</strong>ï¼šè¿œç¨‹æœåŠ¡ã€æ¶ˆæ¯æœåŠ¡ã€æ‰§è¡Œå™¨æœåŠ¡ç­‰</li>
</ul>
<p><strong>ä¼˜åŠ¿ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… <strong>åŠŸèƒ½å®Œå–„</strong>ï¼šæä¾›å„ç§åˆ†å¸ƒå¼é”å®ç°</li>
<li>âœ… <strong>å¯é‡å…¥æ€§</strong>ï¼šæ”¯æŒåŒä¸€çº¿ç¨‹é‡å¤è·å–é”</li>
<li>âœ… <strong>è‡ªåŠ¨ç»­æœŸ</strong>ï¼šWatchDogæœºåˆ¶è‡ªåŠ¨å»¶é•¿é”æœ‰æ•ˆæœŸ</li>
<li>âœ… <strong>é«˜å¯ç”¨</strong>ï¼šæ”¯æŒä¸»ä»ã€å“¨å…µã€é›†ç¾¤æ¨¡å¼</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-overview-2"><p><strong>è§£å†³æ‰‹å†™Redisé”çš„é—®é¢˜</strong></p>
<div class="note warning flat"><p><strong>æ‰‹å†™Redisåˆ†å¸ƒå¼é”çš„å±€é™æ€§</strong></p>
</div>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>æ‰‹å†™Redisé”</th>
<th>Redissonè§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ä¸å¯é‡å…¥</strong></td>
<td>åŒä¸€çº¿ç¨‹æ— æ³•é‡å¤è·å–é”</td>
<td>å†…ç½®å¯é‡å…¥æœºåˆ¶</td>
</tr>
<tr>
<td><strong>ä¸å¯é‡è¯•</strong></td>
<td>è·å–å¤±è´¥åªèƒ½æ”¾å¼ƒ</td>
<td>æ”¯æŒè·å–é”è¶…æ—¶é‡è¯•</td>
</tr>
<tr>
<td><strong>é”ç»­æœŸ</strong></td>
<td>å›ºå®šè¿‡æœŸæ—¶é—´</td>
<td>WatchDogè‡ªåŠ¨ç»­æœŸ</td>
</tr>
<tr>
<td><strong>ä¸»ä»ä¸€è‡´æ€§</strong></td>
<td>ä¸»ä»åˆ‡æ¢å¯èƒ½ä¸¢é”</td>
<td>RedLockç®—æ³•</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="5-2-Redissonå¿«é€Ÿå…¥é—¨">5.2 Redissonå¿«é€Ÿå…¥é—¨</h3>
<div class="tabs" id="redisson-quickstart"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-quickstart-1">ä¾èµ–é…ç½®</button></li><li class="tab"><button type="button" data-href="#redisson-quickstart-2">å®¢æˆ·ç«¯é…ç½®</button></li><li class="tab"><button type="button" data-href="#redisson-quickstart-3">åŸºæœ¬ä½¿ç”¨</button></li><li class="tab"><button type="button" data-href="#redisson-quickstart-4">ä¸šåŠ¡é›†æˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-quickstart-1"><p><strong>Mavenä¾èµ–</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;redisson&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.13</span><span class="number">.6</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-quickstart-2"><p><strong>Redissonå®¢æˆ·ç«¯é…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://192.168.xxx.101:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-quickstart-3"><p><strong>åˆ†å¸ƒå¼é”ä½¿ç”¨ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">// è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-quickstart-4"><p><strong>ç§’æ€ä¸šåŠ¡é›†æˆRedissoné”</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">        <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.åˆ›å»ºé”å¯¹è±¡ï¼ˆä½¿ç”¨Redissonåˆ†å¸ƒå¼é”ï¼‰</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6.è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 8.è·å–ä»£ç†å¯¹è±¡ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line">            <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 9.é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="5-3-Redissonåˆ†å¸ƒå¼é”è¯¦è§£">5.3 Redissonåˆ†å¸ƒå¼é”è¯¦è§£</h3>
<h4 id="5-3-1-Redissonå¯é‡å…¥é”åŸç†">5.3.1 Redissonå¯é‡å…¥é”åŸç†</h4>
<div class="tabs" id="redisson-reentrant"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-reentrant-1">å¯é‡å…¥é”åŸç†</button></li><li class="tab"><button type="button" data-href="#redisson-reentrant-2">æ•°æ®ç»“æ„</button></li><li class="tab"><button type="button" data-href="#redisson-reentrant-3">è·å–é”é€»è¾‘</button></li><li class="tab"><button type="button" data-href="#redisson-reentrant-4">é‡Šæ”¾é”é€»è¾‘</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-reentrant-1"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    lock = redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ1&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åŒä¸€çº¿ç¨‹å†…æ–¹æ³•è°ƒç”¨æ—¶ï¼Œè‹¥method1å·²æŒæœ‰é”ï¼Œmethod2éœ€è·å–åŒä¸€æŠŠé”ï¼Œé€šè¿‡åˆ¤æ–­çº¿ç¨‹IDå®ç°å¯é‡å…¥ï¼šstate+1è·å–é”ï¼Œstate-1é‡Šæ”¾é”ï¼Œå‡è‡³0æ—¶çœŸæ­£é‡Šæ”¾</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-reentrant-2"><p><strong>Redisä¸­çš„é”å­˜å‚¨ç»“æ„</strong></p>
<div class="note primary flat"><p><strong>Hashç»“æ„å­˜å‚¨å¯é‡å…¥é”ä¿¡æ¯</strong></p>
</div>
<p><strong>å­˜å‚¨æ ¼å¼</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Key: lock_name (é”åç§°)</span><br><span class="line">Value: Hashç»“æ„</span><br><span class="line">â”œâ”€ field: UUID + &quot;:&quot; + threadId (çº¿ç¨‹å”¯ä¸€æ ‡è¯†)</span><br><span class="line">â””â”€ value: é‡å…¥æ¬¡æ•° (æ•´æ•°)</span><br></pre></td></tr></table></figure>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock:order:12345</span><br><span class="line">â”œâ”€ &quot;8f3e2a1c:1&quot; : 2  (çº¿ç¨‹1é‡å…¥äº†2æ¬¡)</span><br><span class="line">â””â”€ &quot;9d4c5b2a:2&quot; : 1  (çº¿ç¨‹2é‡å…¥äº†1æ¬¡)</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-reentrant-3"><p><strong>å¯é‡å…¥é”è·å–Luaè„šæœ¬</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- KEYS[1]: é”åç§°</span></span><br><span class="line"><span class="comment">-- ARGV[1]: é”å¤±æ•ˆæ—¶é—´(æ¯«ç§’)</span></span><br><span class="line"><span class="comment">-- ARGV[2]: çº¿ç¨‹æ ‡è¯†(UUID + &quot;:&quot; + threadId)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é”</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”å­˜åœ¨ä¸”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œé‡å…¥æ¬¡æ•°+1</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”å­˜åœ¨ä½†ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œè¿”å›é”å‰©ä½™æ—¶é—´</span></span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p><strong>è„šæœ¬é€»è¾‘</strong>ï¼š</p>
<ol>
<li><strong>é”ä¸å­˜åœ¨</strong>ï¼šåˆ›å»ºæ–°é”ï¼Œé‡å…¥æ¬¡æ•°è®¾ä¸º1</li>
<li><strong>å½“å‰çº¿ç¨‹é‡å…¥</strong>ï¼šé‡å…¥æ¬¡æ•°+1ï¼Œé‡ç½®è¿‡æœŸæ—¶é—´</li>
<li><strong>å…¶ä»–çº¿ç¨‹æŒæœ‰</strong>ï¼šè¿”å›é”å‰©ä½™æ—¶é—´ï¼ŒæŠ¢é”å¤±è´¥</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-reentrant-4"><p><strong>å¯é‡å…¥é”é‡Šæ”¾Luaè„šæœ¬</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- KEYS[1]: é”åç§°</span></span><br><span class="line"><span class="comment">-- ARGV[1]: çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line"><span class="comment">-- ARGV[2]: é”å¤±æ•ˆæ—¶é—´</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é”ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é‡å…¥æ¬¡æ•°-1</span></span><br><span class="line">counter = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é‡å…¥æ¬¡æ•°ä¸º0ï¼Œåˆ é™¤é”</span></span><br><span class="line"><span class="keyword">if</span> (counter &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p><strong>é‡Šæ”¾é€»è¾‘</strong>ï¼š</p>
<ul>
<li><strong>é‡å…¥æ¬¡æ•°&gt;0</strong>ï¼šä»…å‡å°‘é‡å…¥æ¬¡æ•°ï¼Œä¸åˆ é™¤é”</li>
<li><strong>é‡å…¥æ¬¡æ•°=0</strong>ï¼šåˆ é™¤æ•´ä¸ªé”</li>
<li><strong>é”ä¸å­˜åœ¨</strong>ï¼šç›´æ¥è¿”å›ï¼Œé˜²æ­¢è¯¯åˆ </li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h4 id="5-3-2-Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶">5.3.2 Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶</h4>
<div class="tabs" id="redisson-watchdog"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-watchdog-1">é‡è¯•æœºåˆ¶</button></li><li class="tab"><button type="button" data-href="#redisson-watchdog-2">WatchDogæœºåˆ¶</button></li><li class="tab"><button type="button" data-href="#redisson-watchdog-3">ä½¿ç”¨å¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-watchdog-1"><p><strong>é”è·å–é‡è¯•æœºåˆ¶</strong></p>
<div class="note primary flat"><p><strong>tryLockæ–¹æ³•çš„é‡è¯•é€»è¾‘</strong></p>
</div>
<p><strong>é‡è¯•æµç¨‹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…1ç§’ï¼Œé”æœ‰æ•ˆæœŸ10ç§’</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<p><strong>å†…éƒ¨å®ç°</strong>ï¼š</p>
<ol>
<li><strong>é¦–æ¬¡å°è¯•</strong>ï¼šç«‹å³æ‰§è¡ŒLuaè„šæœ¬æŠ¢é”</li>
<li><strong>å¤±è´¥é‡è¯•</strong>ï¼šå¦‚æœé”è¢«å ç”¨ï¼Œç­‰å¾…é”é‡Šæ”¾åé‡è¯•</li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šåœ¨æŒ‡å®šç­‰å¾…æ—¶é—´å†…æŒç»­é‡è¯•</li>
<li><strong>è¿”å›ç»“æœ</strong>ï¼šæˆåŠŸè¿”å›trueï¼Œè¶…æ—¶è¿”å›false</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-watchdog-2"><p><strong>çœ‹é—¨ç‹—è‡ªåŠ¨ç»­æœŸæœºåˆ¶</strong></p>
<div class="note warning flat"><p><strong>è§£å†³ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”æœ‰æ•ˆæœŸçš„é—®é¢˜</strong></p>
</div>
<p><strong>ç»­æœŸåŸç†</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock()æ–¹æ³•é»˜è®¤å¼€å¯WatchDog</span></span><br><span class="line">lock.lock(); <span class="comment">// 30ç§’æœ‰æ•ˆæœŸï¼ŒWatchDogæ¯10ç§’ç»­æœŸä¸€æ¬¡</span></span><br></pre></td></tr></table></figure>
<p><strong>ç»­æœŸæµç¨‹</strong>ï¼š</p>
<ol>
<li><strong>åˆå§‹æœ‰æ•ˆæœŸ</strong>ï¼šé»˜è®¤30ç§’ï¼ˆå¯é…ç½®ï¼‰</li>
<li><strong>ç»­æœŸè§¦å‘</strong>ï¼šæ¯<code>æœ‰æ•ˆæœŸ/3</code>æ—¶é—´è§¦å‘ä¸€æ¬¡ï¼ˆé»˜è®¤10ç§’ï¼‰</li>
<li><strong>ç»­æœŸæ¡ä»¶</strong>ï¼šä¸šåŠ¡çº¿ç¨‹ä»åœ¨è¿è¡Œä¸”æŒæœ‰é”</li>
<li><strong>ç»­æœŸå¤±è´¥</strong>ï¼šçº¿ç¨‹å®•æœºæˆ–é”å·²é‡Šæ”¾ï¼Œåœæ­¢ç»­æœŸ</li>
</ol>
<p><strong>ä»£ç å®ç°</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renewExpiration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»ç»­çº¦æ˜ å°„ä¸­è·å–å½“å‰çº¿ç¨‹çš„ç»­çº¦æ¡ç›®</span></span><br><span class="line">    <span class="type">ExpirationEntry</span> <span class="variable">ee</span> <span class="operator">=</span> EXPIRATION_RENEWAL_MAP.get(getEntryName());</span><br><span class="line">    <span class="keyword">if</span> (ee == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼ŒinternalLockLeaseTime/3åæ‰§è¡Œ</span></span><br><span class="line">    <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> commandExecutor.getConnectionManager().newTimeout(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// å¼‚æ­¥ç»­æœŸé”æœ‰æ•ˆæœŸ</span></span><br><span class="line">                RFuture&lt;Boolean&gt; future = renewExpirationAsync(threadId);</span><br><span class="line">                future.onComplete((res, e) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                        <span class="comment">// ç»­æœŸæˆåŠŸï¼Œé€’å½’è°ƒç”¨ç»§ç»­ä¸‹ä¸€è½®ç»­æœŸ</span></span><br><span class="line">                        renewExpiration();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        internalLockLeaseTime / <span class="number">3</span>,  <span class="comment">// é»˜è®¤10ç§’</span></span><br><span class="line">        TimeUnit.MILLISECONDS</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    ee.setTimeout(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-watchdog-3"><p><strong>ä¸åŒåŠ é”æ–¹å¼çš„å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ˜¯å¦é‡è¯•</th>
<th>æ˜¯å¦ç»­æœŸ</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tryLock()</code></td>
<td>âŒ</td>
<td>âŒ</td>
<td>ç®€å•è·å–ï¼Œç«‹å³è¿”å›</td>
</tr>
<tr>
<td><code>tryLock(waitTime, leaseTime, unit)</code></td>
<td>âœ…</td>
<td>âŒ</td>
<td>å¸¦è¶…æ—¶ç­‰å¾…ï¼Œå›ºå®šæœ‰æ•ˆæœŸ</td>
</tr>
<tr>
<td><code>lock()</code></td>
<td>âœ…</td>
<td>âœ…</td>
<td>é•¿æœŸæŒæœ‰ï¼Œè‡ªåŠ¨ç»­æœŸ</td>
</tr>
<tr>
<td><code>lock(leaseTime, unit)</code></td>
<td>âœ…</td>
<td>âŒ</td>
<td>å›ºå®šæœ‰æ•ˆæœŸï¼Œä¸ç»­æœŸ</td>
</tr>
</tbody>
</table>
<p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p>
<ul>
<li><strong>çŸ­æ—¶æ“ä½œ</strong>ï¼š<code>tryLock(1, 10, TimeUnit.SECONDS)</code></li>
<li><strong>é•¿æ—¶æ“ä½œ</strong>ï¼š<code>lock()</code> + WatchDogç»­æœŸ</li>
<li><strong>å®šæ—¶ä»»åŠ¡</strong>ï¼š<code>lock(30, TimeUnit.SECONDS)</code> æ‰‹åŠ¨æ§åˆ¶æœ‰æ•ˆæœŸ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/635d046816f2c2beb1293315.jpg" alt="Redisson MultiLockåŸç†"></p>
<h4 id="5-3-3-Redisson-MultiLockåŸç†">5.3.3 Redisson MultiLockåŸç†</h4>
<div class="tabs" id="redisson-multilock"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redisson-multilock-1">é—®é¢˜èƒŒæ™¯</button></li><li class="tab"><button type="button" data-href="#redisson-multilock-2">å®ç°åŸç†</button></li><li class="tab"><button type="button" data-href="#redisson-multilock-3">ä¼˜ç¼ºç‚¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redisson-multilock-1"><p><strong>Redisä¸»ä»æ¶æ„ä¸­çš„åˆ†å¸ƒå¼é”å¤±æ•ˆé£é™©åˆ†æ</strong></p>
<div class="note danger flat"><p><strong>ä¸»ä»åˆ‡æ¢å¯¼è‡´çš„é”ä¿¡æ¯ä¸¢å¤±</strong></p>
</div>
<p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<ol>
<li><strong>ä¸»èŠ‚ç‚¹å†™å…¥é”</strong>ï¼šå®¢æˆ·ç«¯åœ¨MasterèŠ‚ç‚¹æˆåŠŸè·å–é”</li>
<li><strong>ä¸»èŠ‚ç‚¹å®•æœº</strong>ï¼šæ•°æ®è¿˜æœªåŒæ­¥åˆ°SlaveèŠ‚ç‚¹</li>
<li><strong>ä¸»ä»åˆ‡æ¢</strong>ï¼šSlaveå‡çº§ä¸ºæ–°çš„Master</li>
<li><strong>é”ä¿¡æ¯ä¸¢å¤±</strong>ï¼šæ–°Masteræ²¡æœ‰é”ä¿¡æ¯ï¼Œå…¶ä»–å®¢æˆ·ç«¯å¯é‡æ–°è·å–é”</li>
</ol>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šMultiLockæœºåˆ¶ï¼Œåœ¨å¤šä¸ªç‹¬ç«‹Rediså®ä¾‹ä¸ŠåŒæ—¶åŠ é”</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-multilock-2"><p><strong>MultiLockæ ¸å¿ƒåŸç†</strong></p>
<div class="note primary flat"><p><strong>å¤šæ•°æ´¾åŸåˆ™ä¿è¯é”å¯é æ€§</strong></p>
</div>
<p><strong>åŠ é”è§„åˆ™</strong>ï¼š</p>
<ul>
<li><strong>å…¨éƒ¨æˆåŠŸ</strong>ï¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½æˆåŠŸåŠ é”æ‰ç®—æˆåŠŸ</li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šæ€»è¶…æ—¶æ—¶é—´ = èŠ‚ç‚¹æ•°é‡ Ã— 1500ms</li>
<li><strong>å¤±è´¥å¤„ç†</strong>ï¼šä»»æ„èŠ‚ç‚¹å¤±è´¥åˆ™æ•´ä¸ªåŠ é”å¤±è´¥</li>
</ul>
<p><strong>ç¤ºä¾‹ä»£ç </strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// é…ç½®å¤šä¸ªRediså®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.137.130:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://92.168.137.131:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://92.168.137.132:6379&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient2;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RLock lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BeforeEach</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redissonClient2.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redissonClient3.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    lock = redissonClient.getMultiLock(lock1, lock2, lock3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    redissonClient.getMultiLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ1&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;è·å–é”å¤±è´¥ï¼Œ2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è·å–é”æˆåŠŸï¼Œ2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾é”ï¼Œ2&quot;</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redisson-multilock-3"><p><strong>MultiLockä¼˜ç¼ºç‚¹åˆ†æ</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¯é æ€§</strong></td>
<td>é¿å…å•ç‚¹æ•…éšœï¼Œä¸»ä»åˆ‡æ¢ä¸ä¸¢é”</td>
<td>éœ€è¦ç»´æŠ¤å¤šä¸ªç‹¬ç«‹Rediså®ä¾‹</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>å¹¶è¡ŒåŠ é”ï¼Œæ€§èƒ½å¯æ¥å—</td>
<td>ç½‘ç»œå¼€é”€å¢åŠ ï¼Œå»¶è¿Ÿä¸Šå‡</td>
</tr>
<tr>
<td><strong>å¤æ‚åº¦</strong></td>
<td>ä½¿ç”¨ç®€å•ï¼ŒAPIç»Ÿä¸€</td>
<td>éœ€è¦é¢å¤–çš„Rediså®ä¾‹èµ„æº</td>
</tr>
<tr>
<td><strong>ä¸€è‡´æ€§</strong></td>
<td>åŸºäºå¤šæ•°æ´¾ï¼Œä¸€è‡´æ€§å¼º</td>
<td>ç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½å‡ºç°ä¸å¯ç”¨</td>
</tr>
</tbody>
</table>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>âœ… <strong>é«˜å¯é æ€§è¦æ±‚</strong>ï¼šé‡‘èäº¤æ˜“ã€è®¢å•å¤„ç†ç­‰å…³é”®ä¸šåŠ¡</li>
<li>âœ… <strong>ä¸»ä»æ¶æ„</strong>ï¼šRedisä¸»ä»éƒ¨ç½²ç¯å¢ƒ</li>
<li>âŒ <strong>ç®€å•åœºæ™¯</strong>ï¼šå•æœºRediså³å¯æ»¡è¶³éœ€æ±‚</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="6-ç§’æ€ä¼˜åŒ–">6. ç§’æ€ä¼˜åŒ–</h2>
<h3 id="6-1-å¼‚æ­¥ç§’æ€æ€è·¯">6.1 å¼‚æ­¥ç§’æ€æ€è·¯</h3>
<div class="tabs" id="async-seckill"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#async-seckill-1">é—®é¢˜åˆ†æ</button></li><li class="tab"><button type="button" data-href="#async-seckill-2">ä¼˜åŒ–æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#async-seckill-3">å®ç°éš¾ç‚¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="async-seckill-1"><p><strong>åŒæ­¥ç§’æ€çš„æ€§èƒ½ç“¶é¢ˆ</strong></p>
<div class="note warning flat"><p><strong>ä¸²è¡Œæ“ä½œå¯¼è‡´çš„æ€§èƒ½é—®é¢˜</strong></p>
</div>
<p><strong>ä¼ ç»Ÿæµç¨‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥è¯¢ä¼˜æƒ åˆ¸ â†’ åˆ¤æ–­åº“å­˜ â†’ æŸ¥è¯¢è®¢å• â†’ ä¸€äººä¸€å•æ ¡éªŒ â†’ æ‰£å‡åº“å­˜ â†’ åˆ›å»ºè®¢å•</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653560986599.png" alt="1653560986599"></p>
<p><strong>æ€§èƒ½é—®é¢˜</strong>ï¼š</p>
<ul>
<li><strong>æ•°æ®åº“å‹åŠ›å¤§</strong>ï¼šæ¯ä¸ªè¯·æ±‚éƒ½è¦å¤šæ¬¡è®¿é—®æ•°æ®åº“</li>
<li><strong>ä¸²è¡Œæ‰§è¡Œ</strong>ï¼šæ‰€æœ‰æ“ä½œé¡ºåºæ‰§è¡Œï¼Œè€—æ—¶ç´¯ç§¯</li>
<li><strong>çº¿ç¨‹é˜»å¡</strong>ï¼šæ•°æ®åº“IOç­‰å¾…å¯¼è‡´çº¿ç¨‹é—²ç½®</li>
<li><strong>å¹¶å‘èƒ½åŠ›ä½</strong>ï¼šQPSå—é™äºæ•°æ®åº“æ€§èƒ½</li>
</ul>
<p><strong>ä¼˜åŒ–æ€è·¯</strong>ï¼šå°†è€—æ—¶çŸ­çš„é€»è¾‘åˆ¤æ–­ç§»åˆ°Redisï¼Œè€—æ—¶é•¿çš„ä¸‹å•æ“ä½œå¼‚æ­¥åŒ–</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="async-seckill-2"><p><strong>å¼‚æ­¥åŒ–ä¼˜åŒ–æ–¹æ¡ˆ</strong></p>
<div class="note success flat"><p><strong>Redisç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†</strong></p>
</div>
<p><strong>ä¼˜åŒ–æµç¨‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[ç”¨æˆ·è¯·æ±‚] --&gt; B[Redisæ ¡éªŒ]</span><br><span class="line">    B --&gt; C&#123;æ ¡éªŒé€šè¿‡?&#125;</span><br><span class="line">    C --&gt;|æ˜¯| D[è¿”å›æˆåŠŸ]</span><br><span class="line">    C --&gt;|å¦| E[è¿”å›å¤±è´¥]</span><br><span class="line">    D --&gt; F[æ¶ˆæ¯é˜Ÿåˆ—]</span><br><span class="line">    F --&gt; G[å¼‚æ­¥ä¸‹å•]</span><br><span class="line">    G --&gt; H[æ•°æ®åº“æ›´æ–°]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653561657295.png" alt="1653561657295"></p>
<p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<ul>
<li><strong>å¿«é€Ÿå“åº”</strong>ï¼šRediså†…å­˜æ“ä½œï¼Œæ¯«ç§’çº§å“åº”</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°å¡«è°·ï¼Œå¹³æ»‘å¤„ç†</li>
<li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šä¿è¯è®¢å•æœ€ç»ˆåˆ›å»ºæˆåŠŸ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="async-seckill-3"><p><strong>å¼‚æ­¥åŒ–å®ç°éš¾ç‚¹</strong></p>
<div class="note info flat"><p><strong>éœ€è¦è§£å†³çš„å…³é”®é—®é¢˜</strong></p>
</div>
<p><strong>æŠ€æœ¯éš¾ç‚¹</strong>ï¼š</p>
<ol>
<li><strong>RedisåŸå­æ“ä½œ</strong>ï¼šå¦‚ä½•ä¿è¯åº“å­˜æ‰£å‡å’Œè®¢å•è®°å½•çš„åŸå­æ€§ï¼Ÿ</li>
<li><strong>ä¸€äººä¸€å•æ ¡éªŒ</strong>ï¼šRedisä¸­å¦‚ä½•å¿«é€Ÿåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•ï¼Ÿ</li>
<li><strong>è®¢å•çŠ¶æ€è·Ÿè¸ª</strong>ï¼šå¦‚ä½•å‘ŠçŸ¥ç”¨æˆ·è®¢å•å¤„ç†ç»“æœï¼Ÿ</li>
<li><strong>æ¶ˆæ¯å¯é æ€§</strong>ï¼šå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œæ­£ç¡®å¤„ç†ï¼Ÿ</li>
</ol>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li><strong>Luaè„šæœ¬</strong>ï¼šä¿è¯Redisæ“ä½œçš„åŸå­æ€§</li>
<li><strong>Seté›†åˆ</strong>ï¼šä½¿ç”¨Redis Setå­˜å‚¨å·²ä¸‹å•ç”¨æˆ·ID</li>
<li><strong>è®¢å•IDé¢„ç”Ÿæˆ</strong>ï¼šæå‰ç”Ÿæˆè®¢å•IDï¼Œç”¨äºçŠ¶æ€æŸ¥è¯¢</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šä½¿ç”¨Redis Streamæˆ–ä¸“ä¸šæ¶ˆæ¯é˜Ÿåˆ—</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653562234886.png" alt="1653562234886"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="6-2-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­">6.2 Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h3>
<div class="tabs" id="redis-qualification"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#redis-qualification-1">å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#redis-qualification-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#redis-qualification-3">å…³é”®ç‚¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="redis-qualification-1"><p><strong>RedisåŸå­æ“ä½œå®ç°èµ„æ ¼åˆ¤æ–­</strong></p>
<div class="note success flat"><p><strong>Luaè„šæœ¬ä¿è¯åŸå­æ€§</strong></p>
</div>
<p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼š</p>
<ol>
<li><strong>åº“å­˜é¢„åŠ è½½</strong>ï¼šä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redis</li>
<li><strong>åŸå­æ ¡éªŒ</strong>ï¼šLuaè„šæœ¬ä¸€æ¬¡æ€§å®Œæˆåº“å­˜ã€ä¸€äººä¸€å•åˆ¤æ–­</li>
<li><strong>å¼‚æ­¥ä¸‹å•</strong>ï¼šæ ¡éªŒé€šè¿‡åå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—</li>
</ol>
<p><strong>å®ç°æ­¥éª¤</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redisé¢„åŠ è½½ â†’ Luaè„šæœ¬æ ¡éªŒ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥ä¸‹å•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-qualification-2"><p><strong>ä¼˜æƒ åˆ¸é¢„åŠ è½½</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), </span><br><span class="line">                                         voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Luaè„šæœ¬å®ç°</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]      <span class="comment">-- ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]       <span class="comment">-- ç”¨æˆ·id  </span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]       <span class="comment">-- è®¢å•id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId    <span class="comment">-- åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId     <span class="comment">-- è®¢å•key</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>  <span class="comment">-- åº“å­˜ä¸è¶³</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>  <span class="comment">-- é‡å¤ä¸‹å•</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.3.æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.4.è®°å½•ç”¨æˆ·å·²ä¸‹å•</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.5.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, </span><br><span class="line">          <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>  <span class="comment">-- æŠ¢è´­æˆåŠŸ</span></span><br></pre></td></tr></table></figure>
<p><strong>ä¸šåŠ¡å±‚è°ƒç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">        SECKILL_SCRIPT,</span><br><span class="line">        Collections.emptyList(),</span><br><span class="line">        voucherId.toString(),</span><br><span class="line">        userId.toString(), </span><br><span class="line">        String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç»“æœ</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨PostManå‘é€è¯·æ±‚ï¼Œæ·»åŠ ä¼˜æƒ åˆ¸</strong><br>
<strong>è¯·æ±‚è·¯å¾„ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/api/voucher/seckill">http://localhost:8080/api/voucher/seckill</a></strong><br>
<strong>è¯·æ±‚æ–¹å¼ï¼šPOST</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;shopId&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;9999å…ƒä»£é‡‘åˆ¸&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subTitle&quot;</span><span class="punctuation">:</span><span class="string">&quot;365*24å°æ—¶å¯ç”¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="string">&quot;å…¨åœºé€šç”¨\\nApexçŒæ€æ— éœ€é¢„çº¦&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payValue&quot;</span><span class="punctuation">:</span><span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;actualValue&quot;</span><span class="punctuation">:</span><span class="number">999900</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stock&quot;</span><span class="punctuation">:</span><span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beginTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-01-01T00:00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;endTime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2022-12-31T23:59:59&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="redis-qualification-3"><p><strong>å®ç°å…³é”®ç‚¹</strong></p>
<div class="note warning flat"><p><strong>éœ€è¦æ³¨æ„çš„ç»†èŠ‚é—®é¢˜</strong></p>
</div>
<p><strong>åŸå­æ€§ä¿è¯</strong>ï¼š</p>
<ul>
<li>âœ… <strong>Luaè„šæœ¬</strong>ï¼šæ‰€æœ‰Redisæ“ä½œä¸€æ¬¡æ€§æ‰§è¡Œ</li>
<li>âœ… <strong>å•çº¿ç¨‹æ¨¡å‹</strong>ï¼šRediså•çº¿ç¨‹ä¿è¯è„šæœ¬æ‰§è¡Œä¸è¢«æ‰“æ–­</li>
<li>âŒ <strong>äº‹åŠ¡</strong>ï¼šMULTI/EXECæ— æ³•ä¿è¯åº“å­˜å’Œè®¢å•çš„åŸå­æ€§</li>
</ul>
<p><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼š</p>
<ul>
<li><strong>åº“å­˜Key</strong>ï¼š<code>seckill:stock:{voucherId}</code></li>
<li><strong>è®¢å•Key</strong>ï¼š<code>seckill:order:{voucherId}</code></li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼š<code>stream.orders</code></li>
</ul>
<p><strong>è¿”å›å€¼è®¾è®¡</strong>ï¼š</p>
<ul>
<li><code>0</code>ï¼šæŠ¢è´­æˆåŠŸ</li>
<li><code>1</code>ï¼šåº“å­˜ä¸è¶³</li>
<li><code>2</code>ï¼šé‡å¤ä¸‹å•</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="6-3-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–">6.3 åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h3>
<div class="tabs" id="blocking-queue"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#blocking-queue-1">å®ç°æ€è·¯</button></li><li class="tab"><button type="button" data-href="#blocking-queue-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#blocking-queue-3">å®Œæ•´ä»£ç </button></li><li class="tab"><button type="button" data-href="#blocking-queue-4">ä¼˜ç¼ºç‚¹</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="blocking-queue-1"><p><strong>é˜»å¡é˜Ÿåˆ—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆ</strong></p>
<div class="note info flat"><p><strong>å†…å­˜é˜Ÿåˆ— + å•çº¿ç¨‹å¼‚æ­¥å¤„ç†</strong></p>
</div>
<p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼š</p>
<ol>
<li><strong>å¿«é€Ÿå“åº”</strong>ï¼šLuaè„šæœ¬æ ¡éªŒé€šè¿‡åç«‹å³è¿”å›è®¢å•ID</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šè®¢å•ä¿¡æ¯æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåå°çº¿ç¨‹æ…¢æ…¢å¤„ç†</li>
<li><strong>æµé‡å‰Šå³°</strong>ï¼šé˜»å¡é˜Ÿåˆ—ç¼“å†²ç¬æ—¶é«˜å¹¶å‘è¯·æ±‚</li>
</ol>
<p><strong>å®ç°æ¶æ„</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è¯·æ±‚ â†’ Luaè„šæœ¬æ ¡éªŒ â†’ å†…å­˜é˜Ÿåˆ— â†’ å•çº¿ç¨‹å¤„ç† â†’ æ•°æ®åº“æ“ä½œ</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blocking-queue-2"><p><strong>çº¿ç¨‹æ± é…ç½®</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> </span><br><span class="line">    Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»åˆå§‹åŒ–åç«‹å³æ‰§è¡Œ</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è®¢å•å¤„ç†å™¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">// 2.å¤„ç†è®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">// åˆ›å»ºé”å¯¹è±¡ï¼Œé˜²æ­¢é‡å¤ä¸‹å•</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.lock();</span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼šSpringäº‹åŠ¡åœ¨ThreadLocalä¸­ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¤±æ•ˆ</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">           log.error(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        save(voucherOrder);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é˜»å¡é˜Ÿåˆ—å®šä¹‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¢å•é˜»å¡é˜Ÿåˆ—ï¼Œå®¹é‡1024*1024</span></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
<p><strong>ä¸šåŠ¡å±‚ä¿®æ”¹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">        SECKILL_SCRIPT,</span><br><span class="line">        Collections.emptyList(),</span><br><span class="line">        voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœ</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.åˆ›å»ºè®¢å•å¯¹è±¡</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blocking-queue-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.Result;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.VoucherOrder;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.mapper.VoucherOrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.ISeckillVoucherService;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.IVoucherOrderService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.RedisIdWorker;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.UserHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * æœåŠ¡å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Kyle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022-10-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;seckill.lua&quot;</span>));</span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//1. è·å–ç”¨æˆ·</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">//2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//3. è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ </span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">//2. åˆ›å»ºè®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(), voucherId.toString(),</span><br><span class="line">                UserHolder.getUser().getId().toString());</span><br><span class="line">        <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// proxy = (IVoucherOrderService) AopContext.currentProxy();</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">voucherId</span> <span class="operator">=</span> voucherOrder.getVoucherId();</span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                    .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                    .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    .update();</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">            save(voucherOrder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blocking-queue-4"><p><strong>é˜»å¡é˜Ÿåˆ—æ–¹æ¡ˆä¼˜ç¼ºç‚¹</strong></p>
<div class="note warning flat"><p><strong>å†…å­˜é˜Ÿåˆ—çš„å±€é™æ€§</strong></p>
</div>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å®ç°ç®€å•</strong>ï¼šJDKåŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–ä¾èµ–</li>
<li>âœ… <strong>æ€§èƒ½ä¼˜ç§€</strong>ï¼šå†…å­˜æ“ä½œï¼Œå»¶è¿Ÿæä½</li>
<li>âœ… <strong>å‰Šå³°å¡«è°·</strong>ï¼šç¼“å†²ç¬æ—¶é«˜å¹¶å‘è¯·æ±‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>âŒ <strong>å†…å­˜é™åˆ¶</strong>ï¼šé˜Ÿåˆ—å®¹é‡æœ‰é™ï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±</li>
<li>âŒ <strong>å•ç‚¹æ•…éšœ</strong>ï¼šJVMå®•æœºå¯¼è‡´é˜Ÿåˆ—æ•°æ®ä¸¢å¤±</li>
<li>âŒ <strong>æ‰©å±•æ€§å·®</strong>ï¼šæ— æ³•åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œåªèƒ½å•æœºå¤„ç†</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å•æœºéƒ¨ç½²</strong>ï¼šåº”ç”¨éƒ¨ç½²åœ¨å•å°æœåŠ¡å™¨</li>
<li>âœ… <strong>æ•°æ®å¯æ¥å—ä¸¢å¤±</strong>ï¼šç§’æ€æ´»åŠ¨æ•°æ®å…è®¸å°‘é‡ä¸¢å¤±</li>
<li>âŒ <strong>åˆ†å¸ƒå¼éƒ¨ç½²</strong>ï¼šéœ€è¦å¤šæœºååŒå¤„ç†</li>
<li>âŒ <strong>æ•°æ®å¼ºä¸€è‡´æ€§</strong>ï¼šè®¢å•æ•°æ®ä¸èƒ½ä¸¢å¤±</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p><strong>å°æ€»ç»“ï¼š</strong></p>
<p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
<li>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ
<ul>
<li>å†…å­˜é™åˆ¶é—®é¢˜</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜</li>
</ul>
</li>
</ul>
<h2 id="7-Redisæ¶ˆæ¯é˜Ÿåˆ—">7. Redisæ¶ˆæ¯é˜Ÿåˆ—</h2>
<h3 id="7-1-1-æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€">7.1.1 æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€</h3>
<div class="tabs" id="mq-basics"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mq-basics-1">åŸºæœ¬æ¦‚å¿µ</button></li><li class="tab"><button type="button" data-href="#mq-basics-2">ä½¿ç”¨åœºæ™¯</button></li><li class="tab"><button type="button" data-href="#mq-basics-3">Rediså®ç°æ–¹æ¡ˆ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mq-basics-1"><p><strong>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<div class="note info flat"><p><strong>æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒæ¦‚å¿µ</strong></p>
</div>
<p><strong>å®šä¹‰</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œç”¨äºåœ¨ä¸åŒç»„ä»¶æˆ–ç³»ç»Ÿä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚</p>
<p><strong>ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²</strong>ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯çš„æ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li>
<li><strong>ç”Ÿäº§è€…</strong>ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨æˆ–æœåŠ¡</li>
<li><strong>æ¶ˆè´¹è€…</strong>ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†çš„åº”ç”¨æˆ–æœåŠ¡</li>
</ul>
<p><strong>é€šä¿¡æ¨¡å‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”Ÿäº§è€… â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mq-basics-2"><p><strong>æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨åœºæ™¯</strong></p>
<div class="note success flat"><p><strong>è§£è€¦å’Œå¼‚æ­¥å¤„ç†</strong></p>
</div>
<p><strong>ç”Ÿæ´»ä¾‹å­</strong>ï¼šå¿«é€’æŸœç³»ç»Ÿ</p>
<ul>
<li><strong>å¿«é€’å‘˜ï¼ˆç”Ÿäº§è€…ï¼‰</strong>ï¼šæŠŠå¿«é€’æ”¾å…¥å¿«é€’æŸœ</li>
<li><strong>å¿«é€’æŸœï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰</strong>ï¼šä¸´æ—¶å­˜å‚¨å¿«é€’</li>
<li><strong>ç”¨æˆ·ï¼ˆæ¶ˆè´¹è€…ï¼‰</strong>ï¼šä»å¿«é€’æŸœå–å¿«é€’</li>
</ul>
<p><strong>æŠ€æœ¯ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>è§£è€¦</strong>ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸éœ€è¦ç›´æ¥é€šä¿¡</li>
<li><strong>å¼‚æ­¥</strong>ï¼šç”Ÿäº§è€…ä¸éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†å®Œæˆ</li>
<li><strong>å‰Šå³°å¡«è°·</strong>ï¼šç¼“å†²ç¬æ—¶é«˜å¹¶å‘è¯·æ±‚</li>
<li><strong>å¯é æ€§</strong>ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼Œç¡®ä¿ä¸ä¸¢å¤±</li>
</ul>
<p><strong>ç§’æ€åœºæ™¯åº”ç”¨</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹å•æ ¡éªŒ â†’ Redisé˜Ÿåˆ— â†’ å¼‚æ­¥å¤„ç†è®¢å•</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mq-basics-3"><p><strong>Redisæ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆ</strong></p>
<div class="note warning flat"><p><strong>Redisæä¾›çš„ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—å®ç°</strong></p>
</div>
<table>
<thead>
<tr>
<th>å®ç°æ–¹å¼</th>
<th>æ•°æ®ç»“æ„</th>
<th>ç‰¹ç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Listé˜Ÿåˆ—</strong></td>
<td>List</td>
<td>ç®€å•å¯é ï¼Œæ”¯æŒé˜»å¡</td>
<td>ç®€å•æ¶ˆæ¯ä¼ é€’</td>
</tr>
<tr>
<td><strong>PubSub</strong></td>
<td>å‘å¸ƒè®¢é˜…</td>
<td>å®æ—¶æ¨é€ï¼Œä¸æ”¯æŒæŒä¹…åŒ–</td>
<td>å®æ—¶é€šçŸ¥</td>
</tr>
<tr>
<td><strong>Stream</strong></td>
<td>Stream</td>
<td>åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒæŒä¹…åŒ–</td>
<td>å¤æ‚æ¶ˆæ¯ç³»ç»Ÿ</td>
</tr>
</tbody>
</table>
<p><strong>é€‰æ‹©å»ºè®®</strong>ï¼š</p>
<ul>
<li>âœ… <strong>ç®€å•åœºæ™¯</strong>ï¼šä½¿ç”¨Listå®ç°</li>
<li>âœ… <strong>å®æ—¶é€šçŸ¥</strong>ï¼šä½¿ç”¨PubSub</li>
<li>âœ… <strong>å¤æ‚ä¸šåŠ¡</strong>ï¼šä½¿ç”¨Stream</li>
<li>âŒ <strong>å¤§æ•°æ®é‡</strong>ï¼šå»ºè®®ä½¿ç”¨ä¸“ä¸šMQï¼ˆKafkaã€RabbitMQï¼‰</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="7-1-2-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">7.1.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>
<div class="tabs" id="list-mq"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#list-mq-1">å®ç°åŸç†</button></li><li class="tab"><button type="button" data-href="#list-mq-2">ä»£ç ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#list-mq-3">ä¼˜ç¼ºç‚¹åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="list-mq-1"><p><strong>Listç»“æ„æ¶ˆæ¯é˜Ÿåˆ—åŸç†</strong></p>
<div class="note info flat"><p><strong>åŒå‘é“¾è¡¨å®ç°é˜Ÿåˆ—æ•ˆæœ</strong></p>
</div>
<p><strong>åŸºæœ¬åŸç†</strong>ï¼šRedisçš„Listæ˜¯åŒå‘é“¾è¡¨ï¼Œå¤©ç„¶æ”¯æŒé˜Ÿåˆ—æ“ä½œ</p>
<p><strong>æ“ä½œå‘½ä»¤</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ç”Ÿäº§è€…ï¼šä»å·¦ä¾§å…¥é˜Ÿ</span><br><span class="line">LPUSH queue_name message</span><br><span class="line"></span><br><span class="line"># æ¶ˆè´¹è€…ï¼šä»å³ä¾§å‡ºé˜Ÿ  </span><br><span class="line">RPOP queue_name</span><br><span class="line"></span><br><span class="line"># é˜»å¡å¼æ¶ˆè´¹ï¼ˆæ¨èï¼‰</span><br><span class="line">BRPOP queue_name timeout</span><br></pre></td></tr></table></figure>
<p><strong>é˜Ÿåˆ—æ¨¡å‹</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”Ÿäº§è€… â†’ LPUSH â†’ [message3, message2, message1] â†’ RPOP â†’ æ¶ˆè´¹è€…</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="list-mq-2"><p><strong>Listæ¶ˆæ¯é˜Ÿåˆ—å®ç°</strong></p>
<p><strong>ç”Ÿäº§è€…ä»£ç </strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—</span></span><br><span class="line">stringRedisTemplate.opsForList().leftPush(<span class="string">&quot;queue:order&quot;</span>, message);</span><br></pre></td></tr></table></figure>
<p><strong>æ¶ˆè´¹è€…ä»£ç </strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜»å¡å¼è·å–æ¶ˆæ¯ï¼ˆè¶…æ—¶5ç§’ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> stringRedisTemplate.opsForList()</span><br><span class="line">    .rightPop(<span class="string">&quot;queue:order&quot;</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    processMessage(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰¹é‡å¤„ç†</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€æ¬¡è·å–å¤šæ¡æ¶ˆæ¯</span></span><br><span class="line">List&lt;String&gt; messages = stringRedisTemplate.opsForList()</span><br><span class="line">    .range(<span class="string">&quot;queue:order&quot;</span>, <span class="number">0</span>, <span class="number">99</span>);</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="list-mq-3"><p><strong>Listæ¶ˆæ¯é˜Ÿåˆ—ä¼˜ç¼ºç‚¹</strong></p>
<div class="note warning flat"><p><strong>ç®€å•ä½†åŠŸèƒ½æœ‰é™</strong></p>
</div>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å®ç°ç®€å•</strong>ï¼šRedisåŸç”ŸListç»“æ„ï¼Œæ— éœ€é¢å¤–é…ç½®</li>
<li>âœ… <strong>æŒä¹…åŒ–æ”¯æŒ</strong>ï¼šåŸºäºRedisæŒä¹…åŒ–ï¼Œæ•°æ®å®‰å…¨</li>
<li>âœ… <strong>æœ‰åºæ€§</strong>ï¼šæ¶ˆæ¯æŒ‰å…¥é˜Ÿé¡ºåºæ¶ˆè´¹</li>
<li>âœ… <strong>å†…å­˜å¤§</strong>ï¼šä¸å—JVMå†…å­˜é™åˆ¶</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>âŒ <strong>æ¶ˆæ¯ä¸¢å¤±</strong>ï¼šæ¶ˆè´¹è€…å¤„ç†å¤±è´¥æ—¶æ¶ˆæ¯å·²åˆ é™¤</li>
<li>âŒ <strong>å•æ¶ˆè´¹è€…</strong>ï¼šä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</li>
<li>âŒ <strong>æ— ACKæœºåˆ¶</strong>ï¼šæ— æ³•ç¡®è®¤æ¶ˆæ¯æ˜¯å¦æˆåŠŸå¤„ç†</li>
<li>âŒ <strong>æ— é‡è¯•æœºåˆ¶</strong>ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ— æ³•é‡æ–°æ¶ˆè´¹</li>
</ul>
<p><strong>æ”¹è¿›æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯ç¡®è®¤</strong>ï¼šæ¶ˆè´¹åä¸ç«‹å³åˆ é™¤ï¼Œå…ˆæ”¾å…¥&quot;å¤„ç†ä¸­&quot;åˆ—è¡¨</li>
<li><strong>å¤±è´¥é‡è¯•</strong>ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯é‡æ–°æ”¾å›é˜Ÿåˆ—</li>
<li><strong>å¤šæ¶ˆè´¹è€…</strong>ï¼šä½¿ç”¨å¤šä¸ªé˜Ÿåˆ—å®ç°æ¶ˆè´¹è€…ç»„</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="7-1-3-åŸºäºPubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—">7.1.3 åŸºäºPubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>
<div class="tabs" id="pubsub-mq"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#pubsub-mq-1">åŸºæœ¬åŸç†</button></li><li class="tab"><button type="button" data-href="#pubsub-mq-2">ä»£ç ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#pubsub-mq-3">ä¼˜ç¼ºç‚¹åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="pubsub-mq-1"><p><strong>PubSubå‘å¸ƒè®¢é˜…æ¨¡å‹</strong></p>
<div class="note info flat"><p><strong>é¢‘é“(Channel)å¹¿æ’­æœºåˆ¶</strong></p>
</div>
<p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p>
<ul>
<li><strong>é¢‘é“(Channel)</strong>ï¼šæ¶ˆæ¯å‘å¸ƒçš„é€šé“</li>
<li><strong>è®¢é˜…è€…(Subscriber)</strong>ï¼šè®¢é˜…é¢‘é“çš„å®¢æˆ·ç«¯</li>
<li><strong>å‘å¸ƒè€…(Publisher)</strong>ï¼šå‘é¢‘é“å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯</li>
</ul>
<p><strong>åŸºæœ¬å‘½ä»¤</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># è®¢é˜…é¢‘é“</span><br><span class="line">SUBSCRIBE channel1 channel2</span><br><span class="line"></span><br><span class="line"># å‘å¸ƒæ¶ˆæ¯</span><br><span class="line">PUBLISH channel1 &quot;hello world&quot;</span><br><span class="line"></span><br><span class="line"># æ¨¡å¼è®¢é˜…ï¼ˆé€šé…ç¬¦ï¼‰</span><br><span class="line">PSUBSCRIBE news.*</span><br></pre></td></tr></table></figure>
<p><strong>æ¶ˆæ¯æµ</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‘å¸ƒè€… â†’ PUBLISH â†’ Channel â†’ å¹¿æ’­ â†’ æ‰€æœ‰è®¢é˜…è€…</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="pubsub-mq-2"><p><strong>PubSubæ¶ˆæ¯é˜Ÿåˆ—å®ç°</strong></p>
<p><strong>æ¶ˆæ¯å‘å¸ƒè€…</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">stringRedisTemplate.convertAndSend(<span class="string">&quot;order.channel&quot;</span>, orderMessage);</span><br></pre></td></tr></table></figure>
<p><strong>æ¶ˆæ¯è®¢é˜…è€…</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMessageSubscriber</span> <span class="keyword">extends</span> <span class="title class_">KeyspaceEventMessageListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderMessageSubscriber</span><span class="params">(RedisMessageListenerContainer listenerContainer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(listenerContainer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getChannel());</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;order.channel&quot;</span>.equals(channel)) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†è®¢å•æ¶ˆæ¯</span></span><br><span class="line">            processOrderMessage(body);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é…ç½®ç›‘å¬å™¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">container</span><span class="params">(</span></span><br><span class="line"><span class="params">        RedisConnectionFactory connectionFactory,</span></span><br><span class="line"><span class="params">        OrderMessageSubscriber subscriber)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">RedisMessageListenerContainer</span> <span class="variable">container</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line">    container.setConnectionFactory(connectionFactory);</span><br><span class="line">    container.addMessageListener(subscriber, <span class="keyword">new</span> <span class="title class_">ChannelTopic</span>(<span class="string">&quot;order.channel&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="pubsub-mq-3"><p><strong>PubSubæ¶ˆæ¯é˜Ÿåˆ—ä¼˜ç¼ºç‚¹</strong></p>
<div class="note danger flat"><p><strong>å®æ—¶ä½†ä¸å¯é </strong></p>
</div>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å®æ—¶æ€§</strong>ï¼šæ¶ˆæ¯ç«‹å³æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…</li>
<li>âœ… <strong>å¤šè®¢é˜…è€…</strong>ï¼šä¸€ä¸ªæ¶ˆæ¯å¯è¢«å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¥æ”¶</li>
<li>âœ… <strong>ç®€å•æ˜“ç”¨</strong>ï¼šRedisåŸç”Ÿæ”¯æŒï¼Œé…ç½®ç®€å•</li>
<li>âœ… <strong>æ¨¡å¼åŒ¹é…</strong>ï¼šæ”¯æŒé€šé…ç¬¦è®¢é˜…å¤šä¸ªé¢‘é“</li>
</ul>
<p><strong>ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>âŒ <strong>æ— æŒä¹…åŒ–</strong>ï¼šæ¶ˆæ¯ä¸å­˜å‚¨ï¼Œè®¢é˜…è€…ç¦»çº¿æ—¶æ¶ˆæ¯ä¸¢å¤±</li>
<li>âŒ <strong>æ— ç¡®è®¤æœºåˆ¶</strong>ï¼šæ— æ³•ä¿è¯æ¶ˆæ¯è¢«æˆåŠŸå¤„ç†</li>
<li>âŒ <strong>æ— é‡è¯•æœºåˆ¶</strong>ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ— æ³•é‡æ–°æŠ•é€’</li>
<li>âŒ <strong>å†…å­˜å‹åŠ›</strong>ï¼šå¤§é‡è®¢é˜…è€…å¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜</li>
</ul>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>âœ… <strong>å®æ—¶é€šçŸ¥</strong>ï¼šç³»ç»ŸçŠ¶æ€å˜æ›´ã€é…ç½®æ›´æ–°ç­‰</li>
<li>âœ… <strong>å¹¿æ’­æ¶ˆæ¯</strong>ï¼šéœ€è¦å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¥æ”¶çš„åœºæ™¯</li>
<li>âŒ <strong>é‡è¦ä¸šåŠ¡</strong>ï¼šè®¢å•å¤„ç†ã€æ”¯ä»˜ç­‰å…³é”®ä¸šåŠ¡</li>
<li>âŒ <strong>ç¦»çº¿å¤„ç†</strong>ï¼šæ¶ˆè´¹è€…å¯èƒ½ç¦»çº¿çš„åœºæ™¯</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>
ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li>
</ul>
<h3 id="7-1-4-åŸºäºStreamå®ç°æ¶ˆæ¯é˜Ÿåˆ—">7.1.4 åŸºäºStreamå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>
<div class="tabs" id="stream-mq"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#stream-mq-1">åŸºæœ¬åŸç†</button></li><li class="tab"><button type="button" data-href="#stream-mq-2">ä»£ç ç¤ºä¾‹</button></li><li class="tab"><button type="button" data-href="#stream-mq-3">ä¼˜ç¼ºç‚¹åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="stream-mq-1"><p><strong>å®ç°åŸç†</strong></p>
<p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„æ–°æ•°æ®ç±»å‹ï¼Œä¸“é—¨ç”¨äºå®ç°æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯å­˜å‚¨</strong>ï¼šæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰å”¯ä¸€IDï¼Œæ ¼å¼ä¸º<code>æ—¶é—´æˆ³-åºåˆ—å·</code></li>
<li><strong>æ¶ˆè´¹è€…ç»„</strong>ï¼šæ”¯æŒå¤šæ¶ˆè´¹è€…ç»„åŒæ—¶æ¶ˆè´¹ï¼Œäº’ä¸å¹²æ‰°</li>
<li><strong>ACKæœºåˆ¶</strong>ï¼šæ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åéœ€è¦ç¡®è®¤ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡</li>
</ul>
<p><strong>æ ¸å¿ƒå‘½ä»¤</strong>ï¼š</p>
<ul>
<li><code>XADD</code>ï¼šå‘é€æ¶ˆæ¯</li>
<li><code>XREAD</code>ï¼šè¯»å–æ¶ˆæ¯</li>
<li><code>XREADGROUP</code>ï¼šæ¶ˆè´¹è€…ç»„è¯»å–</li>
<li><code>XACK</code>ï¼šæ¶ˆæ¯ç¡®è®¤</li>
</ul>
<div class="note flat"><p>Streamç›¸æ¯”Listå’ŒPubSubï¼Œæä¾›äº†æ›´å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ã€æ¶ˆè´¹è€…ç»„å’ŒACKæœºåˆ¶ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="stream-mq-2"><p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<p><strong>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€æ¶ˆæ¯åˆ°Stream</span></span><br><span class="line">Map&lt;String, Object&gt; message = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">message.put(<span class="string">&quot;voucherId&quot;</span>, voucherId);</span><br><span class="line">message.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">message.put(<span class="string">&quot;orderId&quot;</span>, orderId);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">recordId</span> <span class="operator">=</span> stringRedisTemplate.opsForStream()</span><br><span class="line">    .add(<span class="string">&quot;stream.orders&quot;</span>, message);</span><br></pre></td></tr></table></figure>
<p><strong>æ¶ˆè´¹è€…ç»„æ¶ˆè´¹</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream()</span><br><span class="line">                    .read(Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                          StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                          StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed()));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// åˆ›å»ºè®¢å•</span></span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç¡®è®¤æ¶ˆæ¯</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;stream.orders&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                handlePendingList(); <span class="comment">// å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†pending-listä¸­çš„å¼‚å¸¸æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream()</span><br><span class="line">                    .read(Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                          StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                          StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>)));</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                </span><br><span class="line">                createVoucherOrder(voucherOrder);</span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;stream.orders&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†pendingè®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="stream-mq-3"><p><strong>ä¼˜ç¼ºç‚¹åˆ†æ</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Stream</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¶ˆæ¯æŒä¹…åŒ–</td>
<td>âœ… æ”¯æŒ</td>
<td>æ¶ˆæ¯ä¿å­˜åœ¨å†…å­˜å’Œç£ç›˜ä¸­</td>
</tr>
<tr>
<td>æ¶ˆæ¯å›æº¯</td>
<td>âœ… æ”¯æŒ</td>
<td>å¯ä»¥è¯»å–å†å²æ¶ˆæ¯</td>
</tr>
<tr>
<td>æ¶ˆè´¹è€…ç»„</td>
<td>âœ… æ”¯æŒ</td>
<td>å¤šç»„æ¶ˆè´¹è€…ç‹¬ç«‹æ¶ˆè´¹</td>
</tr>
<tr>
<td>ACKæœºåˆ¶</td>
<td>âœ… æ”¯æŒ</td>
<td>ä¿è¯æ¶ˆæ¯è‡³å°‘æ¶ˆè´¹ä¸€æ¬¡</td>
</tr>
<tr>
<td>æ¶ˆæ¯å †ç§¯</td>
<td>âœ… æ”¯æŒ</td>
<td>å†…å­˜è¶³å¤Ÿæ—¶å¯å †ç§¯å¤§é‡æ¶ˆæ¯</td>
</tr>
<tr>
<td>å®ç°å¤æ‚åº¦</td>
<td>â­â­â­ ä¸­ç­‰</td>
<td>éœ€è¦ç†è§£æ¶ˆè´¹è€…ç»„æ¦‚å¿µ</td>
</tr>
</tbody>
</table>
<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>éœ€è¦æ¶ˆæ¯æŒä¹…åŒ–çš„ä¸šåŠ¡åœºæ™¯</li>
<li>å¤šæ¶ˆè´¹è€…ç»„ç‹¬ç«‹æ¶ˆè´¹</li>
<li>æ¶ˆæ¯å¤„ç†å¯é æ€§è¦æ±‚é«˜çš„åœºæ™¯</li>
<li>å¤æ‚çš„ç§’æ€è®¢å•å¤„ç†</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="7-1-5-æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”æ€»ç»“">7.1.5 æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”æ€»ç»“</h3>
<div class="tabs" id="mq-compare"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#mq-compare-1">åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”</button></li><li class="tab"><button type="button" data-href="#mq-compare-2">æ€§èƒ½å¯¹æ¯”</button></li><li class="tab"><button type="button" data-href="#mq-compare-3">é€‰æ‹©å»ºè®®</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="mq-compare-1"><p><strong>åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½ç‰¹æ€§</th>
<th>Listç»“æ„</th>
<th>PubSub</th>
<th>Stream</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¶ˆæ¯æŒä¹…åŒ–</td>
<td>âœ… æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆæ¯å›æº¯</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆè´¹è€…ç»„</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆæ¯ç¡®è®¤</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âŒ ä¸æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
</tr>
<tr>
<td>é˜»å¡è¯»å–</td>
<td>âœ… æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
<td>âœ… æ”¯æŒ</td>
</tr>
<tr>
<td>æ¶ˆæ¯å †ç§¯</td>
<td>å—å†…å­˜é™åˆ¶</td>
<td>å—å†…å­˜é™åˆ¶</td>
<td>å—å†…å­˜é™åˆ¶</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mq-compare-2"><p><strong>æ€§èƒ½å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>æ€§èƒ½æŒ‡æ ‡</th>
<th>List</th>
<th>PubSub</th>
<th>Stream</th>
</tr>
</thead>
<tbody>
<tr>
<td>ååé‡</td>
<td>é«˜</td>
<td>æœ€é«˜</td>
<td>é«˜</td>
</tr>
<tr>
<td>å»¶è¿Ÿ</td>
<td>ä½</td>
<td>æœ€ä½</td>
<td>ä½</td>
</tr>
<tr>
<td>CPUæ¶ˆè€—</td>
<td>ä½</td>
<td>æœ€ä½</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>å†…å­˜ä½¿ç”¨</td>
<td>ä½</td>
<td>ä½</td>
<td>ä¸­ç­‰</td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="mq-compare-3"><p><strong>é€‰æ‹©å»ºè®®</strong></p>
<ul>
<li><strong>Listé˜Ÿåˆ—</strong>ï¼šç®€å•çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¯¹å¯é æ€§è¦æ±‚ä¸é«˜</li>
<li><strong>PubSub</strong>ï¼šå®æ—¶æ¶ˆæ¯æ¨é€ï¼Œå…è®¸æ¶ˆæ¯ä¸¢å¤±çš„åœºæ™¯</li>
<li><strong>Stream</strong>ï¼šä¸šåŠ¡æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦é«˜å¯é æ€§å’Œå®Œæ•´åŠŸèƒ½</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="8-è¾¾äººæ¢åº—">8. è¾¾äººæ¢åº—</h2>
<div class="note flat"><p>å‘å¸ƒæ¢åº—ç¬”è®°</p>
<p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š<br>
tb_blogï¼šæ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰</p>
<p><strong>tb_blogè¡¨ç»“æ„ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Collation</th>
<th>Null</th>
<th>Key</th>
<th>Default</th>
<th>Extra</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td>PRI</td>
<td>(NULL)</td>
<td>auto_increment</td>
<td>ä¸»é”®</td>
</tr>
<tr>
<td>shop_id</td>
<td>bigint</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>å•†æˆ·id</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>ç”¨æˆ·id</td>
</tr>
<tr>
<td>title</td>
<td>varchar(255)</td>
<td>utf8mb4_unicode_ci</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>æ ‡é¢˜</td>
</tr>
<tr>
<td>images</td>
<td>varchar(2048)</td>
<td>utf8mb4_general_ci</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>æ¢åº—çš„ç…§ç‰‡ï¼Œæœ€å¤š9å¼ ï¼Œå¤šå¼ ä»¥&quot;,&quot;éš”å¼€</td>
</tr>
<tr>
<td>content</td>
<td>varchar(2048)</td>
<td>utf8mb4_unicode_ci</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>æ¢åº—çš„æ–‡å­—æè¿°</td>
</tr>
<tr>
<td>liked</td>
<td>int unsigned</td>
<td>(NULL)</td>
<td>YES</td>
<td></td>
<td>0</td>
<td></td>
<td>ç‚¹èµæ•°é‡</td>
</tr>
<tr>
<td>comments</td>
<td>int unsigned</td>
<td>(NULL)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>è¯„è®ºæ•°é‡</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td>DEFAULT_GENERATED</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>update_time</td>
<td>timestamp</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td>DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td>æ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<p>tb_blog_commentsï¼šå…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</p>
<p><strong>tb_blog_commentsè¡¨ç»“æ„ï¼š</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Collation</th>
<th>Null</th>
<th>Key</th>
<th>Default</th>
<th>Extra</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td>PRI</td>
<td>(NULL)</td>
<td>auto_increment</td>
<td>ä¸»é”®</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>ç”¨æˆ·id</td>
</tr>
<tr>
<td>blog_id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>æ¢åº—id</td>
</tr>
<tr>
<td>parent_id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>å…³è”çš„1çº§è¯„è®ºidï¼Œå¦‚æœæ˜¯ä¸€çº§è¯„è®ºï¼Œåˆ™å€¼ä¸º0</td>
</tr>
<tr>
<td>answer_id</td>
<td>bigint unsigned</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>å›å¤çš„è¯„è®ºid</td>
</tr>
<tr>
<td>content</td>
<td>varchar(255)</td>
<td>utf8mb4_general_ci</td>
<td>NO</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>å›å¤çš„å†…å®¹</td>
</tr>
<tr>
<td>liked</td>
<td>int unsigned</td>
<td>(NULL)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>ç‚¹èµæ•°</td>
</tr>
<tr>
<td>status</td>
<td>tinyint unsigned</td>
<td>(NULL)</td>
<td>YES</td>
<td></td>
<td>(NULL)</td>
<td></td>
<td>çŠ¶æ€ï¼Œ0ï¼šæ­£å¸¸ï¼Œ1ï¼šè¢«ä¸¾æŠ¥ï¼Œ2ï¼šç¦æ­¢æŸ¥çœ‹</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td>DEFAULT_GENERATED</td>
<td>åˆ›å»ºæ—¶é—´</td>
</tr>
<tr>
<td>update_time</td>
<td>timestamp</td>
<td>(NULL)</td>
<td>NO</td>
<td></td>
<td>CURRENT_TIMESTAMP</td>
<td>DEFAULT_GENERATED on update CURRENT_TIMESTAMP</td>
<td>æ›´æ–°æ—¶é—´</td>
</tr>
</tbody>
</table>
<p>è¾¾äººæ¢åº—åŠŸèƒ½å…è®¸ç”¨æˆ·å‘å¸ƒæ¢åº—ç¬”è®°ï¼ŒåŒ…æ‹¬å›¾ç‰‡ä¸Šä¼ ã€ç¬”è®°å‘å¸ƒã€ç‚¹èµäº’åŠ¨ç­‰åŠŸèƒ½ã€‚æœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨Redisä¼˜åŒ–è¿™äº›åŠŸèƒ½çš„å®ç°ã€‚</p>
</div>
<p><strong>å¯¹åº”çš„å®ä½“ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;tb_blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blog</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long shopId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å›¾æ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å§“å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦ç‚¹èµè¿‡äº†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isLike;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¢åº—çš„ç…§ç‰‡ï¼Œæœ€å¤š9å¼ ï¼Œå¤šå¼ ä»¥&quot;,&quot;éš”å¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String images;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¢åº—çš„æ–‡å­—æè¿°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹èµæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer liked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer comments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ›´æ–°æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-1-å›¾ç‰‡ä¸Šä¼ ä¸ç¬”è®°å‘å¸ƒ">8.1 å›¾ç‰‡ä¸Šä¼ ä¸ç¬”è®°å‘å¸ƒ</h3>
<div class="tabs" id="blog-upload"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#blog-upload-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#blog-upload-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#blog-upload-3">å…³é”®ç‚¹åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="blog-upload-1"><p>æ¢åº—ç¬”è®°å‘å¸ƒåŒ…å«ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>å›¾ç‰‡ä¸Šä¼ </strong>ï¼šæ”¯æŒå•å¼ å›¾ç‰‡ä¸Šä¼ ï¼Œç”Ÿæˆå”¯ä¸€æ–‡ä»¶å</li>
<li><strong>ç¬”è®°å‘å¸ƒ</strong>ï¼šä¿å­˜æ¢åº—åšæ–‡ï¼Œå…³è”ä¸Šä¼ çš„å›¾ç‰‡</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-upload-2"><p><strong>å›¾ç‰‡ä¸Šä¼ æ§åˆ¶å™¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;blog&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadImage</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> image.getOriginalFilename();</span><br><span class="line">            <span class="comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> createNewFileName(originalFilename);</span><br><span class="line">            <span class="comment">// ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">            image.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> Result.ok(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬”è®°å‘å¸ƒæ§åˆ¶å™¨</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/blog&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">        blog.setUpdateTime(user.getId());</span><br><span class="line">        <span class="comment">//ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">        blogService.saveBlog(blog);</span><br><span class="line">        <span class="comment">//è¿”å›id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note flat"><p>æ³¨æ„ï¼šéœ€è¦ä¿®æ”¹<code>SystemConstants.IMAGE_UPLOAD_DIR</code>ä¸ºå®é™…çš„å›¾ç‰‡å­˜å‚¨è·¯å¾„ï¼Œç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®ä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-upload-3"><ol>
<li><strong>æ–‡ä»¶å‘½åç­–ç•¥</strong>ï¼šä½¿ç”¨UUIDç¡®ä¿æ–‡ä»¶åå”¯ä¸€æ€§ï¼Œé¿å…å†²çª</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šæ•è·IOå¼‚å¸¸å¹¶è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸</li>
<li><strong>ç”¨æˆ·è®¤è¯</strong>ï¼šé€šè¿‡<code>UserHolder</code>è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯</li>
<li><strong>è¿”å›å€¼è®¾è®¡</strong>ï¼šè¿”å›ç”Ÿæˆçš„æ–‡ä»¶åï¼Œä¾›å‰ç«¯å±•ç¤ºå’Œåç»­ä¸šåŠ¡ä½¿ç”¨</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="8-2-æŸ¥çœ‹æ¢åº—ç¬”è®°">8.2 æŸ¥çœ‹æ¢åº—ç¬”è®°</h3>
<div class="tabs" id="blog-query"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#blog-query-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#blog-query-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#blog-query-3">å…³é”®ç‚¹åˆ†æ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="blog-query-1"><p>æŸ¥çœ‹æ¢åº—ç¬”è®°åŠŸèƒ½éœ€è¦ï¼š</p>
<ul>
<li><strong>ç¬”è®°æŸ¥è¯¢</strong>ï¼šæ ¹æ®IDæŸ¥è¯¢ç¬”è®°è¯¦æƒ…</li>
<li><strong>ç”¨æˆ·ä¿¡æ¯</strong>ï¼šæŸ¥è¯¢ç¬”è®°ä½œè€…ä¿¡æ¯</li>
<li><strong>ç‚¹èµçŠ¶æ€</strong>ï¼šåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-query-2"><p><strong>controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/hot&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(<span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blogService.queryHotBlog(current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>service</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryHotBlog</span><span class="params">(Integer current)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">    Page&lt;Blog&gt; page = query()</span><br><span class="line">            .orderByDesc(<span class="string">&quot;liked&quot;</span>)</span><br><span class="line">            .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">    <span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">    List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    records.forEach(<span class="built_in">this</span>::queryBlogUser);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">Blog</span> <span class="variable">blog</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="keyword">if</span> (blog == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;è¯„ä»·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    queryBlogUser(blog);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">queryBlogUser</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> blog.getUserId();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getById(userId);</span><br><span class="line">    blog.setName(user.getNickName());</span><br><span class="line">    blog.setIcon(user.getIcon());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-query-3"><ol>
<li><strong>æ•°æ®å®Œæ•´æ€§</strong>ï¼šå…ˆæŸ¥è¯¢ç¬”è®°ï¼Œå†æŸ¥è¯¢å…³è”çš„ç”¨æˆ·ä¿¡æ¯</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šç¬”è®°ä¸å­˜åœ¨æ—¶ç»™å‡ºå‹å¥½æç¤º</li>
<li><strong>æ•°æ®ç»„è£…</strong>ï¼š<code>queryBlogUser</code>æ–¹æ³•è´Ÿè´£å¡«å……ç”¨æˆ·ç›¸å…³ä¿¡æ¯</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="8-3-ç‚¹èµåŠŸèƒ½ä¼˜åŒ–">8.3 ç‚¹èµåŠŸèƒ½ä¼˜åŒ–</h3>
<div class="tabs" id="blog-like"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#blog-like-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#blog-like-2">éœ€æ±‚ä¼˜åŒ–</button></li><li class="tab"><button type="button" data-href="#blog-like-3">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#blog-like-4">å‘é€è¯·æ±‚</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="blog-like-1"><p>åˆå§‹ç‚¹èµå®ç°å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹ç‚¹èµæ•°é‡</span></span><br><span class="line">    blogService.update().setSql(<span class="string">&quot;liked = liked +1 &quot;</span>).eq(<span class="string">&quot;id&quot;</span>,id).update();</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é—®é¢˜</strong>ï¼šç”¨æˆ·å¯ä»¥æ— é™ç‚¹èµï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶æœºåˆ¶</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-like-2"><ul>
<li>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤º</li>
<li>ä½¿ç”¨Redisçš„Seté›†åˆè®°å½•ç‚¹èµç”¨æˆ·ï¼Œä¿è¯å”¯ä¸€æ€§</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-like-3"><p><strong>1. ä¿®æ”¹Blogå®ä½“ç±»</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Boolean isLike; <span class="comment">// æ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</span></span><br></pre></td></tr></table></figure>
<p><strong>2. ç‚¹èµä¸šåŠ¡é€»è¾‘</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/like/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.likeBlog(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">        <span class="comment">//3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">        <span class="comment">//3.1 æ•°æ®åº“ç‚¹èµæ•°+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key,userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="comment">//4.1 æ•°æ®åº“ç‚¹èµæ•°-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>Redis Keyè®¾è®¡</strong>ï¼š<code>blog:liked:{blogId}</code>ï¼Œæ¯ä¸ªç¬”è®°ä¸€ä¸ªç‹¬ç«‹çš„Set</li>
<li><strong>åŸå­æ€§ä¿è¯</strong>ï¼šå…ˆåˆ¤æ–­å†æ“ä½œï¼Œé€šè¿‡Redis Setä¿è¯ç”¨æˆ·å”¯ä¸€æ€§</li>
<li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šæ•°æ®åº“å’ŒRedisåŒæ­¥æ›´æ–°ï¼Œç¡®ä¿ç‚¹èµæ•°å‡†ç¡®</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šRedis Setæ“ä½œO(1)æ—¶é—´å¤æ‚åº¦ï¼Œæ€§èƒ½ä¼˜å¼‚</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-like-4"><p><strong>ç‚¹å‡»ç‚¹èµæŒ‰é’®ï¼ŒæŸ¥çœ‹å‘é€çš„è¯·æ±‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚ç½‘å€: http://localhost:8080/api/blog/like/4</span><br><span class="line">è¯·æ±‚æ–¹æ³•: PUT</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="8-4-ç‚¹èµæ’è¡Œæ¦œ">8.4 ç‚¹èµæ’è¡Œæ¦œ</h3>
<div class="tabs" id="blog-ranking"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#blog-ranking-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#blog-ranking-2">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#blog-ranking-3">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="blog-ranking-1"><p>åœ¨æ¢åº—ç¬”è®°è¯¦æƒ…é¡µé¢éœ€è¦å±•ç¤ºç‚¹èµæ’è¡Œæ¦œï¼Œæ˜¾ç¤ºæœ€æ—©ç‚¹èµçš„TOP5ç”¨æˆ·ï¼š</p>
<ul>
<li><strong>æ’åºéœ€æ±‚</strong>ï¼šæŒ‰ç‚¹èµæ—¶é—´æ’åºï¼Œæœ€æ—©ç‚¹èµçš„æ’åœ¨å‰é¢</li>
<li><strong>å”¯ä¸€æ€§</strong>ï¼šæ¯ä¸ªç”¨æˆ·åªèƒ½å‡ºç°ä¸€æ¬¡</li>
<li><strong>æ€§èƒ½è¦æ±‚</strong>ï¼šå¿«é€ŸæŸ¥è¯¢TOP5ç”¨æˆ·</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-ranking-2"><p>ä½¿ç”¨Redisçš„SortedSetï¼ˆZSetï¼‰æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>å”¯ä¸€æ€§</strong>ï¼šZSetä¿è¯æˆå‘˜å”¯ä¸€</li>
<li><strong>æ’åºèƒ½åŠ›</strong>ï¼šæ ¹æ®scoreå€¼æ’åºï¼Œscoreä½¿ç”¨æ—¶é—´æˆ³</li>
<li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼šæ”¯æŒæŒ‰æ’åèŒƒå›´æŸ¥è¯¢</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="blog-ranking-3"><p><strong>1. ä¿®æ”¹ç‚¹èµé€»è¾‘ï¼ˆä½¿ç”¨ZSetï¼‰</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">        <span class="comment">// 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">// 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„zseté›†åˆï¼Œscoreä¸ºå½“å‰æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="comment">// 4.1.æ•°æ®åº“ç‚¹èµæ•° -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">// 4.2.æŠŠç”¨æˆ·ä»Redisçš„zseté›†åˆç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. æŸ¥è¯¢ç‚¹èµæ’è¡Œæ¦œ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">// 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>Scoreè®¾è®¡</strong>ï¼šä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºscoreï¼Œè‡ªç„¶æŒ‰æ—¶é—´æ’åº</li>
<li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼š<code>zrange key 0 4</code>è·å–å‰5ä¸ªç”¨æˆ·ï¼Œæ—¶é—´å¤æ‚åº¦O(log(n)+m)</li>
<li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šç‚¹èµå’Œå–æ¶ˆç‚¹èµæ—¶åŒæ­¥æ›´æ–°æ•°æ®åº“å’ŒRedis</li>
<li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šåªå­˜å‚¨ç”¨æˆ·IDï¼Œä¸å­˜å‚¨å®Œæ•´ç”¨æˆ·ä¿¡æ¯</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="9-å¥½å‹å…³æ³¨">9. å¥½å‹å…³æ³¨</h2>
<h3 id="9-1-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">9.1 å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3>
<p>é’ˆå¯¹ç”¨æˆ·çš„æ“ä½œï¼šå¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œå…³æ³¨å’Œå–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚</p>
<div class="tabs" id="follow-basic"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#follow-basic-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#follow-basic-2">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="follow-basic-1"><p>å¥½å‹å…³æ³¨åŠŸèƒ½å®ç°ç”¨æˆ·ä¹‹é—´çš„å…³æ³¨å…³ç³»ç®¡ç†ï¼š</p>
<ul>
<li><strong>å…³æ³¨ç”¨æˆ·</strong>ï¼šç”¨æˆ·Aå…³æ³¨ç”¨æˆ·B</li>
<li><strong>å–æ¶ˆå…³æ³¨</strong>ï¼šç”¨æˆ·Aå–æ¶ˆå¯¹ç”¨æˆ·Bçš„å…³æ³¨</li>
<li><strong>å…³æ³¨çŠ¶æ€æŸ¥è¯¢</strong>ï¼šæŸ¥è¯¢ç”¨æˆ·Aæ˜¯å¦å…³æ³¨äº†ç”¨æˆ·B</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="follow-basic-2"><p><strong>1. æ•°æ®åº“è¡¨ç»“æ„</strong>ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `tb_follow`  (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">0</span>) <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;ç”¨æˆ·id&#x27;</span>,</span><br><span class="line">  `follow_user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;å…³è”çš„ç”¨æˆ·id&#x27;</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> INDEX `idx_user_id_follow_user_id`(`user_id`, `follow_user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="keyword">CHARACTER SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;ç”¨æˆ·å…³æ³¨è¡¨&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong>2. æ§åˆ¶å™¨å±‚</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IFollowService followService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, </span></span><br><span class="line"><span class="params">                        <span class="meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.follow(followUserId, isFollow);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å…³æ³¨</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> followService.isFollow(followUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. ä¸šåŠ¡é€»è¾‘å±‚</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId).count();</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(count &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤æ•°æ®</span></span><br><span class="line">        remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>å”¯ä¸€ç´¢å¼•</strong>ï¼š<code>idx_user_id_follow_user_id</code>é˜²æ­¢é‡å¤å…³æ³¨</li>
<li><strong>äº‹åŠ¡æ€§</strong>ï¼šå…³æ³¨æ“ä½œåŒæ—¶æ“ä½œæ•°æ®åº“ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šé‡å¤å…³æ³¨æˆ–å–æ¶ˆå…³æ³¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå…³æ³¨çŠ¶æ€æŸ¥è¯¢ä½¿ç”¨countï¼Œæ¯”æŸ¥è¯¢å…¨è¡¨æ›´é«˜æ•ˆ</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="9-2-å…±åŒå…³æ³¨">9.2 å…±åŒå…³æ³¨</h3>
<div class="tabs" id="follow-common"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#follow-common-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#follow-common-2">æŠ€æœ¯æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#follow-common-3">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="follow-common-1"><p>åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨ï¼š</p>
<ul>
<li><strong>åœºæ™¯</strong>ï¼šç”¨æˆ·Aè®¿é—®ç”¨æˆ·Bçš„ä¸ªäººä¸»é¡µ</li>
<li><strong>éœ€æ±‚</strong>ï¼šæ˜¾ç¤ºAå’ŒBéƒ½å…³æ³¨çš„ç”¨æˆ·åˆ—è¡¨</li>
<li><strong>æŠ€æœ¯é€‰å‹</strong>ï¼šRedis Seté›†åˆçš„äº¤é›†æ“ä½œ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="follow-common-2"><p>ä½¿ç”¨Redis Setæ•°æ®ç»“æ„å­˜å‚¨å…³æ³¨å…³ç³»ï¼š</p>
<ul>
<li><strong>Keyè®¾è®¡</strong>ï¼š<code>follows:{userId}</code> å­˜å‚¨ç”¨æˆ·å…³æ³¨çš„æ‰€æœ‰äºº</li>
<li><strong>é›†åˆæ“ä½œ</strong>ï¼š<code>SINTER</code>å‘½ä»¤æ±‚ä¸¤ä¸ªé›†åˆçš„äº¤é›†</li>
<li><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼šSetæ“ä½œæ—¶é—´å¤æ‚åº¦O(N)ï¼Œæ¯”æ•°æ®åº“æŸ¥è¯¢æ›´é«˜æ•ˆ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="follow-common-3"><p><strong>1. æ”¹é€ å…³æ³¨é€»è¾‘ï¼ˆæ·»åŠ Redisç¼“å­˜ï¼‰</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (isFollow) &#123;</span><br><span class="line">        <span class="comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3.å–å…³ï¼Œåˆ é™¤æ•°æ®</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">            <span class="comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. å…±åŒå…³æ³¨æŸ¥è¯¢</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long targetUserId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">// 2.æ±‚äº¤é›†</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + targetUserId;</span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ— äº¤é›†</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è§£æidé›†åˆ</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 4.æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šæ•°æ®åº“å’ŒRedisåŒå†™ä¸€è‡´æ€§ï¼Œå…³æ³¨æˆåŠŸæ‰å†™å…¥Redis</li>
<li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šåªå­˜å‚¨ç”¨æˆ·IDï¼Œä¸å­˜å‚¨å®Œæ•´ç”¨æˆ·ä¿¡æ¯</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šäº¤é›†ä¸ºç©ºæ—¶è¿”å›ç©ºåˆ—è¡¨ï¼Œé¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸</li>
<li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šä½¿ç”¨<code>listByIds</code>æ‰¹é‡æŸ¥è¯¢ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="9-3-Feedæµå®ç°æ–¹æ¡ˆ">9.3 Feedæµå®ç°æ–¹æ¡ˆ</h3>
<p>å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·åï¼Œè¿™ä¸ªç”¨æˆ·å‘äº†åŠ¨æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œå…¶å®æˆ‘ä»¬åˆæŠŠä»–å«åšFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚</p>
<p>å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼çš„å†…å®¹è§£é”ï¼šæˆ‘ä»¬æ˜¯éœ€è¦ç”¨æˆ·å»é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–çš„æ–¹å¼å»è§£é”æƒ³è¦çœ‹çš„å†…å®¹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653808641260.png" alt="1653808641260"></p>
<p>å¯¹äºæ–°å‹çš„Feedæµçš„çš„æ•ˆæœï¼šä¸éœ€è¦æˆ‘ä»¬ç”¨æˆ·å†å»æ¨é€ä¿¡æ¯ï¼Œè€Œæ˜¯ç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ çš„èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨ä¸»åŠ¨å»å¯»æ‰¾ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653808993693.png" alt="1653808993693"></p>
<p>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼ï¼š<br>
Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
<p>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨<br>
æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</li>
</ul>
<p>æˆ‘ä»¬æœ¬æ¬¡é’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„å°±æ˜¯Timelineçš„æ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p>
<p>ï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ul>
<p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p>
<p>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰å°±æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››å’Œç‹äº”å‘äº†æ¶ˆæ¯åï¼Œéƒ½ä¼šä¿å­˜åœ¨è‡ªå·±çš„é‚®ç®±ä¸­ï¼Œå‡è®¾èµµå…­è¦è¯»å–ä¿¡æ¯ï¼Œé‚£ä¹ˆä»–ä¼šä»è¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼ŒæŠŠä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶ååœ¨è¿›è¡Œæ’åº</p>
<p>ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œè€Œä¸”è¯»å–å®Œä¹‹åå¯ä»¥æŠŠä»–çš„æ”¶ä»¶ç®±è¿›è¡Œæ¸…æ¥šã€‚</p>
<p>ç¼ºç‚¹ï¼šæ¯”è¾ƒå»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶æ‰å»å…³æ³¨çš„äººé‡Œè¾¹å»è¯»å–æ•°æ®ï¼Œå‡è®¾ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–æµ·é‡çš„å†…å®¹ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653809450816.png" alt="1653809450816"></p>
<p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p>
<p>æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨çš„æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­å»ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†</p>
<p>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</p>
<p>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šåˆ†æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653809875208.png" alt="1653809875208"></p>
<p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p>
<p>å‘ä»¶äººç«¯ç­–ç•¥ï¼š</p>
<ul>
<li>
<p>æ™®é€šç”¨æˆ·ï¼šé‡‡ç”¨&quot;æ¨&quot;æ¨¡å¼ï¼Œç›´æ¥å°†æ¶ˆæ¯å†™å…¥æ‰€æœ‰ç²‰ä¸çš„æ”¶ä»¶ç®±ï¼ˆç²‰ä¸å°‘ï¼Œå‹åŠ›å°ï¼‰</p>
</li>
<li>
<p>å¤§Vç”¨æˆ·ï¼šé‡‡ç”¨&quot;æ¨æ‹‰ç»“åˆ&quot;æ¨¡å¼ï¼Œæ¶ˆæ¯å…ˆå†™å…¥è‡ªå·±çš„å‘ä»¶ç®±ï¼Œç„¶ååªæ¨é€ç»™æ´»è·ƒç²‰ä¸<br>
æ”¶ä»¶äººç«¯ç­–ç•¥ï¼š</p>
</li>
<li>
<p>æ´»è·ƒç²‰ä¸ï¼šæ— è®ºæ˜¯å¤§Vè¿˜æ˜¯æ™®é€šç”¨æˆ·çš„æ¶ˆæ¯ï¼Œéƒ½ç›´æ¥æ¨é€åˆ°æ”¶ä»¶ç®±</p>
</li>
<li>
<p>æ™®é€šç²‰ä¸ï¼šåªåœ¨ä¸Šçº¿æ—¶ä»å‘ä»¶ç®±ä¸­æ‹‰å–æœªè¯»æ¶ˆæ¯<br>
æ ¸å¿ƒä¼˜åŠ¿ï¼š</p>
</li>
<li>
<p>å¹³è¡¡äº†ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ</p>
</li>
<li>
<p>é¿å…äº†ç»™æ‰€æœ‰ç²‰ä¸æ¨é€é€ æˆçš„å·¨å¤§å‹åŠ›</p>
</li>
<li>
<p>ä¿è¯äº†æ´»è·ƒç”¨æˆ·çš„å®æ—¶æ€§ä½“éªŒ</p>
</li>
<li>
<p>é™ä½äº†å­˜å‚¨å’Œè®¡ç®—æˆæœ¬</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653812346852.png" alt="1653812346852"></p>
<div class="tabs" id="feed-flow"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#feed-flow-1">éœ€æ±‚èƒŒæ™¯</button></li><li class="tab"><button type="button" data-href="#feed-flow-2">æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="feed-flow-1"><p>Feedæµï¼ˆå…³æ³¨æ¨é€ï¼‰ä¸ºç”¨æˆ·æä¾›æ²‰æµ¸å¼å†…å®¹æ¶ˆè´¹ä½“éªŒï¼š</p>
<ul>
<li><strong>Timelineæ¨¡å¼</strong>ï¼šæŒ‰æ—¶é—´æ’åºï¼Œä¿¡æ¯å…¨é¢ä½†å™ªéŸ³è¾ƒå¤š</li>
<li><strong>æ™ºèƒ½æ’åº</strong>ï¼šç®—æ³•æ¨èï¼Œç”¨æˆ·ç²˜åº¦é«˜ä½†å®ç°å¤æ‚</li>
<li><strong>æœ¬ä¾‹é€‰æ‹©</strong>ï¼šåŸºäºå¥½å‹å…³ç³»çš„Timelineæ¨¡å¼</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="feed-flow-2"><table>
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>åŸç†</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ‹‰æ¨¡å¼</strong></td>
<td>è¯»å–æ—¶ä»å…³æ³¨åˆ—è¡¨æ‹‰å–å†…å®¹</td>
<td>èŠ‚çœå­˜å‚¨ç©ºé—´</td>
<td>å»¶è¿Ÿé«˜ï¼Œå‹åŠ›å¤§</td>
<td>å°ç”¨æˆ·é‡</td>
</tr>
<tr>
<td><strong>æ¨æ¨¡å¼</strong></td>
<td>å‘å¸ƒæ—¶æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</td>
<td>æ—¶æ•ˆæ€§å¥½</td>
<td>å†…å­˜æ¶ˆè€—å¤§</td>
<td>æ™®é€šç”¨æˆ·</td>
</tr>
<tr>
<td><strong>æ¨æ‹‰ç»“åˆ</strong></td>
<td>æ™®é€šç”¨æˆ·æ¨ï¼Œå¤§Væ¨æ‹‰ç»“åˆ</td>
<td>å¹³è¡¡æ€§èƒ½</td>
<td>å®ç°å¤æ‚</td>
<td>å¤§ç”¨æˆ·é‡</td>
</tr>
</tbody>
</table>
<p><strong>å®ç°é€‰æ‹©</strong></p>
<p>æœ¬ä¾‹é‡‡ç”¨<strong>æ¨æ¨¡å¼</strong>å®ç°ï¼š</p>
<ul>
<li>ç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶ï¼Œä¸»åŠ¨æ¨é€åˆ°æ‰€æœ‰ç²‰ä¸çš„æ”¶ä»¶ç®±</li>
<li>ä½¿ç”¨Redis SortedSetå­˜å‚¨ï¼Œscoreä¸ºæ—¶é—´æˆ³</li>
<li>æ”¯æŒæŒ‰æ—¶é—´æ’åºå’Œåˆ†é¡µæŸ¥è¯¢</li>
</ul>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>æ•°æ®ç»“æ„</strong>ï¼š<code>ZSet&lt;blogId, timestamp&gt;</code> å¤©ç„¶æŒ‰æ—¶é—´æ’åº</li>
<li><strong>å†™å…¥ç­–ç•¥</strong>ï¼šå‘å¸ƒæ—¶åŒæ­¥å†™å…¥æ‰€æœ‰ç²‰ä¸æ”¶ä»¶ç®±</li>
<li><strong>è¯»å–ä¼˜åŒ–</strong>ï¼šæ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ»šåŠ¨åˆ†é¡µ</li>
<li><strong>å­˜å‚¨ä¼˜åŒ–</strong>ï¼šåªå­˜å‚¨blogIdï¼Œä¸å­˜å‚¨å®Œæ•´å†…å®¹</li>
</ol>
<div class="note flat"><p>æ¨æ¨¡å¼é€‚åˆå¥½å‹å…³ç³»åœºæ™¯ï¼Œæ—¶æ•ˆæ€§å¥½ï¼Œå®ç°ç®€å•ã€‚å¯¹äºå¤§Vç”¨æˆ·ï¼Œå¯åç»­å‡çº§ä¸ºæ¨æ‹‰ç»“åˆæ¨¡å¼ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="9-4-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±">9.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</h3>
<div class="tabs" id="feed-push"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#feed-push-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#feed-push-2">æŠ€æœ¯æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#feed-push-3">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="feed-push-1"><p>å®ç°ç¬”è®°å‘å¸ƒæ—¶çš„ç²‰ä¸æ¨é€åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>è§¦å‘æ—¶æœº</strong>ï¼šç”¨æˆ·å‘å¸ƒæ¢åº—ç¬”è®°æ—¶</li>
<li><strong>æ¨é€å¯¹è±¡</strong>ï¼šç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸</li>
<li><strong>å­˜å‚¨è¦æ±‚</strong>ï¼šæŒ‰æ—¶é—´æˆ³æ’åºï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="feed-push-2"><p>ä½¿ç”¨Redis SortedSetä½œä¸ºç²‰ä¸æ”¶ä»¶ç®±ï¼š</p>
<ul>
<li><strong>Keyæ ¼å¼</strong>ï¼š<code>feed:{userId}</code> å­˜å‚¨ç”¨æˆ·çš„æ”¶ä»¶ç®±</li>
<li><strong>Valueæ ¼å¼</strong>ï¼š<code>ZSet&lt;blogId, timestamp&gt;</code></li>
<li><strong>æ¨é€é€»è¾‘</strong>ï¼šéå†æ‰€æœ‰ç²‰ä¸ï¼Œå†™å…¥å¯¹åº”æ”¶ä»¶ç®±</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="feed-push-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°åˆ°æ•°æ®åº“</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query()</span><br><span class="line">            .eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// 4.2.æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet()</span><br><span class="line">                .add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.è¿”å›ç¬”è®°id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>åŸå­æ€§</strong>ï¼šæ•°æ®åº“ä¿å­˜æˆåŠŸåæ‰è¿›è¡Œæ¨é€</li>
<li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼šéå†æ‰€æœ‰ç²‰ä¸ï¼Œé€ä¸ªå†™å…¥æ”¶ä»¶ç®±</li>
<li><strong>æ—¶é—´æˆ³</strong>ï¼šä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºscoreï¼Œä¿è¯æ—¶é—´æ’åº</li>
<li><strong>å¼‚å¸¸å¤„ç†</strong>ï¼šä»»ä¸€ç²‰ä¸æ¨é€å¤±è´¥ä¸å½±å“å…¶ä»–ç²‰ä¸</li>
</ol>
<div class="note flat"><p>æ¨æ¨¡å¼çš„å…³é”®æ˜¯æ•°æ®ä¸€è‡´æ€§ï¼Œç¡®ä¿æ•°æ®åº“ä¿å­˜æˆåŠŸåæ‰è¿›è¡ŒRedisæ¨é€ã€‚</p>
</div>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">// 4.2.æ¨é€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="9-5-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±">9.5 å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</h3>
<p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p>
<div class="tabs" id="feed-query"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#feed-query-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#feed-query-2">æŠ€æœ¯æ–¹æ¡ˆ</button></li><li class="tab"><button type="button" data-href="#feed-query-3">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="feed-query-1"><p>Feedæµåˆ†é¡µæŸ¥è¯¢é¢ä¸´ç‰¹æ®ŠæŒ‘æˆ˜ï¼š</p>
<ul>
<li><strong>æ•°æ®åŠ¨æ€æ€§</strong>ï¼šæ–°æ•°æ®ä¸æ–­æ’å…¥ï¼Œä¼ ç»Ÿåˆ†é¡µä¼šé‡å¤è¯»å–</li>
<li><strong>æ»šåŠ¨åˆ†é¡µ</strong>ï¼šåŸºäºæ—¶é—´æˆ³å’Œåç§»é‡å®ç°æ— é‡å¤åˆ†é¡µ</li>
<li><strong>æ€§èƒ½è¦æ±‚</strong>ï¼šéœ€è¦é«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢å’Œæ’åº</li>
</ul>
<p><strong>1 ä¼ ç»Ÿåˆ†é¡µ</strong></p>
<p>ä¼ ç»Ÿäº†åˆ†é¡µåœ¨feedæµæ˜¯ä¸é€‚ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–</p>
<p>å‡è®¾åœ¨t1 æ—¶åˆ»ï¼Œæˆ‘ä»¬å»è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page = 1 ï¼Œsize = 5 ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯10~6 è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾ç°åœ¨t2æ—¶å€™åˆå‘å¸ƒäº†ä¸€æ¡è®°å½•ï¼Œæ­¤æ—¶t3 æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œè¯»å–ç¬¬äºŒé¡µä¼ å…¥çš„å‚æ•°æ˜¯page=2 ï¼Œsize=5 ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–åˆ°çš„ç¬¬äºŒé¡µå®é™…ä¸Šæ˜¯ä»6 å¼€å§‹ï¼Œç„¶åæ˜¯6~2 ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»å–åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥feedæµçš„åˆ†é¡µï¼Œä¸èƒ½é‡‡ç”¨åŸå§‹æ–¹æ¡ˆæ¥åšã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653813047671.png" alt="1653813047671"></p>
<p><strong>2 Feedæµçš„æ»šåŠ¨åˆ†é¡µ</strong></p>
<p>æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹å»è¯»å–æ•°æ®</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†10~6ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡æ‹¿å–çš„è®°å½•ï¼Œå°±æ˜¯6ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çš„è®°å½•ï¼Œæ­¤æ—¶è¿™ä¸ª11æ”¾åˆ°æœ€é¡¶ä¸Šï¼Œä½†æ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰è®°å½•çš„6ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥æ‹¿ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¿™ä¸ªæ—¶å€™æ‹¿æ•°æ®ï¼Œè¿˜æ˜¯ä»6åä¸€ç‚¹çš„5å»æ‹¿ï¼Œå°±æ‹¿åˆ°äº†5-1çš„è®°å½•ã€‚æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹å¯ä»¥é‡‡ç”¨sortedSetæ¥åšï¼Œå¯ä»¥è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œå¹¶ä¸”è¿˜å¯ä»¥è®°å½•å½“å‰è·å–æ•°æ®æ—¶é—´æˆ³æœ€å°å€¼ï¼Œå°±å¯ä»¥å®ç°æ»šåŠ¨åˆ†é¡µäº†</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://markpic.adoreorg.cn/2025/09/Redis/1653813462834.png" alt="1653813462834"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="feed-query-2"><p>ä½¿ç”¨Redis SortedSetçš„æ»šåŠ¨åˆ†é¡µï¼š</p>
<ul>
<li><strong>æŸ¥è¯¢å‘½ä»¤</strong>ï¼š<code>ZREVRANGEBYSCORE key Max Min LIMIT offset count</code></li>
<li><strong>åˆ†é¡µå‚æ•°</strong>ï¼šmax(æœ€å¤§æ—¶é—´æˆ³)ã€offset(åç§»é‡)ã€count(æ¯é¡µæ•°é‡)</li>
<li><strong>è¿”å›æ•°æ®</strong>ï¼šblogIdåˆ—è¡¨ã€æœ€å°æ—¶é—´æˆ³ã€æ–°åç§»é‡</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="feed-query-3"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controllerå±‚</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, </span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max, offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serviceå±‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">        .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123;</span><br><span class="line">        <span class="comment">// 4.1.è·å–id</span></span><br><span class="line">        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class="line">        <span class="comment">// 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span>(time == minTime)&#123;</span><br><span class="line">            os++;  <span class="comment">// ç›¸åŒæ—¶é—´æˆ³ï¼Œåç§»é‡+1</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minTime = time;  <span class="comment">// æ›´æ–°æ—¶é—´æˆ³</span></span><br><span class="line">            os = <span class="number">1</span>;  <span class="comment">// é‡ç½®åç§»é‡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">// 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.å°è£…å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>æ»šåŠ¨åˆ†é¡µ</strong>ï¼šåŸºäºæ—¶é—´æˆ³å’Œåç§»é‡ï¼Œé¿å…é‡å¤æ•°æ®</li>
<li><strong>ZSetæŸ¥è¯¢</strong>ï¼š<code>reverseRangeByScoreWithScores</code> æ”¯æŒèŒƒå›´æŸ¥è¯¢</li>
<li><strong>åç§»é‡è®¡ç®—</strong>ï¼šå¤„ç†ç›¸åŒæ—¶é—´æˆ³çš„å¤šæ¡æ•°æ®</li>
<li><strong>æ•°æ®å®Œæ•´æ€§</strong>ï¼šæŸ¥è¯¢blogè¯¦æƒ…å’Œç‚¹èµçŠ¶æ€</li>
</ol>
<div class="note flat"><p>æ»šåŠ¨åˆ†é¡µçš„æ ¸å¿ƒæ˜¯è®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢ä»è¯¥ä½ç½®ç»§ç»­ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="10-é™„è¿‘å•†æˆ·">10. é™„è¿‘å•†æˆ·</h2>
<h3 id="10-1-GEOæ•°æ®ç»“æ„åŸºæœ¬ç”¨æ³•">10.1 GEOæ•°æ®ç»“æ„åŸºæœ¬ç”¨æ³•</h3>
<div class="tabs" id="geo-basic"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#geo-basic-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#geo-basic-2">åº”ç”¨åœºæ™¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="geo-basic-1"><p><strong>åŠŸèƒ½æ¦‚è¿°</strong>ï¼šå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†åæ ‡ä¿¡æ¯</p>
<p>Redis GEOï¼ˆåœ°ç†åæ ‡ï¼‰æ”¯æŒå­˜å‚¨å’ŒæŸ¥è¯¢åœ°ç†åæ ‡ä¿¡æ¯ï¼š</p>
<ul>
<li><strong>åæ ‡å­˜å‚¨</strong>ï¼šç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€æˆå‘˜(member)</li>
<li><strong>è·ç¦»è®¡ç®—</strong>ï¼šä¸¤ç‚¹é—´çš„çƒé¢è·ç¦» å•ä½ m-ç±³ï¼Œkm-åƒç±³ï¼Œmi-è‹±â¾¥ï¼Œft-è‹±å°º</li>
<li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼šåœ†å½¢æˆ–çŸ©å½¢èŒƒå›´å†…çš„æˆå‘˜</li>
<li><strong>æ’åºè¿”å›</strong>ï¼šæŒ‰è·ç¦»æ’åºæŸ¥è¯¢ç»“æœ</li>
</ul>
<p><strong>å¸¸ç”¨å‘½ä»¤</strong></p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GEOADD</code></td>
<td>æ·»åŠ åœ°ç†åæ ‡</td>
<td><code>GEOADD cities 116.405 39.905 beijing</code></td>
</tr>
<tr>
<td><code>GEODIST</code></td>
<td>è®¡ç®—ä¸¤ç‚¹è·ç¦»</td>
<td><code>GEODIST cities beijing shanghai km</code></td>
</tr>
<tr>
<td><code>GEOPOS</code></td>
<td>è·å–æˆå‘˜åæ ‡</td>
<td><code>GEOPOS cities beijing</code></td>
</tr>
<tr>
<td><code>GEOSEARCH</code></td>
<td>èŒƒå›´æœç´¢æ’åº</td>
<td><code>GEOSEARCH cities FROMLONLAT 116 39 BYRADIUS 10 km</code></td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="geo-basic-2"><p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>é™„è¿‘å•†æˆ·æœç´¢</strong>ï¼šæ ¹æ®ç”¨æˆ·å½“å‰ä½ç½®ï¼ŒæŸ¥è¯¢è·ç¦»æœ€è¿‘çš„å•†æˆ·</li>
<li><strong>åœ°ç†ä½ç½®æœåŠ¡</strong>ï¼šæä¾›åŸºäºä½ç½®çš„æœåŠ¡ï¼Œå¦‚åœ°å›¾å¯¼èˆªã€ä½ç½®æé†’</li>
<li><strong>è·ç¦»è®¡ç®—å’Œæ’åº</strong>ï¼šè®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œæ”¯æŒæŒ‰è·ç¦»æ’åºæŸ¥è¯¢ç»“æœ</li>
<li><strong>åŸºäºä½ç½®çš„å†…å®¹æ¨è</strong>ï¼šæ ¹æ®ç”¨æˆ·ä½ç½®æ¨èç›¸å…³å†…å®¹ï¼Œå¦‚æœ¬åœ°ç¾é£Ÿã€æ™¯ç‚¹ç­‰</li>
</ul>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>åæ ‡ç²¾åº¦</strong>ï¼šæ”¯æŒå°æ•°ç‚¹å6ä½ï¼Œçº¦10cmç²¾åº¦</li>
<li><strong>è·ç¦»å•ä½</strong>ï¼šæ”¯æŒmã€kmã€miã€ftç­‰å•ä½</li>
<li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼šæ”¯æŒåœ†å½¢å’ŒçŸ©å½¢ä¸¤ç§æŸ¥è¯¢æ–¹å¼</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šä½¿ç”¨geohashç¼–ç ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜</li>
</ol>
<div class="note flat"><p>Redis 6.2+ æ¨èä½¿ç”¨ <code>GEOSEARCH</code> å‘½ä»¤ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="10-2-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">10.2 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3>
<div class="tabs" id="geo-import"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#geo-import-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#geo-import-2">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="geo-import-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<p>å°†æ•°æ®åº“ä¸­çš„åº—é“ºä¿¡æ¯å¯¼å…¥Redis GEOï¼Œæ”¯æŒæŒ‰ç±»å‹åˆ†ç±»å­˜å‚¨ï¼š</p>
<ul>
<li><strong>æ•°æ®åˆ†ç»„</strong>ï¼šæŒ‰åº—é“ºç±»å‹åˆ†ç»„ï¼ŒåŒç±»åº—é“ºå­˜å‚¨åœ¨åŒä¸€keyä¸‹</li>
<li><strong>åæ ‡å­˜å‚¨</strong>ï¼šä½¿ç”¨åº—é“ºIDä½œä¸ºmemberï¼Œç»çº¬åº¦ä½œä¸ºåæ ‡</li>
<li><strong>æ‰¹é‡å¯¼å…¥</strong>ï¼šæé«˜å¯¼å…¥æ•ˆç‡ï¼Œå‡å°‘ç½‘ç»œå¼€é”€</li>
</ul>
<p><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong></p>
<p>ä½¿ç”¨Redis GEOADDå‘½ä»¤æ‰¹é‡å¯¼å…¥ï¼š</p>
<ul>
<li><strong>Keyæ ¼å¼</strong>ï¼š<code>shop:geo:{typeId}</code> æŒ‰åº—é“ºç±»å‹åˆ†ç»„</li>
<li><strong>Valueæ ¼å¼</strong>ï¼š<code>GeoLocation&lt;shopId, Point(x,y)&gt;</code></li>
<li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼š<code>opsForGeo().add(key, locations)</code> ä¸€æ¬¡æ€§å¯¼å…¥</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="geo-import-2"><p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; list = shopService.list();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream()</span><br><span class="line">        .collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// 3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; value = entry.getValue();</span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.3.æ„å»ºGeoLocationå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">for</span> (Shop shop : value) &#123;</span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(</span><br><span class="line">                shop.getId().toString(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.4.æ‰¹é‡å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>æ•°æ®åˆ†ç»„</strong>ï¼šæŒ‰typeIdåˆ†ç»„ï¼Œæ”¯æŒæŒ‰ç±»å‹ç­›é€‰</li>
<li><strong>æ‰¹é‡å¯¼å…¥</strong>ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæé«˜å¯¼å…¥æ•ˆç‡</li>
<li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šåªå­˜å‚¨shopIdï¼Œä¸å­˜å‚¨å®Œæ•´ä¿¡æ¯</li>
<li><strong>åæ ‡æ ¼å¼</strong>ï¼šä½¿ç”¨RedisGeoCommands.GeoLocationå°è£…</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="10-3-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">10.3 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3>
<div class="tabs" id="geo-search"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#geo-search-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#geo-search-2">ä»£ç å®ç°</button></li><li class="tab"><button type="button" data-href="#geo-search-3">å‘é€è¯·æ±‚</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="geo-search-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<p>å®ç°åŸºäºåœ°ç†ä½ç½®çš„å•†æˆ·æŸ¥è¯¢åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>åæ ‡æŸ¥è¯¢</strong>ï¼šæ ¹æ®ç”¨æˆ·å½“å‰ä½ç½®æŸ¥è¯¢é™„è¿‘å•†æˆ·</li>
<li><strong>è·ç¦»æ’åº</strong>ï¼šæŒ‰è·ç¦»ä»è¿‘åˆ°è¿œæ’åº</li>
<li><strong>åˆ†é¡µæ”¯æŒ</strong>ï¼šæ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§è¿”å›å¤§é‡æ•°æ®</li>
<li><strong>ç±»å‹ç­›é€‰</strong>ï¼šå¯æŒ‰å•†æˆ·ç±»å‹ç­›é€‰ç»“æœ</li>
</ul>
<p><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong></p>
<p>ä½¿ç”¨Redis GEOSEARCHå‘½ä»¤å®ç°ï¼š</p>
<ul>
<li><strong>æŸ¥è¯¢å‘½ä»¤</strong>ï¼š<code>GEOSEARCH key BYLONLAT x y BYRADIUS radius WITHDISTANCE</code></li>
<li><strong>åˆ†é¡µå¤„ç†</strong>ï¼šå…ˆæŸ¥è¯¢è¶³å¤Ÿæ•°æ®ï¼Œå†è¿›è¡Œå†…å­˜åˆ†é¡µ</li>
<li><strong>è·ç¦»è®¡ç®—</strong>ï¼šè‡ªåŠ¨è®¡ç®—å¹¶è¿”å›æ¯ä¸ªå•†æˆ·çš„è·ç¦»</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="geo-search-2"><p><strong>å¼•å…¥ä¾èµ–</strong><br>
<strong>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„pom.xmlæ–‡ä»¶</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;io.lettuce&lt;/groupId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.6</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.lettuce&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">6.1</span><span class="number">.6</span>.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controllerå±‚</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId, current, x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serviceå±‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">            .search(</span><br><span class="line">                    key,</span><br><span class="line">                    GeoReference.fromCoordinate(x, y),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>), <span class="comment">// 5kmèŒƒå›´å†…</span></span><br><span class="line">                    RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs()</span><br><span class="line">                            .includeDistance()</span><br><span class="line">                            .limit(end)</span><br><span class="line">            );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.è§£æå‡ºidå’Œè·ç¦»</span></span><br><span class="line">    <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="keyword">if</span> (list.size() &lt;= from) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span></span><br><span class="line">    List&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">    Map&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">    list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">        <span class="comment">// 4.2.è·å–åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">        ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">        <span class="comment">// 4.3.è·å–è·ç¦»</span></span><br><span class="line">        <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr, distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.æ ¹æ®idæŸ¥è¯¢Shopè¯¦æƒ…</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>åæ ‡åˆ¤æ–­</strong>ï¼šæ— åæ ‡æ—¶å›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢</li>
<li><strong>åˆ†é¡µè®¡ç®—</strong>ï¼šå†…å­˜åˆ†é¡µï¼Œé¿å…æ•°æ®åº“åˆ†é¡µçš„æ’åºé—®é¢˜</li>
<li><strong>èŒƒå›´æŸ¥è¯¢</strong>ï¼š5kmèŒƒå›´å†…æœç´¢ï¼Œé¿å…æ•°æ®é‡è¿‡å¤§</li>
<li><strong>è·ç¦»è®¾ç½®</strong>ï¼šè‡ªåŠ¨å°†è·ç¦»ä¿¡æ¯è®¾ç½®åˆ°åº—é“ºå¯¹è±¡ä¸­</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="geo-search-3"><p><strong>è¯·æ±‚ç½‘å€: <a target="_blank" rel="noopener" href="http://localhost:8080/api/shop/of/type?typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229">http://localhost:8080/api/shop/of/type?typeId=1&amp;current=1&amp;x=120.149993&amp;y=30.334229</a></strong><br>
<strong>è¯·æ±‚æ–¹æ³•: GET</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="11-ç”¨æˆ·ç­¾åˆ°">11. ç”¨æˆ·ç­¾åˆ°</h2>
<h3 id="11-1-BitMapåŠŸèƒ½æ¼”ç¤º">11.1 BitMapåŠŸèƒ½æ¼”ç¤º</h3>
<div class="tabs" id="bitmap-basic"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bitmap-basic-1">åŠŸèƒ½æ¦‚è¿°</button></li><li class="tab"><button type="button" data-href="#bitmap-basic-2">åº”ç”¨åœºæ™¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bitmap-basic-1"><p><strong>åŠŸèƒ½æ¦‚è¿°</strong></p>
<p>BitMapæ˜¯Redisä¸­åŸºäºStringç±»å‹å®ç°çš„ä½å›¾æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>å­˜å‚¨åŸç†</strong>ï¼šæ¯ä¸ªbitä½ä»£è¡¨ä¸€ä¸ªçŠ¶æ€ï¼Œ0è¡¨ç¤ºæœªç­¾åˆ°ï¼Œ1è¡¨ç¤ºå·²ç­¾åˆ°</li>
<li><strong>ç©ºé—´ä¼˜åŠ¿</strong>ï¼šç›¸æ¯”MySQLå­˜å‚¨ï¼Œå†…å­˜å ç”¨å‡å°‘99%ä»¥ä¸Š</li>
<li><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼šä½æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼ŒæŸ¥è¯¢æ•ˆç‡æé«˜</li>
</ul>
<p><strong>å¸¸ç”¨å‘½ä»¤</strong></p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>SETBIT</td>
<td>è®¾ç½®æŒ‡å®šä½ç½®çš„bitå€¼</td>
<td><code>SETBIT sign:1:202401 15 1</code></td>
</tr>
<tr>
<td>GETBIT</td>
<td>è·å–æŒ‡å®šä½ç½®çš„bitå€¼</td>
<td><code>GETBIT sign:1:202401 15</code></td>
</tr>
<tr>
<td>BITCOUNT</td>
<td>ç»Ÿè®¡1çš„ä¸ªæ•°</td>
<td><code>BITCOUNT sign:1:202401</code></td>
</tr>
<tr>
<td>BITFIELD</td>
<td>æ‰¹é‡æ“ä½œbitä½</td>
<td><code>BITFIELD sign:1:202401 GET u31 0</code></td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bitmap-basic-2"><p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>ç”¨æˆ·ç­¾åˆ°</strong>ï¼šæŒ‰æœˆå­˜å‚¨ç”¨æˆ·ç­¾åˆ°çŠ¶æ€</li>
<li><strong>æ´»è·ƒç”¨æˆ·ç»Ÿè®¡</strong>ï¼šç»Ÿè®¡æŸæ—¶é—´æ®µæ´»è·ƒç”¨æˆ·</li>
<li><strong>ç‰¹å¾æ ‡è®°</strong>ï¼šæ ‡è®°ç”¨æˆ·æ˜¯å¦å…·æœ‰æŸç§ç‰¹å¾</li>
<li><strong>å¸ƒéš†è¿‡æ»¤å™¨</strong>ï¼šå¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</li>
</ul>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>å­˜å‚¨ä¸Šé™</strong>ï¼šæœ€å¤§æ”¯æŒ512MBï¼Œçº¦43äº¿ä¸ªbitä½</li>
<li><strong>æ—¶é—´æ•ˆç‡</strong>ï¼šä½æ“ä½œéƒ½æ˜¯O(1)æ—¶é—´å¤æ‚åº¦</li>
<li><strong>ç©ºé—´æ•ˆç‡</strong>ï¼š1äº¿ç”¨æˆ·10æ¬¡ç­¾åˆ°ä»…éœ€12MBå†…å­˜</li>
<li><strong>æ•°æ®æ ¼å¼</strong>ï¼šæŒ‰å¹´+æœˆåˆ†ç»„å­˜å‚¨ï¼Œä¾¿äºç»Ÿè®¡</li>
</ol>
<div class="note info simple"><p>BitMapé€‚åˆå­˜å‚¨å¤§é‡å¸ƒå°”å€¼çŠ¶æ€ï¼Œå†…å­˜å ç”¨æå°ï¼ŒæŸ¥è¯¢æ•ˆç‡æé«˜ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="11-2-å®ç°ç­¾åˆ°åŠŸèƒ½">11.2 å®ç°ç­¾åˆ°åŠŸèƒ½</h3>
<div class="tabs" id="sign-save"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sign-save-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#sign-save-2">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sign-save-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<p>å®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½ï¼Œå°†å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­ï¼š</p>
<ul>
<li><strong>ç­¾åˆ°è®°å½•</strong>ï¼šè®°å½•ç”¨æˆ·æ¯å¤©çš„ç­¾åˆ°çŠ¶æ€</li>
<li><strong>çŠ¶æ€å­˜å‚¨</strong>ï¼šä½¿ç”¨BitMapå­˜å‚¨ï¼Œ0è¡¨ç¤ºæœªç­¾åˆ°ï¼Œ1è¡¨ç¤ºå·²ç­¾åˆ°</li>
<li><strong>æ—¶é—´ç»´åº¦</strong>ï¼šæŒ‰æœˆç»´åº¦å­˜å‚¨ï¼Œä¾¿äºç»Ÿè®¡å’ŒæŸ¥è¯¢</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šåŒä¸€å¤©å¤šæ¬¡ç­¾åˆ°åªè®°å½•ä¸€æ¬¡</li>
</ul>
<p><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong></p>
<p>ä½¿ç”¨Redis BitMapå®ç°ç­¾åˆ°å­˜å‚¨ï¼š</p>
<ul>
<li><strong>Keyæ ¼å¼</strong>ï¼š<code>sign:userId:yyyyMM</code></li>
<li><strong>Bitä½ç½®</strong>ï¼šç”¨æœˆä»½ä¸­çš„ç¬¬å‡ å¤©ä½œä¸ºoffsetï¼ˆ0-30ï¼‰</li>
<li><strong>å‘½ä»¤é€‰æ‹©</strong>ï¼šä½¿ç”¨SETBITå‘½ä»¤è®¾ç½®ç­¾åˆ°çŠ¶æ€</li>
<li><strong>æ—¶é—´è·å–</strong>ï¼šé€šè¿‡åå°ä»£ç è·å–å½“å‰æ—¥æœŸ</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sign-save-2"><p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controllerå±‚</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/sign&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userService.sign();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serviceå±‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–å½“å‰æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥keyï¼šsign:userId:yyyyMM</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©ï¼ˆ1-31ï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redisï¼šSETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>Keyè®¾è®¡</strong>ï¼šæŒ‰ç”¨æˆ·å’Œæœˆä»½ç»´åº¦å­˜å‚¨ï¼Œä¾¿äºæŸ¥è¯¢å’Œç»Ÿè®¡</li>
<li><strong>Offsetè®¡ç®—</strong>ï¼šä½¿ç”¨æœˆä»½ä¸­çš„ç¬¬å‡ å¤©å‡1ä½œä¸ºbitä½åç§»</li>
<li><strong>å¹‚ç­‰æ€§ä¿è¯</strong>ï¼šSETBITå‘½ä»¤å¤©ç„¶å¹‚ç­‰ï¼Œé‡å¤ç­¾åˆ°æ— å½±å“</li>
<li><strong>æ—¶é—´å¤„ç†</strong>ï¼šé€šè¿‡LocalDateTimeè·å–å‡†ç¡®çš„æ—¥æœŸä¿¡æ¯</li>
</ol>
<div class="note success simple"><p>BitMapçš„SETBITå‘½ä»¤å¤©ç„¶å¹‚ç­‰ï¼ŒåŒä¸€å¤©å¤šæ¬¡ç­¾åˆ°ä¸ä¼šäº§ç”Ÿé‡å¤è®°å½•ã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="11-3-ç­¾åˆ°ç»Ÿè®¡">11.3 ç­¾åˆ°ç»Ÿè®¡</h3>
<div class="tabs" id="sign-count"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#sign-count-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#sign-count-2">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="sign-count-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<p>ç»Ÿè®¡ç”¨æˆ·æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°ï¼š</p>
<ul>
<li><strong>è¿ç»­ç­¾åˆ°å®šä¹‰</strong>ï¼šä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢</li>
<li><strong>ç»Ÿè®¡èŒƒå›´</strong>ï¼šæœ¬æœˆç¬¬ä¸€å¤©åˆ°å½“å‰æ—¥æœŸ</li>
<li><strong>è¿”å›ç»“æœ</strong>ï¼šè¿ç»­ç­¾åˆ°å¤©æ•°</li>
<li><strong>ç®—æ³•æ€è·¯</strong>ï¼šä»åå‘å‰éå†bitä½ï¼Œé‡åˆ°0åœæ­¢</li>
</ul>
<p><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong></p>
<p>ä½¿ç”¨BITFIELDå‘½ä»¤è·å–æœ¬æœˆç­¾åˆ°æ•°æ®ï¼š</p>
<ul>
<li><strong>å‘½ä»¤æ ¼å¼</strong>ï¼š<code>BITFIELD key GET u[dayOfMonth] 0</code></li>
<li><strong>æ•°æ®å¤„ç†</strong>ï¼šè·å–æœ¬æœˆæ‰€æœ‰ç­¾åˆ°è®°å½•ï¼Œè¿”å›åè¿›åˆ¶æ•°å­—</li>
<li><strong>ä½è¿ç®—</strong>ï¼šé€šè¿‡ä¸1è¿›è¡Œä¸è¿ç®—ï¼Œé€ä¸ªæ£€æŸ¥bitä½</li>
<li><strong>éå†é€»è¾‘</strong>ï¼šä»åå‘å‰éå†ï¼Œé‡åˆ°0åœæ­¢è®¡æ•°</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="sign-count-2"><p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Controllerå±‚</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/sign/count&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.signCount();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Serviceå±‚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">signCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–å½“å‰æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥keyï¼šsign:userId:yyyyMM</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°è®°å½•</span></span><br><span class="line">    <span class="comment">// BITFIELD sign:1:202401 GET u31 0</span></span><br><span class="line">    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key,</span><br><span class="line">            BitFieldSubCommands.create()</span><br><span class="line">                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="literal">null</span> || num == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.å¾ªç¯éå†ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½</span></span><br><span class="line">        <span class="keyword">if</span> ((num &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸç»Ÿè®¡</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>è¿ç»­ç­¾åˆ°å®šä¹‰</strong>ï¼šä»æœ€åä¸€æ¬¡ç­¾åˆ°å‘å‰ç»Ÿè®¡ï¼Œé‡åˆ°0åœæ­¢</li>
<li><strong>BITFIELDä½¿ç”¨</strong>ï¼šä¸€æ¬¡æ€§è·å–æœ¬æœˆæ‰€æœ‰ç­¾åˆ°æ•°æ®</li>
<li><strong>ä½è¿ç®—æŠ€å·§</strong>ï¼šé€šè¿‡ä¸1è¿›è¡Œä¸è¿ç®—åˆ¤æ–­æœ€ä½ä½æ˜¯å¦ä¸º1</li>
<li><strong>éå†æ–¹å‘</strong>ï¼šä»åå‘å‰éå†ï¼Œç¬¦åˆè¿ç»­ç­¾åˆ°å®šä¹‰</li>
</ol>
<div class="note info simple"><p>ä½¿ç”¨æ— ç¬¦å·å³ç§»ï¼ˆ&gt;&gt;&gt;&quot;)ç¡®ä¿é«˜ä½è¡¥0ï¼Œé¿å…è´Ÿæ•°å½±å“ç»Ÿè®¡ç»“æœã€‚</p>
</div><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="11-4-BitMapè§£å†³ç¼“å­˜ç©¿é€">11.4 BitMapè§£å†³ç¼“å­˜ç©¿é€</h3>
<div class="tabs" id="bitmap-bloom"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#bitmap-bloom-1">éœ€æ±‚åˆ†æ</button></li><li class="tab"><button type="button" data-href="#bitmap-bloom-2">ä»£ç å®ç°</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="bitmap-bloom-1"><p><strong>éœ€æ±‚åˆ†æ</strong></p>
<p>ä½¿ç”¨BitMapè§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼š</p>
<ul>
<li><strong>ç¼“å­˜ç©¿é€</strong>ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç»•è¿‡ç¼“å­˜ç›´è¾¾æ•°æ®åº“</li>
<li><strong>ä¼ ç»Ÿæ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨listå­˜å‚¨æ‰€æœ‰æœ‰æ•ˆidï¼Œå†…å­˜å ç”¨å¤§</li>
<li><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨BitMapä½œä¸ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¿«é€Ÿåˆ¤æ–­idæ˜¯å¦å­˜åœ¨</li>
<li><strong>è¯¯å·®æ§åˆ¶</strong>ï¼šé€šè¿‡å“ˆå¸Œç®—æ³•é™ä½å†²çªæ¦‚ç‡</li>
</ul>
<p><strong>æŠ€æœ¯æ–¹æ¡ˆ</strong></p>
<p>åŸºäºBitMapå®ç°å¸ƒéš†è¿‡æ»¤å™¨ï¼š</p>
<ul>
<li><strong>å“ˆå¸Œç®—æ³•</strong>ï¼šid % bitmap_sizeï¼Œç¡®å®šbitä½ç½®</li>
<li><strong>å­˜å‚¨æ–¹å¼</strong>ï¼šå°†æ•°æ®åº“ä¸­æ‰€æœ‰æœ‰æ•ˆidå¯¹åº”çš„bitä½ç½®ä¸º1</li>
<li><strong>æŸ¥è¯¢é€»è¾‘</strong>ï¼šç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œç”¨ç›¸åŒç®—æ³•è®¡ç®—bitä½ï¼Œä¸º0åˆ™ä¸€å®šä¸å­˜åœ¨</li>
<li><strong>è¯¯å·®å¤„ç†</strong>ï¼šå“ˆå¸Œå†²çªå¯èƒ½å¯¼è‡´è¯¯åˆ¤ï¼Œä½†æ¦‚ç‡å¯æ§</li>
</ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="bitmap-bloom-2"><p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBloomFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–æ•°æ®åº“ä¸­æ‰€æœ‰æœ‰æ•ˆid</span></span><br><span class="line">    List&lt;Long&gt; validIds = getAllValidIdsFromDB();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.è®¡ç®—bitmapå¤§å°ï¼ˆæ ¹æ®æ•°æ®é‡å’ŒæœŸæœ›è¯¯å·®ç‡ï¼‰</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">bitmapSize</span> <span class="operator">=</span> calculateOptimalSize(validIds.size(), <span class="number">0.01</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.å°†æ¯ä¸ªidæ˜ å°„åˆ°bitä½å¹¶è®¾ç½®</span></span><br><span class="line">    <span class="keyword">for</span> (Long id : validIds) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bitIndex</span> <span class="operator">=</span> (<span class="type">int</span>) (id % bitmapSize);</span><br><span class="line">        stringRedisTemplate.opsForValue().setBit(<span class="string">&quot;bloom:filter&quot;</span>, bitIndex, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢æ—¶åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">mightExist</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">bitmapSize</span> <span class="operator">=</span> getBitmapSize(); <span class="comment">// è·å–ä¹‹å‰è®¡ç®—çš„size</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">bitIndex</span> <span class="operator">=</span> (<span class="type">int</span>) (id % bitmapSize);</span><br><span class="line">    <span class="keyword">return</span> stringRedisTemplate.opsForValue().getBit(<span class="string">&quot;bloom:filter&quot;</span>, bitIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šç›¸æ¯”å­˜å‚¨å®Œæ•´idåˆ—è¡¨ï¼Œå†…å­˜å ç”¨å‡å°‘99%ä»¥ä¸Š</li>
<li><strong>æŸ¥è¯¢æ•ˆç‡</strong>ï¼šä½æ“ä½œæ—¶é—´å¤æ‚åº¦O(1)ï¼ŒæŸ¥è¯¢æå¿«</li>
<li><strong>è¯¯å·®æ§åˆ¶</strong>ï¼šé€šè¿‡åˆç†è®¾ç½®bitmapå¤§å°ï¼Œå¯å°†è¯¯å·®ç‡æ§åˆ¶åœ¨1%ä»¥å†…</li>
<li><strong>æ•°æ®æ›´æ–°</strong>ï¼šæ•°æ®åº“æ–°å¢/åˆ é™¤æ•°æ®æ—¶éœ€è¦åŒæ­¥æ›´æ–°bitmap</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="12-UVç»Ÿè®¡">12. UVç»Ÿè®¡</h2>
<h3 id="12-1-HyperLogLogåŸç†">12.1 HyperLogLogåŸç†</h3>
<div class="tabs" id="hyperloglog-basic"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#hyperloglog-basic-1">æ¦‚å¿µå®šä¹‰</button></li><li class="tab"><button type="button" data-href="#hyperloglog-basic-2">åº”ç”¨åœºæ™¯</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="hyperloglog-basic-1"><p><strong>æ¦‚å¿µå®šä¹‰</strong></p>
<ul>
<li><strong>UVï¼ˆUnique Visitorï¼‰</strong>ï¼šç‹¬ç«‹è®¿å®¢é‡ï¼ŒåŒä¸€ç”¨æˆ·å¤šæ¬¡è®¿é—®åªè®¡1æ¬¡</li>
<li><strong>PVï¼ˆPage Viewï¼‰</strong>ï¼šé¡µé¢è®¿é—®é‡ï¼Œæ¯æ¬¡è®¿é—®éƒ½è®¡æ•°</li>
<li><strong>ç»Ÿè®¡æŒ‘æˆ˜</strong>ï¼šUVéœ€è¦å»é‡ï¼Œä¼ ç»ŸSetå­˜å‚¨æ–¹å¼å†…å­˜æ¶ˆè€—å·¨å¤§</li>
</ul>
<p><strong>HyperLogLogåŸç†</strong></p>
<div class='liushen-tag-link'><a class="tag-Link" target="_blank" href=" https://juejin.cn/post/6844903785744056333#heading-0">
    <div class="tag-link-tips">ğŸª§å¼•ç”¨ç«™å¤–åœ°å€ï¼Œä¸ä¿è¯ç«™ç‚¹çš„å¯ç”¨æ€§å’Œå®‰å…¨æ€§</div>
    <div class="tag-link-bottom">
        <div class="tag-link-left" style="background-image: url(https://source.adoreorg.cn/webp/icon/66a4632bbf06e.webp);"></div>
        <div class="tag-link-right">
            <div class="tag-link-title">HyperLogLogåŸç†</div>
            <div class="tag-link-sitename"> https://source.adoreorg.cn/webp/icon/66a4632bbf06e.webp</div>
        </div>
        <i class="fa-solid fa-angle-right"></i>
    </div>
    </a></div>
<p>HyperLogLogæ˜¯åŸºäºæ¦‚ç‡ç®—æ³•çš„åŸºæ•°ç»Ÿè®¡æ–¹æ¡ˆï¼š</p>
<ul>
<li><strong>å†…å­˜å ç”¨</strong>ï¼šå•ä¸ªHLLç»“æ„å°äº16KBï¼Œä¸æ•°æ®é‡æ— å…³</li>
<li><strong>è¯¯å·®èŒƒå›´</strong>ï¼šæ ‡å‡†è¯¯å·®å°äº0.81%ï¼Œå¯¹UVç»Ÿè®¡å¯æ¥å—</li>
<li><strong>åº•å±‚å®ç°</strong>ï¼šåŸºäºStringç»“æ„ï¼Œä½¿ç”¨ä½è¿ç®—å’Œå“ˆå¸Œç®—æ³•</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤§æ•°æ®é‡å»é‡ç»Ÿè®¡ï¼Œå¦‚UVã€DAUç­‰</li>
</ul>
<p><strong>Rediså‘½ä»¤</strong></p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>PFADD</td>
<td>æ·»åŠ å…ƒç´ </td>
<td><code>PFADD uv:202401 user1 user2</code></td>
</tr>
<tr>
<td>PFCOUNT</td>
<td>ç»Ÿè®¡åŸºæ•°</td>
<td><code>PFCOUNT uv:202401</code></td>
</tr>
<tr>
<td>PFMERGE</td>
<td>åˆå¹¶å¤šä¸ªHLL</td>
<td><code>PFMERGE uv:total uv:202401 uv:202402</code></td>
</tr>
</tbody>
</table><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="hyperloglog-basic-2"><p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>ç½‘ç«™UVç»Ÿè®¡</strong>ï¼šç»Ÿè®¡æ¯æ—¥/æœˆç‹¬ç«‹è®¿å®¢</li>
<li><strong>APPæ—¥æ´»ç»Ÿè®¡</strong>ï¼šç»Ÿè®¡æ¯æ—¥æ´»è·ƒç”¨æˆ·</li>
<li><strong>å¹¿å‘Šç‚¹å‡»ç»Ÿè®¡</strong>ï¼šç»Ÿè®¡ç‹¬ç«‹ç‚¹å‡»ç”¨æˆ·æ•°</li>
<li><strong>ç”¨æˆ·è¡Œä¸ºåˆ†æ</strong>ï¼šç»Ÿè®¡å‚ä¸ç‰¹å®šæ´»åŠ¨çš„ç”¨æˆ·æ•°</li>
</ul>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>å†…å­˜ä¼˜åŠ¿</strong>ï¼šç›¸æ¯”Setå­˜å‚¨ï¼Œå†…å­˜èŠ‚çœ99%ä»¥ä¸Š</li>
<li><strong>è¯¯å·®å¯æ§</strong>ï¼š0.81%è¯¯å·®å¯¹å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯æ¥å—</li>
<li><strong>åˆå¹¶æ”¯æŒ</strong>ï¼šæ”¯æŒå¤šæ—¶é—´æ®µæ•°æ®åˆå¹¶ç»Ÿè®¡</li>
<li><strong>æ€§èƒ½é«˜æ•ˆ</strong>ï¼šæ·»åŠ å’ŒæŸ¥è¯¢æ“ä½œéƒ½æ˜¯O(1)å¤æ‚åº¦</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="12-2-ç™¾ä¸‡çº§æ•°æ®ç»Ÿè®¡æµ‹è¯•">12.2 ç™¾ä¸‡çº§æ•°æ®ç»Ÿè®¡æµ‹è¯•</h3>
<div class="tabs" id="hyperloglog-test"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#hyperloglog-test-1">æµ‹è¯•ç›®æ ‡</button></li><li class="tab"><button type="button" data-href="#hyperloglog-test-2">æµ‹è¯•ç»“æœ</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="hyperloglog-test-1"><p><strong>æµ‹è¯•ç›®æ ‡</strong></p>
<p>éªŒè¯HyperLogLogåœ¨ç™¾ä¸‡çº§æ•°æ®ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼š</p>
<ul>
<li><strong>å†…å­˜å ç”¨</strong>ï¼šç»Ÿè®¡100ä¸‡æ¡æ•°æ®çš„å†…å­˜æ¶ˆè€—</li>
<li><strong>ç»Ÿè®¡ç²¾åº¦</strong>ï¼šè¯¯å·®æ˜¯å¦åœ¨0.81%èŒƒå›´å†…</li>
<li><strong>æ€§èƒ½è¡¨ç°</strong>ï¼šæ·»åŠ å’ŒæŸ¥è¯¢æ“ä½œçš„è€—æ—¶</li>
<li><strong>å¯¹æ¯”æµ‹è¯•</strong>ï¼šä¸Setç»“æ„è¿›è¡Œå†…å­˜å’Œæ€§èƒ½å¯¹æ¯”</li>
</ul>
<p><strong>æµ‹è¯•æ–¹æ¡ˆ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆå§‹åŒ–HyperLogLog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;test:uv:&quot;</span> + System.currentTimeMillis();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.æ·»åŠ 100ä¸‡æ¡æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">1_000_000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; total; i++) &#123;</span><br><span class="line">        stringRedisTemplate.opsForHyperLogLog().add(key, <span class="string">&quot;user&quot;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.ç»Ÿè®¡åŸºæ•°</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(key);</span><br><span class="line">    System.out.println(<span class="string">&quot;å®é™…æ•°æ®é‡ï¼š&quot;</span> + total);</span><br><span class="line">    System.out.println(<span class="string">&quot;ç»Ÿè®¡ç»“æœï¼š&quot;</span> + count);</span><br><span class="line">    System.out.println(<span class="string">&quot;è¯¯å·®ç‡ï¼š&quot;</span> + Math.abs(count - total) * <span class="number">100.0</span> / total + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.å†…å­˜å ç”¨ä¼°ç®—</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">memory</span> <span class="operator">=</span> getMemoryUsage(key);</span><br><span class="line">    System.out.println(<span class="string">&quot;å†…å­˜å ç”¨ï¼š&quot;</span> + memory + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="hyperloglog-test-2"><p><strong>æµ‹è¯•ç»“æœ</strong></p>
<p>ç»è¿‡æµ‹è¯•å‘ç°ï¼š</p>
<ul>
<li><strong>å†…å­˜å ç”¨</strong>ï¼šçº¦12KBï¼Œè¿œä½äºSetç»“æ„çš„å‡ åMB</li>
<li><strong>ç»Ÿè®¡ç²¾åº¦</strong>ï¼šè¯¯å·®åœ¨0.5%å·¦å³ï¼Œä¼˜äºå®˜æ–¹æ ‡ç§°çš„0.81%</li>
<li><strong>æ€§èƒ½è¡¨ç°</strong>ï¼š100ä¸‡æ¡æ•°æ®æ·»åŠ è€—æ—¶çº¦2ç§’</li>
<li><strong>ç©ºé—´æ•ˆç‡</strong>ï¼šç›¸æ¯”Setç»“æ„ï¼Œå†…å­˜èŠ‚çœ99%ä»¥ä¸Š</li>
</ul>
<p><strong>æ€§èƒ½å¯¹æ¯”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| æ•°æ®ç»“æ„ | å†…å­˜å ç”¨ | ç»Ÿè®¡ç²¾åº¦ | é€‚ç”¨åœºæ™¯ |</span><br><span class="line">|---------|----------|----------|----------|</span><br><span class="line">| Set | å‡ åMB | 100% | å°æ•°æ®é‡ç²¾ç¡®ç»Ÿè®¡ |</span><br><span class="line">| HyperLogLog | 12KB | 99.2% | å¤§æ•°æ®é‡è¿‘ä¼¼ç»Ÿè®¡ |</span><br></pre></td></tr></table></figure>
<p><strong>å…³é”®ç‚¹åˆ†æ</strong></p>
<ol>
<li><strong>å†…å­˜æ•ˆç‡</strong>ï¼šç™¾ä¸‡çº§æ•°æ®ä»…éœ€12KBå†…å­˜ï¼Œæå…¶é«˜æ•ˆ</li>
<li><strong>ç»Ÿè®¡ç²¾åº¦</strong>ï¼šå®é™…è¯¯å·®é€šå¸¸å°äºç†è®ºå€¼ï¼Œè¡¨ç°ä¼˜ç§€</li>
<li><strong>æ€§èƒ½ç¨³å®š</strong>ï¼šæ•°æ®é‡å¢åŠ ä¸ä¼šæ˜¾è‘—å½±å“æ€§èƒ½</li>
<li><strong>ç”Ÿäº§é€‚ç”¨</strong>ï¼šå®Œå…¨æ»¡è¶³ç”Ÿäº§ç¯å¢ƒçš„UVç»Ÿè®¡éœ€æ±‚</li>
</ol><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Rediså®æˆ˜ç¯‡</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://blog.adoreorg.cn/posts/2345j34g.html">https://blog.adoreorg.cn/posts/2345j34g.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>adoreğŸŠ</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2025-08-19</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2025-08-19</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BC%93%E5%AD%98/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>ç¼“å­˜</a><a class="post-meta__tags" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>é«˜æ€§èƒ½</a><a class="post-meta__tags" href="/tags/Redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Redis</a><a class="post-meta__tags" href="/tags/NoSQL/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>NoSQL</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>åˆ†å¸ƒå¼</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/adoreorange/pic_bed@main/QRcode/wechatPay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/adoreorange/pic_bed@main/QRcode/wechatPay.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/adoreorange/pic_bed@main/QRcode/aPay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/adoreorange/pic_bed@main/QRcode/aPay.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/58a94673.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/51.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Rediså…¥é—¨æŒ‡å—ï¼šä»å®‰è£…åˆ°å®æˆ˜åº”ç”¨</div></div></a></div><div class="next-post pull-right"><a href="/posts/2013454d.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/34.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/58a94673.html" title="Rediså…¥é—¨æŒ‡å—ï¼šä»å®‰è£…åˆ°å®æˆ˜åº”ç”¨"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/51.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-19</div><div class="title">Rediså…¥é—¨æŒ‡å—ï¼šä»å®‰è£…åˆ°å®æˆ˜åº”ç”¨</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%AE%9E%E6%88%98%E5%AF%BC%E8%AF%BB"><span class="toc-text">0. å®æˆ˜å¯¼è¯»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1. çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-text">1.1ã€é¡¹ç›®æ¶æ„åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">1.1.1 ç³»ç»Ÿæ¶æ„å›¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E8%A7%A3%E6%9E%90"><span class="toc-text">1.1.2 æ¶æ„è®¾è®¡è§£æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-%E9%A1%B9%E7%9B%AE%E5%AF%BC%E5%85%A5%E6%AD%A5%E9%AA%A4"><span class="toc-text">1.1.3 é¡¹ç›®å¯¼å…¥æ­¥éª¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">1.2 ç™»å½•æµç¨‹è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">1.2.1 ç™»å½•æµç¨‹å›¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E8%AF%A6%E7%BB%86%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="toc-text">1.2.2 è¯¦ç»†æµç¨‹è§£æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.3 æ ¸å¿ƒä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-%E9%A1%B5%E9%9D%A2%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B"><span class="toc-text">1.3.1 é¡µé¢äº¤äº’æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD"><span class="toc-text">1.3.2 å‘é€éªŒè¯ç åŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-text">1.3.3 ç”¨æˆ·ç™»å½•åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA%E5%99%A8%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.4 ç™»å½•æ‹¦æˆªå™¨å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-Tomcat%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-text">1.4.1 Tomcatè¿è¡ŒåŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-ThreadLocal%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB"><span class="toc-text">1.4.2 ThreadLocalçº¿ç¨‹éš”ç¦»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">1.4.3 ç™»å½•æ‹¦æˆªå™¨ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-4-%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">1.4.4 æ‹¦æˆªå™¨é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%A4%84%E7%90%86"><span class="toc-text">1.5 ç”¨æˆ·ä¿¡æ¯å®‰å…¨å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7"><span class="toc-text">1.5.1 æ•æ„Ÿä¿¡æ¯éšè—çš„å¿…è¦æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9AUserDTO%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"><span class="toc-text">1.5.2 è§£å†³æ–¹æ¡ˆï¼šUserDTOæ•°æ®ä¼ è¾“å¯¹è±¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3-%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-text">1.5.3 ä»£ç ä¿®æ”¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-4-%E5%AE%89%E5%85%A8%E6%95%88%E6%9E%9C%E5%AF%B9%E6%AF%94"><span class="toc-text">1.5.4 å®‰å…¨æ•ˆæœå¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-Session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-text">1.6 Sessionå…±äº«é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1-%E5%88%86%E5%B8%83%E5%BC%8FSession%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">1.6.1 åˆ†å¸ƒå¼Sessioné—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-2-Redis%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">1.6.2 Redisè§£å†³æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-Redis%E4%BB%A3%E6%9B%BFSession%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.7 Redisä»£æ›¿Sessionçš„ä¸šåŠ¡æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%80%89%E6%8B%A9"><span class="toc-text">1.7.1 Redisæ•°æ®ç»“æ„é€‰æ‹©</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-2-Key%E8%AE%BE%E8%AE%A1%E7%AD%96%E7%95%A5"><span class="toc-text">1.7.2 Keyè®¾è®¡ç­–ç•¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-3-%E6%95%B4%E4%BD%93%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-text">1.7.3 æ•´ä½“è®¿é—®æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1.8 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%E5%9B%9E%E9%A1%BE"><span class="toc-text">1.8.1 å®ç°æ€è·¯å›é¡¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8-2-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.8.2 æ ¸å¿ƒä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E5%88%B7%E6%96%B0%E4%BC%98%E5%8C%96"><span class="toc-text">1.9 ç™»å½•çŠ¶æ€åˆ·æ–°ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-1-%E5%88%9D%E5%A7%8B%E6%96%B9%E6%A1%88%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">1.9.1 åˆå§‹æ–¹æ¡ˆé—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-2-%E5%8F%8C%E6%8B%A6%E6%88%AA%E5%99%A8%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">1.9.2 åŒæ‹¦æˆªå™¨ä¼˜åŒ–æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.9.3 ä»£ç å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-text">2. å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%BC%93%E5%AD%98%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">2.1 ç¼“å­˜åŸºç¡€æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98%EF%BC%9F"><span class="toc-text">2.1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E7%BC%93%E5%AD%98%E7%9A%84%E6%8A%80%E6%9C%AF%E5%AE%9A%E4%B9%89"><span class="toc-text">2.1.2 ç¼“å­˜çš„æŠ€æœ¯å®šä¹‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F"><span class="toc-text">2.1.3 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%EF%BC%9F"><span class="toc-text">2.1.4 å¦‚ä½•ä½¿ç”¨ç¼“å­˜ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%95%86%E6%88%B7%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.2 å•†æˆ·ç¼“å­˜å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc-text">2.2.1 ä¸šåŠ¡åœºæ™¯åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">2.2.2 ç¼“å­˜æ¶æ„è®¾è®¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.2.3 ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E6%A6%82%E8%BF%B0"><span class="toc-text">2.3.1 ç¼“å­˜æ›´æ–°ç­–ç•¥æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">2.3.2 æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9"><span class="toc-text">2.3.3 æœ€ä½³å®è·µæ–¹æ¡ˆé€‰æ‹©</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%95%86%E6%88%B7%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.4 å•†æˆ·ç¼“å­˜åŒå†™ä¸€è‡´æ€§å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">2.4.1 å®ç°æ€è·¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.4.2 ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">2.5 ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">2.5.1 ç¼“å­˜ç©¿é€é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-text">2.5.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.6 ç¼“å­˜ç©¿é€ç¼–ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">2.6.1 å®ç°æ€è·¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.6.2 ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-3-%E6%80%BB%E7%BB%93%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">2.6.3 æ€»ç»“ä¸æœ€ä½³å®è·µ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">2.7 ç¼“å­˜é›ªå´©é—®é¢˜è§£å†³</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">2.7.1 ç¼“å­˜é›ªå´©é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-text">2.7.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-3-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%A1%88"><span class="toc-text">2.7.3 æœ€ä½³å®è·µæ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">2.8 ç¼“å­˜å‡»ç©¿é—®é¢˜è§£å†³</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">2.8.1 ç¼“å­˜å‡»ç©¿é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-2-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-text">2.8.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-3-%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="toc-text">2.8.3 æ–¹æ¡ˆé€‰æ‹©å»ºè®®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E4%BA%92%E6%96%A5%E9%94%81%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.9 äº’æ–¥é”æ–¹æ¡ˆå®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">2.9.1 å®ç°æ€è·¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.9.2 ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-3-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">2.9.3 æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.10 é€»è¾‘è¿‡æœŸæ–¹æ¡ˆå®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-1-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">2.10.1 å®ç°æ€è·¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.10.2 ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-10-3-%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">2.10.3 æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-Redis%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%B0%81%E8%A3%85"><span class="toc-text">2.11 Rediså·¥å…·ç±»å°è£…</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">2.11.1 éœ€æ±‚åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.11.2 ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-3-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.11.3 ä½¿ç”¨ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-11-4-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93"><span class="toc-text">2.11.4 æœ€ä½³å®è·µæ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80"><span class="toc-text">3. ä¼˜æƒ åˆ¸ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-redis%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">3.1 rediså®ç°å…¨å±€å”¯ä¸€ID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90"><span class="toc-text">3.1.1 å…¨å±€å”¯ä¸€IDç”Ÿæˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-Redis%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">3.1.2 Rediså®ç°æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="toc-text">3.1.3 æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%BC%98%E6%83%A0%E5%88%B8%E7%AE%A1%E7%90%86"><span class="toc-text">3.2 ä¼˜æƒ åˆ¸ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E4%BC%98%E6%83%A0%E5%88%B8%E7%B1%BB%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">3.2.1 ä¼˜æƒ åˆ¸ç±»å‹è®¾è®¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-%E4%BC%98%E6%83%A0%E5%88%B8%E5%8F%91%E5%B8%83%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.2.2 ä¼˜æƒ åˆ¸å‘å¸ƒå®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.3 ç§’æ€ä¸‹å•å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">3.3.1 ä¸šåŠ¡éœ€æ±‚åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E5%9F%BA%E7%A1%80%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">3.3.2 åŸºç¡€å®ç°æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">3.4 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E9%97%AE%E9%A2%98"><span class="toc-text">3.5 ä¸€äººä¸€å•é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-text">3.6 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4. åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%A6%82%E8%BF%B0"><span class="toc-text">4.1 åˆ†å¸ƒå¼é”æ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2 Redisåˆ†å¸ƒå¼é”å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%BC%94%E8%BF%9B"><span class="toc-text">4.3 åˆ†å¸ƒå¼é”æ¼”è¿›</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-Lua%E8%84%9A%E6%9C%AC%E8%AF%A6%E8%A7%A3"><span class="toc-text">4.4 Luaè„šæœ¬è¯¦è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%80%BB%E7%BB%93"><span class="toc-text">4.5 åˆ†å¸ƒå¼é”æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission"><span class="toc-text">5. åˆ†å¸ƒå¼é”-redission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Redisson%E6%A6%82%E8%BF%B0"><span class="toc-text">5.1 Redissonæ¦‚è¿°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Redisson%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">5.2 Redissonå¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%A6%E8%A7%A3"><span class="toc-text">5.3 Redissonåˆ†å¸ƒå¼é”è¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Redisson%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">5.3.1 Redissonå¯é‡å…¥é”åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-Redisson%E9%94%81%E9%87%8D%E8%AF%95%E5%92%8CWatchDog%E6%9C%BA%E5%88%B6"><span class="toc-text">5.3.2 Redissoné”é‡è¯•å’ŒWatchDogæœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-Redisson-MultiLock%E5%8E%9F%E7%90%86"><span class="toc-text">5.3.3 Redisson MultiLockåŸç†</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6. ç§’æ€ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">6.1 å¼‚æ­¥ç§’æ€æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Redis%E5%AE%8C%E6%88%90%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC%E5%88%A4%E6%96%AD"><span class="toc-text">6.2 Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6.3 åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7. Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9F%BA%E7%A1%80"><span class="toc-text">7.1.1 æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2-%E5%9F%BA%E4%BA%8EList%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.1.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-3-%E5%9F%BA%E4%BA%8EPubSub%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.1.3 åŸºäºPubSubå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-4-%E5%9F%BA%E4%BA%8EStream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.1.4 åŸºäºStreamå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-5-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="toc-text">7.1.5 æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-text">8. è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E4%B8%8E%E7%AC%94%E8%AE%B0%E5%8F%91%E5%B8%83"><span class="toc-text">8.1 å›¾ç‰‡ä¸Šä¼ ä¸ç¬”è®°å‘å¸ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">8.2 æŸ¥çœ‹æ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">8.3 ç‚¹èµåŠŸèƒ½ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">8.4 ç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-text">9. å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">9.1 å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">9.2 å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">9.3 Feedæµå®ç°æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E6%8E%A8%E9%80%81%E5%88%B0%E7%B2%89%E4%B8%9D%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">9.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">9.5 å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7"><span class="toc-text">10. é™„è¿‘å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">10.1 GEOæ•°æ®ç»“æ„åŸºæœ¬ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">10.2 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">10.3 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-text">11. ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA"><span class="toc-text">11.1 BitMapåŠŸèƒ½æ¼”ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">11.2 å®ç°ç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">11.3 ç­¾åˆ°ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-BitMap%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-text">11.4 BitMapè§£å†³ç¼“å­˜ç©¿é€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-UV%E7%BB%9F%E8%AE%A1"><span class="toc-text">12. UVç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-HyperLogLog%E5%8E%9F%E7%90%86"><span class="toc-text">12.1 HyperLogLogåŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E7%99%BE%E4%B8%87%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E6%B5%8B%E8%AF%95"><span class="toc-text">12.2 ç™¾ä¸‡çº§æ•°æ®ç»Ÿè®¡æµ‹è¯•</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-first"></div><div id="footer-wrap"><div class="global-footer"><div class="footer-container"><section class="footer-section motto-container"><h3 class="section-heading">ğŸ“œ ç”Ÿæ´»ç®´è¨€</h3><p class="motto-content">å²æœˆä¸å±…ï¼Œæ—¶èŠ‚å¦‚æµã€‚æ„¿ä½ æˆ‘éƒ½èƒ½åœ¨æ—¶å…‰çš„é•¿æ²³é‡Œï¼Œé‡‡æ’·å±äºè‡ªå·±çš„æ˜Ÿå…‰ã€‚å±±é«˜è·¯è¿œï¼Œä½†è§é£å…‰æ— é™ï¼›æ°´æ³¢æ½‹æ»Ÿï¼Œè‡ªæœ‰è¯—æ„ä¸‡åƒã€‚</p><a class="nav-item" target="_blank" rel="noopener" href="https://stellarium.org/">æ¢ç´¢æ˜Ÿç©ºä¹‹æ—… â†’</a></section><section class="footer-section nav-container"><h3 class="section-heading">ğŸ—ºï¸ ç½‘ç«™åœ°å›¾</h3><nav class="nav-grid"><a class="nav-item" href="/" data-pjax-state="">è¿”å›ä¸»é¡µ</a><a class="nav-item" href="/box/nav/" data-pjax-state="">ç½‘å€å¯¼èˆª</a><a class="nav-item" href="/social/link/" data-pjax-state="">æˆ‘çš„æœ‹å‹</a><a class="nav-item" href="/comments/" data-pjax-state="">ç•™ç‚¹ä»€ä¹ˆ</a><a class="nav-item" href="/personal/about/" data-pjax-state="">å…³äºä½œè€…</a><a class="nav-item" href="/archives/" data-pjax-state="">æ–‡ç« å½’æ¡£</a><a class="nav-item" href="/categories/" data-pjax-state="">æ–‡ç« åˆ†ç±»</a><a class="nav-item" href="/tags/" data-pjax-state="">æ–‡ç« æ ‡ç­¾</a><a class="nav-item" href="/box/gallery/" data-pjax-state="">æˆ‘çš„ç”»å»Š</a><a class="nav-item" href="/personal/bb/" data-pjax-state="">æ—¥å¸¸åˆ†äº«</a><a class="nav-item" href="/site/time/" data-pjax-state="">å»ºè®¾è¿›ç¨‹</a><a class="nav-item" href="/site/census/" data-pjax-state="">ç½‘ç«™ç»Ÿè®¡</a></nav></section><section class="footer-section partner-container"><h3 class="section-heading">âŒ› å‹æƒ…é“¾æ¥</h3><div class="partner-grid"><a class="partner-link" target="_blank" rel="noopener" href="https://blog.adoreorg.cn/" title="adoreğŸŠ"><img class="partner-image" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/svg/adore.webp" alt="adoreğŸŠ" width="50" height="50"/></a><a class="partner-link" target="_blank" rel="noopener" href="https://miraii.cn/" title="MuXiaoChenğŸŠ" data-pjax-state=""><img class="partner-image" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/svg/miraii.webp" alt="MuXiaoChenğŸŠ" width="50" height="50"/></a><a class="partner-link" target="_blank" rel="noopener" href="https://formal.cc/" title="Formal.cc" data-pjax-state=""><img class="partner-image" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/svg/formal.webp" alt="Formal.cc" width="50" height="50"/></a><a class="partner-link" target="_blank" rel="noopener" href="https://butterfly.js.org/" title="butterflyä¸»é¢˜"><img class="partner-image" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/svg/butterfly.webp" alt="butterflyä¸»é¢˜" width="50" height="50"/></a></div></section></div></div></div><div id="footer-wrap-bottom"><div id="footer-bottom"><div class="footer-bottom-content"><div class="footer-bottom-left"><span class="copyright"><i class="fa-regular fa-copyright" style="margin-right:5px;margin-top:2px"></i>2023-2025 By adoreğŸŠ</span><div><a class="footer-bottom-link" target="_blank" href="https://beian.miit.gov.cn/" rel="noopener external nofollow" title="å·¥ä¿¡éƒ¨å¤‡æ¡ˆå·">xxx-xxxx</a><a class="footer-bottom-link" target="_blank" href="https://foreverblog.cn/go.html" rel="noopener" title="åå¹´ä¹‹çº¦ï½œForeverBlog">åå¹´ä¹‹çº¦Â·æ¼«æ­¥æ˜Ÿé™…</a></div></div><div class="footer-bottom-right"><div id="workboard"><div style="font-size:17px">æœ¬ç«™å±…ç„¶è¿è¡Œäº† <span id="days">660</span>å¤© <span id="hours">18</span>å°æ—¶ <span id="minutes">25</span>åˆ† <span id="seconds">10</span>ç§’<i class="fas fa-heartbeat" id="heartbeat"></i></div></div><div><a class="footer-bottom-link" target="_blank" href="https://www.aliyun.com/" rel="noopener external nofollow" title="æœ¬ç«™é€šè¿‡é˜¿é‡Œäº‘ESAæä¾›ç«™ç‚¹åŠ é€Ÿä¸ä¿æŠ¤">é˜¿é‡Œäº‘ESA</a><a class="footer-bottom-link" target="_blank" href="https://hexo.io/zh-cn/" rel="noopener external nofollow" title="æœ¬ç«™ä½¿ç”¨Hexoæ¶æ„æ­å»ºè€Œæˆ">Hexoé™æ€æ¡†æ¶</a><a class="footer-bottom-link" target="_blank" href="https://butterfly.js.org/" rel="noopener external nofollow" title="æœ¬ç«™ç”±Butterflyä¸»é¢˜é­”æ”¹è€Œæˆ">Butterflyä¸»é¢˜</a></div></div></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js"></script><script src="https://cdn.staticfile.org/algoliasearch/4.14.3/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.staticfile.org/instantsearch.js/4.49.2/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://adoreorg-twikoo.hf.space/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, {"requiredFields":["nick","mail"],"placeholder":"ğŸ’¡ å¤´åƒæ˜¾ç¤ºè¯´æ˜ï¼š\n1. æ˜µç§°æ ¼å¼ï¼šQQ+ä½ çš„QQå·ç ï¼ˆå¦‚ï¼šQQ123456789ï¼‰\n2. ç³»ç»Ÿä¼šè‡ªåŠ¨è·å–ä½ çš„QQå¤´åƒå’Œæ˜µç§°\n3. ä½¿ç”¨QQé‚®ç®±å¯è·å¾—æ›´å¥½ä½“éªŒ\n4. åšå®¢ç•™è¨€è¦æ±‚å¡«å†™æ˜µç§°å’Œé‚®ç®±\n5. ä¸Šä¼ å›¾ç‰‡ä¸å¯è¶…è¿‡5MB\n6. è¯·ä¿æŒæ­£èƒ½é‡è¯„è®º\n","maxNick":20,"maxMail":50,"maxLink":100,"maxComment":500,"pageSize":10,"lang":"zh-CN"}))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://adoreorg-twikoo.hf.space/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.44/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script><script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_5000507_3sp3darv5dd.js"></script><script async src="//at.alicdn.com/t/c/font_5000507_5o87ef4hv.js"></script><script async src="//at.alicdn.com/t/c/font_5000507_1i0ng4q1gxa.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script async defer src="/js/fomal.js"></script><script async data-pjax src="/js/txmap.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script><script async src="/js/fcircle.js"></script><script async src="/js/bibi.js" no-pjax></script><script async src="/js/music.js"></script><script async src="/js/bibistore.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://npm.elemecdn.com/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://blog.adoreorg.cn/categories/ç¬”è€•é—®é“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŠ å¹•æ©™ã®ç¬”è€•é—®é“ (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://blog.adoreorg.cn/categories/å¢¨é¦™å®æˆ˜/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‡ å¹•æ©™ã®å¢¨é¦™å®æˆ˜ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://blog.adoreorg.cn/categories/å­¦æµ·æ‹¾è´/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“ å¹•æ©™ã®å­¦æµ·æ‹¾è´ (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://blog.adoreorg.cn/categories/ä¹¦å±±æŒ‡è·¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‘ å¹•æ©™ã®ä¹¦å±±æŒ‡è·¯ (8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://blog.adoreorg.cn/categories/æ¸¸å¿ƒé›…å™/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‹ å¹•æ©™ã®æ¸¸å¿ƒé›…å™ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://blog.adoreorg.cn/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/3f8a2b91.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/27.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-25</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/3f8a2b91.html&quot;);" href="javascript:void(0);" alt="">æ´¾æ´å¯Ÿ - èŠå¤©åŠ©æ‰‹è®¾è®¡æ¨¡å—</a><div class="blog-slider__text">ç§‘ç ”æ–‡çŒ®æ™ºèƒ½ RAG çŸ¥è¯†åº“ç³»ç»ŸèŠå¤©åŠ©æ‰‹è®¾è®¡æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/3f8a2b91.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/f99b1fcd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/13.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/f99b1fcd.html&quot;);" href="javascript:void(0);" alt="">æ´¾æ´å¯Ÿ - ç®¡ç†å‘˜æ¨¡å—</a><div class="blog-slider__text">ç§‘ç ”æ–‡çŒ®æ™ºèƒ½ RAG çŸ¥è¯†åº“ç³»ç»Ÿç®¡ç†å‘˜æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/f99b1fcd.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/f5e509b1.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/24.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/f5e509b1.html&quot;);" href="javascript:void(0);" alt="">æ´¾æ´å¯Ÿ - çŸ¥è¯†åº“æ£€ç´¢æ¨¡å—</a><div class="blog-slider__text">ç§‘ç ”æ–‡çŒ®æ™ºèƒ½ RAG çŸ¥è¯†åº“ç³»ç»ŸçŸ¥è¯†åº“æ£€ç´¢æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/f5e509b1.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/9b55fe42.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/20.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/9b55fe42.html&quot;);" href="javascript:void(0);" alt="">æ´¾æ´å¯Ÿ - ç”¨æˆ·ç®¡ç†æ¨¡å—</a><div class="blog-slider__text">ç§‘ç ”æ–‡çŒ®æ™ºèƒ½ RAG çŸ¥è¯†åº“ç³»ç»Ÿç”¨æˆ·ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/9b55fe42.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/8c42ef91.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/11.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-07-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/8c42ef91.html&quot;);" href="javascript:void(0);" alt="">æ´¾æ´å¯Ÿ - æ–‡ä»¶ä¸Šä¼ æ¨¡å—</a><div class="blog-slider__text">ç§‘ç ”æ–‡çŒ®æ™ºèƒ½ RAG çŸ¥è¯†åº“ç³»ç»Ÿæ–‡ä»¶ä¸Šä¼ æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/8c42ef91.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ds34d27g.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ds34d27g.html&quot;);" href="javascript:void(0);" alt="">åŠ¨æ€è§„åˆ’ç®—æ³•è¯¦è§£ï¼šä»å…¥é—¨åˆ°ç²¾é€š</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ds34d27g.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b9255ce6.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/34.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b9255ce6.html&quot;);" href="javascript:void(0);" alt="">MySQLå…¨é¢æŒ‡å—ï¼šä»åŸºç¡€åˆ°æ€§èƒ½ä¼˜åŒ–</a><div class="blog-slider__text">å…¨é¢ä»‹ç»MySQLæ•°æ®åº“çš„æ ¸å¿ƒæ¦‚å¿µã€å®‰è£…é…ç½®ã€SQLè¯­æ³•ã€ç´¢å¼•ä¼˜åŒ–ã€äº‹åŠ¡å¤„ç†ä»¥åŠæ€§èƒ½è°ƒä¼˜æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ•ˆç¨³å®šçš„æ•°æ®åº“åº”ç”¨ã€‚</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b9255ce6.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/eb5gs334.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/4.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/eb5gs334.html&quot;);" href="javascript:void(0);" alt="">äºŒåˆ†æŸ¥æ‰¾ç®—æ³•åŠå˜ç§å½¢å¼è¯¦è§£</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/eb5gs334.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/3n43l21g.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/24.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/3n43l21g.html&quot;);" href="javascript:void(0);" alt="">å›æº¯ç®—æ³•è¯¦è§£ï¼šä»å…¥é—¨åˆ°ç²¾é€š</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/3n43l21g.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/eb6gs334.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/36.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/eb6gs334.html&quot;);" href="javascript:void(0);" alt="">ACMæ¨¡å¼Javaè¾“å…¥è¾“å‡ºå¤„ç†å®Œå…¨æŒ‡å—</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/eb6gs334.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/58a94673.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/51.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/58a94673.html&quot;);" href="javascript:void(0);" alt="">Rediså…¥é—¨æŒ‡å—ï¼šä»å®‰è£…åˆ°å®æˆ˜åº”ç”¨</a><div class="blog-slider__text">è¯¦ç»†ä»‹ç»Redisçš„åŸºæœ¬æ¦‚å¿µã€å®‰è£…é…ç½®ã€æ•°æ®ç±»å‹ã€å¸¸ç”¨å‘½ä»¤ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡è¿™ä¸ªå¼ºå¤§çš„å†…å­˜æ•°æ®åº“ã€‚</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/58a94673.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/sjdwe26k.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/10.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/sjdwe26k.html&quot;);" href="javascript:void(0);" alt="">å•è°ƒæ ˆä¸å•è°ƒé˜Ÿåˆ—ç®—æ³•è¯¦è§£</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/sjdwe26k.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ds43gf4l.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/32.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ds43gf4l.html&quot;);" href="javascript:void(0);" alt="">å›¾çš„æ·±åº¦ä¼˜å…ˆæœç´¢(DFS)ä¸å¹¿åº¦ä¼˜å…ˆæœç´¢(BFS)ç®—æ³•è¯¦è§£</a><div class="blog-slider__text">å†æ€ä¹ˆçœ‹æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæè¿°å®ƒçš„å•¦ï¼</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ds43gf4l.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2345j34g.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/58.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2345j34g.html&quot;);" href="javascript:void(0);" alt="">Rediså®æˆ˜ç¯‡</a><div class="blog-slider__text">è¯¦ç»†ä»‹ç»Redisçš„åŸºæœ¬æ¦‚å¿µã€å®‰è£…é…ç½®ã€æ•°æ®ç±»å‹ã€å¸¸ç”¨å‘½ä»¤ä»¥åŠå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡è¿™ä¸ªå¼ºå¤§çš„å†…å­˜æ•°æ®åº“ã€‚</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2345j34g.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://source.adoreorg.cn/webp/select/34.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '350ms');
    arr[i].setAttribute('data-wow-delay', '0');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>